0592e4771befd33ee5f767cb2f1ee1be
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.createTestCase = createTestCase;
exports.getTestCaseById = getTestCaseById;
exports.updateTestCase = updateTestCase;
exports.deleteTestCase = deleteTestCase;
exports.listTestCases = listTestCases;
exports.getTestCasesByFolderId = getTestCasesByFolderId;
exports.createTestCaseVersion = createTestCaseVersion;
exports.listTestCaseVersions = listTestCaseVersions;
const pgClient_1 = require("../../../infrastructure/database/pgClient");
async function createTestCase(tc) {
    await (0, pgClient_1.ensurePgConnected)();
    const pgClient = (0, pgClient_1.getPgClient)();
    if (!pgClient) {
        throw new Error('PostgreSQL 클라이언트가 초기화되지 않았습니다.');
    }
    // 새로운 구조에 맞게 매핑
    const result = await pgClient.query(`INSERT INTO testcases (title, prereq, steps, expected, priority, tags, status, created_by, folder_id, sort_order) 
         VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10) RETURNING *`, [
        tc.title,
        tc.prereq,
        JSON.stringify(tc.steps),
        tc.expected,
        tc.priority,
        tc.tags,
        tc.status,
        tc.createdBy,
        tc.folderId || null,
        tc.sortOrder || 0
    ]);
    return rowToTestCase(result.rows[0]);
}
async function getTestCaseById(id) {
    await (0, pgClient_1.ensurePgConnected)();
    const pgClient = (0, pgClient_1.getPgClient)();
    if (!pgClient) {
        throw new Error('PostgreSQL 클라이언트가 초기화되지 않았습니다.');
    }
    const result = await pgClient.query('SELECT * FROM testcases WHERE id = $1', [id]);
    if (result.rows.length === 0)
        return null;
    return rowToTestCase(result.rows[0]);
}
async function updateTestCase(id, patch) {
    await (0, pgClient_1.ensurePgConnected)();
    const pgClient = (0, pgClient_1.getPgClient)();
    if (!pgClient) {
        throw new Error('PostgreSQL 클라이언트가 초기화되지 않았습니다.');
    }
    const current = await getTestCaseById(id);
    if (!current)
        return null;
    const result = await pgClient.query(`UPDATE testcases SET title=$1, prereq=$2, steps=$3, expected=$4, priority=$5, tags=$6, status=$7, updated_at=NOW() WHERE id=$8 RETURNING *`, [
        patch.title ?? current.title,
        patch.prereq ?? current.prereq,
        JSON.stringify(patch.steps ?? current.steps),
        patch.expected ?? current.expected,
        patch.priority ?? current.priority,
        patch.tags ?? current.tags,
        patch.status ?? current.status,
        id
    ]);
    if (result.rows.length === 0)
        return null;
    return rowToTestCase(result.rows[0]);
}
async function deleteTestCase(id) {
    await (0, pgClient_1.ensurePgConnected)();
    const pgClient = (0, pgClient_1.getPgClient)();
    if (!pgClient) {
        throw new Error('PostgreSQL 클라이언트가 초기화되지 않았습니다.');
    }
    await pgClient.query('DELETE FROM testcase_versions WHERE testcase_id = $1', [id]);
    const result = await pgClient.query('DELETE FROM testcases WHERE id = $1', [id]);
    return (result.rowCount ?? 0) > 0;
}
async function listTestCases() {
    await (0, pgClient_1.ensurePgConnected)();
    const pgClient = (0, pgClient_1.getPgClient)();
    if (!pgClient) {
        throw new Error('PostgreSQL 클라이언트가 초기화되지 않았습니다.');
    }
    const result = await pgClient.query('SELECT * FROM testcases ORDER BY id DESC');
    return result.rows.map(rowToTestCase);
}
async function getTestCasesByFolderId(folderId) {
    await (0, pgClient_1.ensurePgConnected)();
    const pgClient = (0, pgClient_1.getPgClient)();
    if (!pgClient) {
        throw new Error('PostgreSQL 클라이언트가 초기화되지 않았습니다.');
    }
    const result = await pgClient.query('SELECT * FROM testcases WHERE folder_id = $1 ORDER BY sort_order, id', [folderId]);
    return result.rows.map(rowToTestCase);
}
async function createTestCaseVersion(tcVersion) {
    await (0, pgClient_1.ensurePgConnected)();
    const pgClient = (0, pgClient_1.getPgClient)();
    if (!pgClient) {
        throw new Error('PostgreSQL 클라이언트가 초기화되지 않았습니다.');
    }
    const result = await pgClient.query(`INSERT INTO testcase_versions (testcase_id, version, data, created_by) VALUES ($1, $2, $3, $4) RETURNING *`, [tcVersion.testcaseId, tcVersion.version, JSON.stringify(tcVersion.data), tcVersion.createdBy]);
    return rowToTestCaseVersion(result.rows[0]);
}
async function listTestCaseVersions(testcaseId) {
    await (0, pgClient_1.ensurePgConnected)();
    const pgClient = (0, pgClient_1.getPgClient)();
    if (!pgClient) {
        throw new Error('PostgreSQL 클라이언트가 초기화되지 않았습니다.');
    }
    const result = await pgClient.query('SELECT * FROM testcase_versions WHERE testcase_id = $1 ORDER BY version DESC', [testcaseId]);
    return result.rows.map(rowToTestCaseVersion);
}
function rowToTestCase(row) {
    // steps 필드 안전한 파싱
    let steps = [];
    if (row.steps) {
        try {
            // JSON 문자열인 경우
            if (typeof row.steps === 'string' && row.steps.startsWith('[')) {
                steps = JSON.parse(row.steps);
            }
            else {
                // 일반 텍스트인 경우 배열로 변환
                steps = [row.steps];
            }
        }
        catch (error) {
            // 파싱 실패 시 빈 배열로 설정
            steps = [];
        }
    }
    return {
        id: row.id,
        title: row.title,
        prereq: row.prereq,
        steps: steps,
        expected: row.expected,
        priority: row.priority,
        tags: row.tags,
        status: row.status,
        createdBy: row.created_by,
        createdAt: row.created_at,
        updatedAt: row.updated_at,
        folderId: row.folder_id,
        sortOrder: row.sort_order,
    };
}
function rowToTestCaseVersion(row) {
    let dataObj;
    if (typeof row.data === 'string') {
        dataObj = JSON.parse(row.data);
    }
    else {
        dataObj = row.data;
    }
    return {
        id: row.id,
        testcaseId: row.testcase_id,
        version: row.version,
        data: dataObj,
        createdAt: row.created_at,
        createdBy: row.created_by,
    };
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzLzNpLWExLTIwMjEtMDE3L0RvY3VtZW50cy9xdWVzdC9EZXNrdG9wL3F1ZXN0L3NyYy9tYWluL2FwcC9kb21haW5zL3Rlc3RjYXNlcy9yZXBvc2l0b3JpZXMvdGVzdENhc2VSZXBvc2l0b3J5LnRzIiwibWFwcGluZ3MiOiI7O0FBR0Esd0NBeUJDO0FBRUQsMENBU0M7QUFFRCx3Q0F1QkM7QUFFRCx3Q0FTQztBQUVELHNDQVFDO0FBRUQsd0RBUUM7QUFFRCxzREFXQztBQUVELG9EQVFDO0FBdEhELHdFQUEyRjtBQUdwRixLQUFLLFVBQVUsY0FBYyxDQUFDLEVBQW9EO0lBQ3JGLE1BQU0sSUFBQSw0QkFBaUIsR0FBRSxDQUFDO0lBQzFCLE1BQU0sUUFBUSxHQUFHLElBQUEsc0JBQVcsR0FBRSxDQUFDO0lBQy9CLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQztRQUNaLE1BQU0sSUFBSSxLQUFLLENBQUMsZ0NBQWdDLENBQUMsQ0FBQztJQUN0RCxDQUFDO0lBRUQsZ0JBQWdCO0lBQ2hCLE1BQU0sTUFBTSxHQUFHLE1BQU0sUUFBUSxDQUFDLEtBQUssQ0FDL0I7c0VBQzhELEVBQzlEO1FBQ0ksRUFBRSxDQUFDLEtBQUs7UUFDUixFQUFFLENBQUMsTUFBTTtRQUNULElBQUksQ0FBQyxTQUFTLENBQUMsRUFBRSxDQUFDLEtBQUssQ0FBQztRQUN4QixFQUFFLENBQUMsUUFBUTtRQUNYLEVBQUUsQ0FBQyxRQUFRO1FBQ1gsRUFBRSxDQUFDLElBQUk7UUFDUCxFQUFFLENBQUMsTUFBTTtRQUNULEVBQUUsQ0FBQyxTQUFTO1FBQ1osRUFBRSxDQUFDLFFBQVEsSUFBSSxJQUFJO1FBQ25CLEVBQUUsQ0FBQyxTQUFTLElBQUksQ0FBQztLQUNwQixDQUNKLENBQUM7SUFDRixPQUFPLGFBQWEsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFDekMsQ0FBQztBQUVNLEtBQUssVUFBVSxlQUFlLENBQUMsRUFBVTtJQUM1QyxNQUFNLElBQUEsNEJBQWlCLEdBQUUs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Q2xCLEtBQUssRUFBRSxLQUFLO1FBQ1osUUFBUSxFQUFFLEdBQUcsQ0FBQyxRQUFRO1FBQ3RCLFFBQVEsRUFBRSxHQUFHLENBQUMsUUFBUTtRQUN0QixJQUFJLEVBQUUsR0FBRyxDQUFDLElBQUk7UUFDZCxNQUFNLEVBQUUsR0FBRyxDQUFDLE1BQU07UUFDbEIsU0FBUyxFQUFFLEdBQUcsQ0FBQyxVQUFVO1FBQ3pCLFNBQVMsRUFBRSxHQUFHLENBQUMsVUFBVTtRQUN6QixTQUFTLEVBQUUsR0FBRyxDQUFDLFVBQVU7UUFDekIsUUFBUSxFQUFFLEdBQUcsQ0FBQyxTQUFTO1FBQ3ZCLFNBQVMsRUFBRSxHQUFHLENBQUMsVUFBVTtLQUM1QixDQUFDO0FBQ04sQ0FBQztBQUVELFNBQVMsb0JBQW9CLENBQUMsR0FBUTtJQUNsQyxJQUFJLE9BQU8sQ0FBQztJQUNaLElBQUksT0FBTyxHQUFHLENBQUMsSUFBSSxLQUFLLFFBQVEsRUFBRSxDQUFDO1FBQy9CLE9BQU8sR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUNuQyxDQUFDO1NBQU0sQ0FBQztRQUNKLE9BQU8sR0FBRyxHQUFHLENBQUMsSUFBSSxDQUFDO0lBQ3ZCLENBQUM7SUFDRCxPQUFPO1FBQ0gsRUFBRSxFQUFFLEdBQUcsQ0FBQyxFQUFFO1FBQ1YsVUFBVSxFQUFFLEdBQUcsQ0FBQyxXQUFXO1FBQzNCLE9BQU8sRUFBRSxHQUFHLENBQUMsT0FBTztRQUNwQixJQUFJLEVBQUUsT0FBTztRQUNiLFNBQVMsRUFBRSxHQUFHLENBQUMsVUFBVTtRQUN6QixTQUFTLEVBQUUsR0FBRyxDQUFDLFVBQVU7S0FDNUIsQ0FBQztBQUNOLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL1VzZXJzLzNpLWExLTIwMjEtMDE3L0RvY3VtZW50cy9xdWVzdC9EZXNrdG9wL3F1ZXN0L3NyYy9tYWluL2FwcC9kb21haW5zL3Rlc3RjYXNlcy9yZXBvc2l0b3JpZXMvdGVzdENhc2VSZXBvc2l0b3J5LnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGdldFBnQ2xpZW50LCBlbnN1cmVQZ0Nvbm5lY3RlZCB9IGZyb20gJy4uLy4uLy4uL2luZnJhc3RydWN0dXJlL2RhdGFiYXNlL3BnQ2xpZW50JztcbmltcG9ydCB7IFRlc3RDYXNlLCBUZXN0Q2FzZVZlcnNpb24gfSBmcm9tICcuLi90eXBlcyc7XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBjcmVhdGVUZXN0Q2FzZSh0YzogT21pdDxUZXN0Q2FzZSwgJ2lkJyB8ICdjcmVhdGVkQXQnIHwgJ3VwZGF0ZWRBdCc+KTogUHJvbWlzZTxUZXN0Q2FzZT4ge1xuICAgIGF3YWl0IGVuc3VyZVBnQ29ubmVjdGVkKCk7XG4gICAgY29uc3QgcGdDbGllbnQgPSBnZXRQZ0NsaWVudCgpO1xuICAgIGlmICghcGdDbGllbnQpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdQb3N0Z3JlU1FMIO2BtOudvOydtOyWuO2KuOqwgCDstIjquLDtmZTrkJjsp4Ag7JWK7JWY7Iq164uI64ukLicpO1xuICAgIH1cbiAgICBcbiAgICAvLyDsg4jroZzsmrQg6rWs7KGw7JeQIOunnuqyjCDrp6TtlZFcbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBwZ0NsaWVudC5xdWVyeShcbiAgICAgICAgYElOU0VSVCBJTlRPIHRlc3RjYXNlcyAodGl0bGUsIHByZXJlcSwgc3RlcHMsIGV4cGVjdGVkLCBwcmlvcml0eSwgdGFncywgc3RhdHVzLCBjcmVhdGVkX2J5LCBmb2xkZXJfaWQsIHNvcnRfb3JkZXIpIFxuICAgICAgICAgVkFMVUVTICgkMSwgJDIsICQzLCAkNCwgJDUsICQ2LCAkNywgJDgsICQ5LCAkMTApIFJFVFVSTklORyAqYCxcbiAgICAgICAgW1xuICAgICAgICAgICAgdGMudGl0bGUsIFxuICAgICAgICAgICAgdGMucHJlcmVxLCBcbiAgICAgICAgICAgIEpTT04uc3RyaW5naWZ5KHRjLnN0ZXBzKSwgXG4gICAgICAgICAgICB0Yy5leHBlY3RlZCwgXG4gICAgICAgICAgICB0Yy5wcmlvcml0eSwgXG4gICAgICAgICAgICB0Yy50YWdzLCBcbiAgICAgICAgICAgIHRjLnN0YXR1cywgXG4gICAgICAgICAgICB0Yy5jcmVhdGVkQnksXG4gICAgICAgICAgICB0Yy5mb2xkZXJJZCB8fCBudWxsLFxuICAgICAgICAgICAgdGMuc29ydE9yZGVyIHx8IDBcbiAgICAgICAgXVxuICAgICk7XG4gICAgcmV0dXJuIHJvd1RvVGVzdENhc2UocmVzdWx0LnJvd3NbMF0pO1xufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZ2V0VGVzdENhc2VCeUlkKGlkOiBudW1iZXIpOiBQcm9taXNlPFRlc3RDYXNlIHwgbnVsbD4ge1xuICAgIGF3YWl0IGVuc3VyZVBnQ29ubmVjdGVkKCk7XG4gICAgY29uc3QgcGdDbGllbnQgPSBnZXRQZ0NsaWVudCgpO1xuICAgIGlmICghcGdDbGllbnQpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdQb3N0Z3JlU1FMIO2BtOudvOydtOyWuO2KuOqwgCDstIjquLDtmZTrkJjsp4Ag7JWK7JWY7Iq164uI64ukLicpO1xuICAgIH1cbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBwZ0NsaWVudC5xdWVyeSgnU0VMRUNUICogRlJPTSB0ZXN0Y2FzZXMgV0hFUkUgaWQgPSAkMScsIFtpZF0pO1xuICAgIGlmIChyZXN1bHQucm93cy5sZW5ndGggPT09IDApIHJldHVybiBudWxsO1xuICAgIHJldHVybiByb3dUb1Rlc3RDYXNlKHJlc3VsdC5yb3dzWzBdKTtcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHVwZGF0ZVRlc3RDYXNlKGlkOiBudW1iZXIsIHBhdGNoOiBQYXJ0aWFsPFRlc3RDYXNlPik6IFByb21pc2U8VGVzdENhc2UgfCBudWxsPiB7XG4gICAgYXdhaXQgZW5zdXJlUGdDb25uZWN0ZWQoKTtcbiAgICBjb25zdCBwZ0NsaWVudCA9IGdldFBnQ2xpZW50KCk7XG4gICAgaWYgKCFwZ0NsaWVudCkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1Bvc3RncmVTUUwg7YG065287J207Ja47Yq46rCAIOy0iOq4sO2ZlOuQmOyngCDslYrslZjsirXri4jri6QuJyk7XG4gICAgfVxuICAgIGNvbnN0IGN1cnJlbnQgPSBhd2FpdCBnZXRUZXN0Q2FzZUJ5SWQoaWQpO1xuICAgIGlmICghY3VycmVudCkgcmV0dXJuIG51bGw7XG4gICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgcGdDbGllbnQucXVlcnkoXG4gICAgICAgIGBVUERBVEUgdGVzdGNhc2VzIFNFVCB0aXRsZT0kMSwgcHJlcmVxPSQyLCBzdGVwcz0kMywgZXhwZWN0ZWQ9JDQsIHByaW9yaXR5PSQ1LCB0YWdzPSQ2LCBzdGF0dXM9JDcsIHVwZGF0ZWRfYXQ9Tk9XKCkgV0hFUkUgaWQ9JDggUkVUVVJOSU5HICpgLFxuICAgICAgICBbXG4gICAgICAgICAgICBwYXRjaC50aXRsZSA/PyBjdXJyZW50LnRpdGxlLFxuICAgICAgICAgICAgcGF0Y2gucHJlcmVxID8/IGN1cnJlbnQucHJlcmVxLFxuICAgICAgICAgICAgSlNPTi5zdHJpbmdpZnkocGF0Y2guc3RlcHMgPz8gY3VycmVudC5zdGVwcyksXG4gICAgICAgICAgICBwYXRjaC5leHBlY3RlZCA/PyBjdXJyZW50LmV4cGVjdGVkLFxuICAgICAgICAgICAgcGF0Y2gucHJpb3JpdHkgPz8gY3VycmVudC5wcmlvcml0eSxcbiAgICAgICAgICAgIHBhdGNoLnRhZ3MgPz8gY3VycmVudC50YWdzLFxuICAgICAgICAgICAgcGF0Y2guc3RhdHVzID8/IGN1cnJlbnQuc3RhdHVzLFxuICAgICAgICAgICAgaWRcbiAgICAgICAgXVxuICAgICk7XG4gICAgaWYgKHJlc3VsdC5yb3dzLmxlbmd0aCA9PT0gMCkgcmV0dXJuIG51bGw7XG4gICAgcmV0dXJuIHJvd1RvVGVzdENhc2UocmVzdWx0LnJvd3NbMF0pO1xufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZGVsZXRlVGVzdENhc2UoaWQ6IG51bWJlcik6IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgIGF3YWl0IGVuc3VyZVBnQ29ubmVjdGVkKCk7XG4gICAgY29uc3QgcGdDbGllbnQgPSBnZXRQZ0NsaWVudCgpO1xuICAgIGlmICghcGdDbGllbnQpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdQb3N0Z3JlU1FMIO2BtOudvOydtOyWuO2KuOqwgCDstIjquLDtmZTrkJjsp4Ag7JWK7JWY7Iq164uI64ukLicpO1xuICAgIH1cbiAgICBhd2FpdCBwZ0NsaWVudC5xdWVyeSgnREVMRVRFIEZST00gdGVzdGNhc2VfdmVyc2lvbnMgV0hFUkUgdGVzdGNhc2VfaWQgPSAkMScsIFtpZF0pO1xuICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHBnQ2xpZW50LnF1ZXJ5KCdERUxFVEUgRlJPTSB0ZXN0Y2FzZXMgV0hFUkUgaWQgPSAkMScsIFtpZF0pO1xuICAgIHJldHVybiAocmVzdWx0LnJvd0NvdW50ID8/IDApID4gMDtcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGxpc3RUZXN0Q2FzZXMoKTogUHJvbWlzZTxUZXN0Q2FzZVtdPiB7XG4gICAgYXdhaXQgZW5zdXJlUGdDb25uZWN0ZWQoKTtcbiAgICBjb25zdCBwZ0NsaWVudCA9IGdldFBnQ2xpZW50KCk7XG4gICAgaWYgKCFwZ0NsaWVudCkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1Bvc3RncmVTUUwg7YG065287J207Ja47Yq46rCAIOy0iOq4sO2ZlOuQmOyngCDslYrslZjsirXri4jri6QuJyk7XG4gICAgfVxuICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHBnQ2xpZW50LnF1ZXJ5KCdTRUxFQ1QgKiBGUk9NIHRlc3RjYXNlcyBPUkRFUiBCWSBpZCBERVNDJyk7XG4gICAgcmV0dXJuIHJlc3VsdC5yb3dzLm1hcChyb3dUb1Rlc3RDYXNlKTtcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdldFRlc3RDYXNlc0J5Rm9sZGVySWQoZm9sZGVySWQ6IG51bWJlcik6IFByb21pc2U8VGVzdENhc2VbXT4ge1xuICAgIGF3YWl0IGVuc3VyZVBnQ29ubmVjdGVkKCk7XG4gICAgY29uc3QgcGdDbGllbnQgPSBnZXRQZ0NsaWVudCgpO1xuICAgIGlmICghcGdDbGllbnQpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdQb3N0Z3JlU1FMIO2BtOudvOydtOyWuO2KuOqwgCDstIjquLDtmZTrkJjsp4Ag7JWK7JWY7Iq164uI64ukLicpO1xuICAgIH1cbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBwZ0NsaWVudC5xdWVyeSgnU0VMRUNUICogRlJPTSB0ZXN0Y2FzZXMgV0hFUkUgZm9sZGVyX2lkID0gJDEgT1JERVIgQlkgc29ydF9vcmRlciwgaWQnLCBbZm9sZGVySWRdKTtcbiAgICByZXR1cm4gcmVzdWx0LnJvd3MubWFwKHJvd1RvVGVzdENhc2UpO1xufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gY3JlYXRlVGVzdENhc2VWZXJzaW9uKHRjVmVyc2lvbjogT21pdDxUZXN0Q2FzZVZlcnNpb24sICdpZCcgfCAnY3JlYXRlZEF0Jz4pOiBQcm9taXNlPFRlc3RDYXNlVmVyc2lvbj4ge1xuICAgIGF3YWl0IGVuc3VyZVBnQ29ubmVjdGVkKCk7XG4gICAgY29uc3QgcGdDbGllbnQgPSBnZXRQZ0NsaWVudCgpO1xuICAgIGlmICghcGdDbGllbnQpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdQb3N0Z3JlU1FMIO2BtOudvOydtOyWuO2KuOqwgCDstIjquLDtmZTrkJjsp4Ag7JWK7JWY7Iq164uI64ukLicpO1xuICAgIH1cbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBwZ0NsaWVudC5xdWVyeShcbiAgICAgICAgYElOU0VSVCBJTlRPIHRlc3RjYXNlX3ZlcnNpb25zICh0ZXN0Y2FzZV9pZCwgdmVyc2lvbiwgZGF0YSwgY3JlYXRlZF9ieSkgVkFMVUVTICgkMSwgJDIsICQzLCAkNCkgUkVUVVJOSU5HICpgLFxuICAgICAgICBbdGNWZXJzaW9uLnRlc3RjYXNlSWQsIHRjVmVyc2lvbi52ZXJzaW9uLCBKU09OLnN0cmluZ2lmeSh0Y1ZlcnNpb24uZGF0YSksIHRjVmVyc2lvbi5jcmVhdGVkQnldXG4gICAgKTtcbiAgICByZXR1cm4gcm93VG9UZXN0Q2FzZVZlcnNpb24ocmVzdWx0LnJvd3NbMF0pO1xufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gbGlzdFRlc3RDYXNlVmVyc2lvbnModGVzdGNhc2VJZDogbnVtYmVyKTogUHJvbWlzZTxUZXN0Q2FzZVZlcnNpb25bXT4ge1xuICAgIGF3YWl0IGVuc3VyZVBnQ29ubmVjdGVkKCk7XG4gICAgY29uc3QgcGdDbGllbnQgPSBnZXRQZ0NsaWVudCgpO1xuICAgIGlmICghcGdDbGllbnQpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdQb3N0Z3JlU1FMIO2BtOudvOydtOyWuO2KuOqwgCDstIjquLDtmZTrkJjsp4Ag7JWK7JWY7Iq164uI64ukLicpO1xuICAgIH1cbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBwZ0NsaWVudC5xdWVyeSgnU0VMRUNUICogRlJPTSB0ZXN0Y2FzZV92ZXJzaW9ucyBXSEVSRSB0ZXN0Y2FzZV9pZCA9ICQxIE9SREVSIEJZIHZlcnNpb24gREVTQycsIFt0ZXN0Y2FzZUlkXSk7XG4gICAgcmV0dXJuIHJlc3VsdC5yb3dzLm1hcChyb3dUb1Rlc3RDYXNlVmVyc2lvbik7XG59XG5cbmZ1bmN0aW9uIHJvd1RvVGVzdENhc2Uocm93OiBhbnkpOiBUZXN0Q2FzZSB7XG4gICAgLy8gc3RlcHMg7ZWE65OcIOyViOyghO2VnCDtjIzsi7FcbiAgICBsZXQgc3RlcHM6IHN0cmluZ1tdID0gW107XG4gICAgaWYgKHJvdy5zdGVwcykge1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgLy8gSlNPTiDrrLjsnpDsl7Tsnbgg6rK97JqwXG4gICAgICAgICAgICBpZiAodHlwZW9mIHJvdy5zdGVwcyA9PT0gJ3N0cmluZycgJiYgcm93LnN0ZXBzLnN0YXJ0c1dpdGgoJ1snKSkge1xuICAgICAgICAgICAgICAgIHN0ZXBzID0gSlNPTi5wYXJzZShyb3cuc3RlcHMpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAvLyDsnbzrsJgg7YWN7Iqk7Yq47J24IOqyveyasCDrsLDsl7TroZwg67OA7ZmYXG4gICAgICAgICAgICAgICAgc3RlcHMgPSBbcm93LnN0ZXBzXTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgIC8vIO2MjOyLsSDsi6TtjKgg7IucIOu5iCDrsLDsl7TroZwg7ISk7KCVXG4gICAgICAgICAgICBzdGVwcyA9IFtdO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIHtcbiAgICAgICAgaWQ6IHJvdy5pZCxcbiAgICAgICAgdGl0bGU6IHJvdy50aXRsZSxcbiAgICAgICAgcHJlcmVxOiByb3cucHJlcmVxLFxuICAgICAgICBzdGVwczogc3RlcHMsXG4gICAgICAgIGV4cGVjdGVkOiByb3cuZXhwZWN0ZWQsXG4gICAgICAgIHByaW9yaXR5OiByb3cucHJpb3JpdHksXG4gICAgICAgIHRhZ3M6IHJvdy50YWdzLFxuICAgICAgICBzdGF0dXM6IHJvdy5zdGF0dXMsXG4gICAgICAgIGNyZWF0ZWRCeTogcm93LmNyZWF0ZWRfYnksXG4gICAgICAgIGNyZWF0ZWRBdDogcm93LmNyZWF0ZWRfYXQsXG4gICAgICAgIHVwZGF0ZWRBdDogcm93LnVwZGF0ZWRfYXQsXG4gICAgICAgIGZvbGRlcklkOiByb3cuZm9sZGVyX2lkLFxuICAgICAgICBzb3J0T3JkZXI6IHJvdy5zb3J0X29yZGVyLFxuICAgIH07XG59XG5cbmZ1bmN0aW9uIHJvd1RvVGVzdENhc2VWZXJzaW9uKHJvdzogYW55KTogVGVzdENhc2VWZXJzaW9uIHtcbiAgICBsZXQgZGF0YU9iajtcbiAgICBpZiAodHlwZW9mIHJvdy5kYXRhID09PSAnc3RyaW5nJykge1xuICAgICAgICBkYXRhT2JqID0gSlNPTi5wYXJzZShyb3cuZGF0YSk7XG4gICAgfSBlbHNlIHtcbiAgICAgICAgZGF0YU9iaiA9IHJvdy5kYXRhO1xuICAgIH1cbiAgICByZXR1cm4ge1xuICAgICAgICBpZDogcm93LmlkLFxuICAgICAgICB0ZXN0Y2FzZUlkOiByb3cudGVzdGNhc2VfaWQsXG4gICAgICAgIHZlcnNpb246IHJvdy52ZXJzaW9uLFxuICAgICAgICBkYXRhOiBkYXRhT2JqLFxuICAgICAgICBjcmVhdGVkQXQ6IHJvdy5jcmVhdGVkX2F0LFxuICAgICAgICBjcmVhdGVkQnk6IHJvdy5jcmVhdGVkX2J5LFxuICAgIH07XG59ICJdLCJ2ZXJzaW9uIjozfQ==