a4896b7998893d1075f5ba33f5943d76
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.createFolder = createFolder;
exports.updateFolder = updateFolder;
exports.moveFolder = moveFolder;
exports.moveFolderBatch = moveFolderBatch;
exports.deleteFolder = deleteFolder;
exports.getFolderTree = getFolderTree;
exports.getFolderById = getFolderById;
exports.listFoldersByProject = listFoldersByProject;
const folderRepository_1 = require("../repositories/folderRepository");
// 간격법을 위한 유틸리티 함수
function calculateOrderIndex(prevIndex, nextIndex) {
    if (prevIndex === null && nextIndex === null)
        return 100;
    if (prevIndex === null)
        return nextIndex - 100;
    if (nextIndex === null)
        return prevIndex + 100;
    if (nextIndex - prevIndex > 1)
        return Math.floor((prevIndex + nextIndex) / 2);
    else
        return triggerReindex(prevIndex, nextIndex);
}
function triggerReindex(prevIndex, nextIndex) {
    // 실제로는 서버에서 전체 재간격을 수행
    return Math.floor((prevIndex + nextIndex) / 2);
}
async function createFolder(data, createdBy) {
    // 동일 부모 내 이름 중복 체크
    const siblings = await (0, folderRepository_1.listFolders)({ parentId: data.parentId, projectId: data.projectId });
    const duplicateName = siblings.find(f => f.name === data.name);
    if (duplicateName) {
        throw new Error(`폴더명 "${data.name}"이(가) 이미 존재합니다.`);
    }
    // orderIndex 계산
    const orderIndex = calculateOrderIndex(siblings.length > 0 ? siblings[siblings.length - 1].orderIndex : null, null);
    // depth 계산
    let depth = 0;
    if (data.parentId) {
        const parent = await (0, folderRepository_1.getFolderById)(data.parentId);
        if (!parent) {
            throw new Error('부모 폴더를 찾을 수 없습니다.');
        }
        depth = parent.depth + 1;
        if (depth > 10) {
            throw new Error('폴더 깊이는 최대 10단계까지 가능합니다.');
        }
    }
    const folderData = {
        projectId: data.projectId,
        parentId: data.parentId,
        name: data.name,
        description: data.description,
        orderIndex,
        depth,
        createdBy,
        isLocked: false,
        isArchived: false
    };
    return await (0, folderRepository_1.createFolder)(folderData);
}
async function updateFolder(id, data, updatedBy) {
    const existing = await (0, folderRepository_1.getFolderById)(id);
    if (!existing)
        return null;
    // 이름 변경 시 중복 체크
    if (data.name && data.name !== existing.name) {
        const siblings = await (0, folderRepository_1.listFolders)({
            parentId: existing.parentId,
            projectId: existing.projectId
        });
        const duplicateName = siblings.find(f => f.id !== id && f.name === data.name);
        if (duplicateName) {
            throw new Error(`폴더명 "${data.name}"이(가) 이미 존재합니다.`);
        }
    }
    // 부모 변경 시 순환 참조 체크
    if (data.parentId !== undefined && data.parentId !== existing.parentId) {
        if (data.parentId === id) {
            throw new Error('자기 자신을 부모로 설정할 수 없습니다.');
        }
        // 하위 폴더로 이동하는지 체크
        const isDescendant = await checkIsDescendant(id, data.parentId);
        if (isDescendant) {
            throw new Error('하위 폴더로는 이동할 수 없습니다.');
        }
    }
    return await (0, folderRepository_1.updateFolder)(id, { ...data, updatedBy });
}
async function moveFolder(id, data, movedBy) {
    const folder = await (0, folderRepository_1.getFolderById)(id);
    if (!folder)
        return null;
    // 순환 참조 체크
    if (data.targetParentId !== undefined) {
        if (data.targetParentId === id) {
            throw new Error('자기 자신을 부모로 설정할 수 없습니다.');
        }
        const isDescendant = await checkIsDescendant(id, data.targetParentId);
        if (isDescendant) {
            throw new Error('하위 폴더로는 이동할 수 없습니다.');
        }
    }
    // 드롭 타입에 따른 orderIndex 계산
    let orderIndex;
    const targetParentId = data.targetParentId !== undefined ? data.targetParentId : folder.parentId;
    const siblings = await (0, folderRepository_1.listFolders)({ parentId: targetParentId, projectId: folder.projectId });
    switch (data.dropType) {
        case 'before':
            if (data.relativeToId) {
                const relativeFolder = siblings.find(f => f.id === data.relativeToId);
                if (relativeFolder) {
                    orderIndex = calculateOrderIndex(null, relativeFolder.orderIndex);
                }
                else {
                    orderIndex = calculateOrderIndex(null, null);
                }
            }
            else {
                orderIndex = calculateOrderIndex(null, null);
            }
            break;
        case 'after':
            if (data.relativeToId) {
                const relativeFolder = siblings.find(f => f.id === data.relativeToId);
                if (relativeFolder) {
                    orderIndex = calculateOrderIndex(relativeFolder.orderIndex, null);
                }
                else {
                    orderIndex = calculateOrderIndex(null, null);
                }
            }
            else {
                orderIndex = calculateOrderIndex(null, null);
            }
            break;
        case 'into':
        default:
            // 자식으로 이동하는 경우 마지막 위치에 배치
            const maxOrderIndex = siblings.length > 0 ? Math.max(...siblings.map(f => f.orderIndex)) : 0;
            orderIndex = calculateOrderIndex(maxOrderIndex, null);
            break;
    }
    return await (0, folderRepository_1.updateFolder)(id, {
        parentId: data.targetParentId,
        orderIndex,
        updatedBy: movedBy
    });
}
async function moveFolderBatch(items, movedBy) {
    const results = {
        success: [],
        failed: []
    };
    // 트랜잭션으로 배치 처리
    for (const item of items) {
        try {
            const folder = await moveFolder(parseInt(item.id), {
                targetParentId: item.targetParentId,
                dropType: item.dropType,
                relativeToId: item.relativeToId,
                orderIndex: item.orderIndex
            }, movedBy);
            if (folder) {
                results.success.push({ id: item.id, folder });
            }
            else {
                results.failed.push({
                    id: item.id,
                    error: '폴더를 찾을 수 없습니다.',
                    reason: 'FOLDER_NOT_FOUND'
                });
            }
        }
        catch (error) {
            let reason = 'UNKNOWN_ERROR';
            if (error.message.includes('순환'))
                reason = 'CYCLIC_MOVE';
            else if (error.message.includes('권한'))
                reason = 'PERMISSION_DENIED';
            else if (error.message.includes('이름'))
                reason = 'NAME_CONFLICT';
            else if (error.message.includes('잠금'))
                reason = 'LOCKED';
            else if (error.message.includes('아카이브'))
                reason = 'ARCHIVED';
            results.failed.push({
                id: item.id,
                error: error.message,
                reason
            });
        }
    }
    return results;
}
async function checkIsDescendant(folderId, targetParentId) {
    const children = await (0, folderRepository_1.listFolders)({ parentId: folderId });
    for (const child of children) {
        if (child.id === targetParentId)
            return true;
        if (await checkIsDescendant(child.id, targetParentId))
            return true;
    }
    return false;
}
async function deleteFolder(id, mode = 'soft', deletedBy) {
    console.log(`🗑️ 폴더 삭제 시도: ID ${id}, 모드: ${mode}`);
    const folder = await (0, folderRepository_1.getFolderById)(id);
    if (!folder) {
        console.log(`❌ 폴더를 찾을 수 없음: ID ${id}`);
        return false;
    }
    console.log(`✅ 폴더 찾음: ${folder.name} (ID: ${folder.id})`);
    // 하위 폴더들을 재귀적으로 삭제
    const children = await (0, folderRepository_1.listFolders)({ parentId: id });
    console.log(`📁 하위 폴더 ${children.length}개 발견`);
    for (const child of children) {
        console.log(`🗑️ 하위 폴더 삭제: ${child.name} (ID: ${child.id})`);
        await deleteFolder(child.id, mode, deletedBy);
    }
    const result = await (0, folderRepository_1.deleteFolder)(id, mode, deletedBy);
    console.log(`🗑️ 폴더 삭제 결과: ${result ? '성공' : '실패'} (ID: ${id})`);
    return result;
}
async function getFolderTree(projectId, depth) {
    return await (0, folderRepository_1.getFolderTree)(projectId, depth);
}
async function getFolderById(id) {
    return await (0, folderRepository_1.getFolderById)(id);
}
async function listFoldersByProject(projectId) {
    return await (0, folderRepository_1.listFolders)({ projectId });
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzLzNpLWExLTIwMjEtMDE3L0RvY3VtZW50cy9xdWVzdC9EZXNrdG9wL3F1ZXN0L3NyYy9tYWluL2FwcC9kb21haW5zL2ZvbGRlcnMvc2VydmljZXMvZm9sZGVyU2VydmljZS50cyIsIm1hcHBpbmdzIjoiOztBQWlCQSxvQ0F3Q0M7QUFFRCxvQ0E4QkM7QUFFRCxnQ0E2REM7QUFFRCwwQ0FtREM7QUFXRCxvQ0F1QkM7QUFFRCxzQ0FFQztBQUVELHNDQUVDO0FBRUQsb0RBRUM7QUExUEQsdUVBQTZPO0FBRTdPLGtCQUFrQjtBQUNsQixTQUFTLG1CQUFtQixDQUFDLFNBQXdCLEVBQUUsU0FBd0I7SUFDM0UsSUFBSSxTQUFTLEtBQUssSUFBSSxJQUFJLFNBQVMsS0FBSyxJQUFJO1FBQUUsT0FBTyxHQUFHLENBQUM7SUFDekQsSUFBSSxTQUFTLEtBQUssSUFBSTtRQUFFLE9BQU8sU0FBVSxHQUFHLEdBQUcsQ0FBQztJQUNoRCxJQUFJLFNBQVMsS0FBSyxJQUFJO1FBQUUsT0FBTyxTQUFTLEdBQUcsR0FBRyxDQUFDO0lBQy9DLElBQUksU0FBUyxHQUFHLFNBQVMsR0FBRyxDQUFDO1FBQUUsT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsU0FBUyxHQUFHLFNBQVMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDOztRQUN6RSxPQUFPLGNBQWMsQ0FBQyxTQUFTLEVBQUUsU0FBUyxDQUFDLENBQUM7QUFDckQsQ0FBQztBQUVELFNBQVMsY0FBYyxDQUFDLFNBQWlCLEVBQUUsU0FBaUI7SUFDeEQsdUJBQXVCO0lBQ3ZCLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLFNBQVMsR0FBRyxTQUFTLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztBQUNuRCxDQUFDO0FBRU0sS0FBSyxVQUFVLFlBQVksQ0FBQyxJQUF5QixFQUFFLFNBQWlCO0lBQzNFLG1CQUFtQjtJQUNuQixNQUFNLFFBQVEsR0FBRyxNQUFNLElBQUEsOEJBQVcsRUFBQyxFQUFFLFFBQVEsRUFBRSxJQUFJLENBQUMsUUFB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Q0FBQyxDQUFDO0lBQ3JELE9BQU8sQ0FBQyxHQUFHLENBQUMsWUFBWSxRQUFRLENBQUMsTUFBTSxNQUFNLENBQUMsQ0FBQztJQUUvQyxLQUFLLE1BQU0sS0FBSyxJQUFJLFFBQVEsRUFBRSxDQUFDO1FBQzNCLE9BQU8sQ0FBQyxHQUFHLENBQUMsaUJBQWlCLEtBQUssQ0FBQyxJQUFJLFNBQVMsS0FBSyxDQUFDLEVBQUUsR0FBRyxDQUFDLENBQUM7UUFDN0QsTUFBTSxZQUFZLENBQUMsS0FBSyxDQUFDLEVBQUUsRUFBRSxJQUFJLEVBQUUsU0FBUyxDQUFDLENBQUM7SUFDbEQsQ0FBQztJQUVELE1BQU0sTUFBTSxHQUFHLE1BQU0sSUFBQSwrQkFBZ0IsRUFBQyxFQUFFLEVBQUUsSUFBSSxFQUFFLFNBQVMsQ0FBQyxDQUFDO0lBQzNELE9BQU8sQ0FBQyxHQUFHLENBQUMsaUJBQWlCLE1BQU0sQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxJQUFJLFNBQVMsRUFBRSxHQUFHLENBQUMsQ0FBQztJQUNqRSxPQUFPLE1BQU0sQ0FBQztBQUNsQixDQUFDO0FBRU0sS0FBSyxVQUFVLGFBQWEsQ0FBQyxTQUFpQixFQUFFLEtBQWM7SUFDakUsT0FBTyxNQUFNLElBQUEsZ0NBQWlCLEVBQUMsU0FBUyxFQUFFLEtBQUssQ0FBQyxDQUFDO0FBQ3JELENBQUM7QUFFTSxLQUFLLFVBQVUsYUFBYSxDQUFDLEVBQVU7SUFDMUMsT0FBTyxNQUFNLElBQUEsZ0NBQWlCLEVBQUMsRUFBRSxDQUFDLENBQUM7QUFDdkMsQ0FBQztBQUVNLEtBQUssVUFBVSxvQkFBb0IsQ0FBQyxTQUFpQjtJQUN4RCxPQUFPLE1BQU0sSUFBQSw4QkFBVyxFQUFDLEVBQUUsU0FBUyxFQUFFLENBQUMsQ0FBQztBQUM1QyxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9Vc2Vycy8zaS1hMS0yMDIxLTAxNy9Eb2N1bWVudHMvcXVlc3QvRGVza3RvcC9xdWVzdC9zcmMvbWFpbi9hcHAvZG9tYWlucy9mb2xkZXJzL3NlcnZpY2VzL2ZvbGRlclNlcnZpY2UudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRm9sZGVyLCBGb2xkZXJUcmVlLCBGb2xkZXJDcmVhdGVSZXF1ZXN0LCBGb2xkZXJVcGRhdGVSZXF1ZXN0LCBGb2xkZXJNb3ZlUmVxdWVzdCB9IGZyb20gJy4uL21vZGVscy9Gb2xkZXInO1xuaW1wb3J0IHsgY3JlYXRlRm9sZGVyIGFzIGNyZWF0ZUZvbGRlclJlcG8sIGdldEZvbGRlckJ5SWQgYXMgZ2V0Rm9sZGVyQnlJZFJlcG8sIHVwZGF0ZUZvbGRlciBhcyB1cGRhdGVGb2xkZXJSZXBvLCBkZWxldGVGb2xkZXIgYXMgZGVsZXRlRm9sZGVyUmVwbywgbGlzdEZvbGRlcnMsIGdldEZvbGRlclRyZWUgYXMgZ2V0Rm9sZGVyVHJlZVJlcG8gfSBmcm9tICcuLi9yZXBvc2l0b3JpZXMvZm9sZGVyUmVwb3NpdG9yeSc7XG5cbi8vIOqwhOqyqeuyleydhCDsnITtlZwg7Jyg7Yu466as7YuwIO2VqOyImFxuZnVuY3Rpb24gY2FsY3VsYXRlT3JkZXJJbmRleChwcmV2SW5kZXg6IG51bWJlciB8IG51bGwsIG5leHRJbmRleDogbnVtYmVyIHwgbnVsbCk6IG51bWJlciB7XG4gICAgaWYgKHByZXZJbmRleCA9PT0gbnVsbCAmJiBuZXh0SW5kZXggPT09IG51bGwpIHJldHVybiAxMDA7XG4gICAgaWYgKHByZXZJbmRleCA9PT0gbnVsbCkgcmV0dXJuIG5leHRJbmRleCEgLSAxMDA7XG4gICAgaWYgKG5leHRJbmRleCA9PT0gbnVsbCkgcmV0dXJuIHByZXZJbmRleCArIDEwMDtcbiAgICBpZiAobmV4dEluZGV4IC0gcHJldkluZGV4ID4gMSkgcmV0dXJuIE1hdGguZmxvb3IoKHByZXZJbmRleCArIG5leHRJbmRleCkgLyAyKTtcbiAgICBlbHNlIHJldHVybiB0cmlnZ2VyUmVpbmRleChwcmV2SW5kZXgsIG5leHRJbmRleCk7XG59XG5cbmZ1bmN0aW9uIHRyaWdnZXJSZWluZGV4KHByZXZJbmRleDogbnVtYmVyLCBuZXh0SW5kZXg6IG51bWJlcik6IG51bWJlciB7XG4gICAgLy8g7Iuk7KCc66Gc64qUIOyEnOuyhOyXkOyEnCDsoITssrQg7J6s6rCE6rKp7J2EIOyImO2WiVxuICAgIHJldHVybiBNYXRoLmZsb29yKChwcmV2SW5kZXggKyBuZXh0SW5kZXgpIC8gMik7XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBjcmVhdGVGb2xkZXIoZGF0YTogRm9sZGVyQ3JlYXRlUmVxdWVzdCwgY3JlYXRlZEJ5OiBzdHJpbmcpOiBQcm9taXNlPEZvbGRlcj4ge1xuICAgIC8vIOuPmeydvCDrtoDrqqgg64K0IOydtOumhCDspJHrs7Ug7LK07YGsXG4gICAgY29uc3Qgc2libGluZ3MgPSBhd2FpdCBsaXN0Rm9sZGVycyh7IHBhcmVudElkOiBkYXRhLnBhcmVudElkLCBwcm9qZWN0SWQ6IGRhdGEucHJvamVjdElkIH0pO1xuICAgIGNvbnN0IGR1cGxpY2F0ZU5hbWUgPSBzaWJsaW5ncy5maW5kKGYgPT4gZi5uYW1lID09PSBkYXRhLm5hbWUpO1xuICAgIGlmIChkdXBsaWNhdGVOYW1lKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihg7Y+0642U66qFIFwiJHtkYXRhLm5hbWV9XCLsnbQo6rCAKSDsnbTrr7gg7KG07J6s7ZWp64uI64ukLmApO1xuICAgIH1cblxuICAgIC8vIG9yZGVySW5kZXgg6rOE7IKwXG4gICAgY29uc3Qgb3JkZXJJbmRleCA9IGNhbGN1bGF0ZU9yZGVySW5kZXgoXG4gICAgICAgIHNpYmxpbmdzLmxlbmd0aCA+IDAgPyBzaWJsaW5nc1tzaWJsaW5ncy5sZW5ndGggLSAxXS5vcmRlckluZGV4IDogbnVsbCxcbiAgICAgICAgbnVsbFxuICAgICk7XG5cbiAgICAvLyBkZXB0aCDqs4TsgrBcbiAgICBsZXQgZGVwdGggPSAwO1xuICAgIGlmIChkYXRhLnBhcmVudElkKSB7XG4gICAgICAgIGNvbnN0IHBhcmVudCA9IGF3YWl0IGdldEZvbGRlckJ5SWRSZXBvKGRhdGEucGFyZW50SWQpO1xuICAgICAgICBpZiAoIXBhcmVudCkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCfrtoDrqqgg7Y+0642U66W8IOywvuydhCDsiJgg7JeG7Iq164uI64ukLicpO1xuICAgICAgICB9XG4gICAgICAgIGRlcHRoID0gcGFyZW50LmRlcHRoICsgMTtcbiAgICAgICAgaWYgKGRlcHRoID4gMTApIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcign7Y+0642UIOq5iuydtOuKlCDstZzrjIAgMTDri6jqs4TquYzsp4Ag6rCA64ql7ZWp64uI64ukLicpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgY29uc3QgZm9sZGVyRGF0YTogT21pdDxGb2xkZXIsICdpZCcgfCAnY3JlYXRlZEF0JyB8ICd1cGRhdGVkQXQnPiA9IHtcbiAgICAgICAgcHJvamVjdElkOiBkYXRhLnByb2plY3RJZCxcbiAgICAgICAgcGFyZW50SWQ6IGRhdGEucGFyZW50SWQsXG4gICAgICAgIG5hbWU6IGRhdGEubmFtZSxcbiAgICAgICAgZGVzY3JpcHRpb246IGRhdGEuZGVzY3JpcHRpb24sXG4gICAgICAgIG9yZGVySW5kZXgsXG4gICAgICAgIGRlcHRoLFxuICAgICAgICBjcmVhdGVkQnksXG4gICAgICAgIGlzTG9ja2VkOiBmYWxzZSxcbiAgICAgICAgaXNBcmNoaXZlZDogZmFsc2VcbiAgICB9O1xuXG4gICAgcmV0dXJuIGF3YWl0IGNyZWF0ZUZvbGRlclJlcG8oZm9sZGVyRGF0YSk7XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiB1cGRhdGVGb2xkZXIoaWQ6IG51bWJlciwgZGF0YTogRm9sZGVyVXBkYXRlUmVxdWVzdCwgdXBkYXRlZEJ5OiBzdHJpbmcpOiBQcm9taXNlPEZvbGRlciB8IG51bGw+IHtcbiAgICBjb25zdCBleGlzdGluZyA9IGF3YWl0IGdldEZvbGRlckJ5SWRSZXBvKGlkKTtcbiAgICBpZiAoIWV4aXN0aW5nKSByZXR1cm4gbnVsbDtcblxuICAgIC8vIOydtOumhCDrs4Dqsr0g7IucIOykkeuztSDssrTtgaxcbiAgICBpZiAoZGF0YS5uYW1lICYmIGRhdGEubmFtZSAhPT0gZXhpc3RpbmcubmFtZSkge1xuICAgICAgICBjb25zdCBzaWJsaW5ncyA9IGF3YWl0IGxpc3RGb2xkZXJzKHsgXG4gICAgICAgICAgICBwYXJlbnRJZDogZXhpc3RpbmcucGFyZW50SWQsIFxuICAgICAgICAgICAgcHJvamVjdElkOiBleGlzdGluZy5wcm9qZWN0SWQgXG4gICAgICAgIH0pO1xuICAgICAgICBjb25zdCBkdXBsaWNhdGVOYW1lID0gc2libGluZ3MuZmluZChmID0+IGYuaWQgIT09IGlkICYmIGYubmFtZSA9PT0gZGF0YS5uYW1lKTtcbiAgICAgICAgaWYgKGR1cGxpY2F0ZU5hbWUpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihg7Y+0642U66qFIFwiJHtkYXRhLm5hbWV9XCLsnbQo6rCAKSDsnbTrr7gg7KG07J6s7ZWp64uI64ukLmApO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLy8g67aA66qoIOuzgOqyvSDsi5wg7Iic7ZmYIOywuOyhsCDssrTtgaxcbiAgICBpZiAoZGF0YS5wYXJlbnRJZCAhPT0gdW5kZWZpbmVkICYmIGRhdGEucGFyZW50SWQgIT09IGV4aXN0aW5nLnBhcmVudElkKSB7XG4gICAgICAgIGlmIChkYXRhLnBhcmVudElkID09PSBpZCkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCfsnpDquLAg7J6Q7Iug7J2EIOu2gOuqqOuhnCDshKTsoJXtlaAg7IiYIOyXhuyKteuLiOuLpC4nKTtcbiAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgLy8g7ZWY7JyEIO2PtOuNlOuhnCDsnbTrj5ntlZjripTsp4Ag7LK07YGsXG4gICAgICAgIGNvbnN0IGlzRGVzY2VuZGFudCA9IGF3YWl0IGNoZWNrSXNEZXNjZW5kYW50KGlkLCBkYXRhLnBhcmVudElkKTtcbiAgICAgICAgaWYgKGlzRGVzY2VuZGFudCkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCftlZjsnIQg7Y+0642U66Gc64qUIOydtOuPme2VoCDsiJgg7JeG7Iq164uI64ukLicpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIGF3YWl0IHVwZGF0ZUZvbGRlclJlcG8oaWQsIHsgLi4uZGF0YSwgdXBkYXRlZEJ5IH0pO1xufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gbW92ZUZvbGRlcihpZDogbnVtYmVyLCBkYXRhOiBGb2xkZXJNb3ZlUmVxdWVzdCwgbW92ZWRCeTogc3RyaW5nKTogUHJvbWlzZTxGb2xkZXIgfCBudWxsPiB7XG4gICAgY29uc3QgZm9sZGVyID0gYXdhaXQgZ2V0Rm9sZGVyQnlJZFJlcG8oaWQpO1xuICAgIGlmICghZm9sZGVyKSByZXR1cm4gbnVsbDtcblxuICAgIC8vIOyInO2ZmCDssLjsobAg7LK07YGsXG4gICAgaWYgKGRhdGEudGFyZ2V0UGFyZW50SWQgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICBpZiAoZGF0YS50YXJnZXRQYXJlbnRJZCA9PT0gaWQpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcign7J6Q6riwIOyekOyLoOydhCDrtoDrqqjroZwg7ISk7KCV7ZWgIOyImCDsl4bsirXri4jri6QuJyk7XG4gICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgIGNvbnN0IGlzRGVzY2VuZGFudCA9IGF3YWl0IGNoZWNrSXNEZXNjZW5kYW50KGlkLCBkYXRhLnRhcmdldFBhcmVudElkKTtcbiAgICAgICAgaWYgKGlzRGVzY2VuZGFudCkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCftlZjsnIQg7Y+0642U66Gc64qUIOydtOuPme2VoCDsiJgg7JeG7Iq164uI64ukLicpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLy8g65Oc66GtIO2DgOyeheyXkCDrlLDrpbggb3JkZXJJbmRleCDqs4TsgrBcbiAgICBsZXQgb3JkZXJJbmRleDogbnVtYmVyO1xuICAgIGNvbnN0IHRhcmdldFBhcmVudElkID0gZGF0YS50YXJnZXRQYXJlbnRJZCAhPT0gdW5kZWZpbmVkID8gZGF0YS50YXJnZXRQYXJlbnRJZCA6IGZvbGRlci5wYXJlbnRJZDtcbiAgICBjb25zdCBzaWJsaW5ncyA9IGF3YWl0IGxpc3RGb2xkZXJzKHsgcGFyZW50SWQ6IHRhcmdldFBhcmVudElkLCBwcm9qZWN0SWQ6IGZvbGRlci5wcm9qZWN0SWQgfSk7XG4gICAgXG4gICAgc3dpdGNoIChkYXRhLmRyb3BUeXBlKSB7XG4gICAgICAgIGNhc2UgJ2JlZm9yZSc6XG4gICAgICAgICAgICBpZiAoZGF0YS5yZWxhdGl2ZVRvSWQpIHtcbiAgICAgICAgICAgICAgICBjb25zdCByZWxhdGl2ZUZvbGRlciA9IHNpYmxpbmdzLmZpbmQoZiA9PiBmLmlkID09PSBkYXRhLnJlbGF0aXZlVG9JZCk7XG4gICAgICAgICAgICAgICAgaWYgKHJlbGF0aXZlRm9sZGVyKSB7XG4gICAgICAgICAgICAgICAgICAgIG9yZGVySW5kZXggPSBjYWxjdWxhdGVPcmRlckluZGV4KG51bGwsIHJlbGF0aXZlRm9sZGVyLm9yZGVySW5kZXgpO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIG9yZGVySW5kZXggPSBjYWxjdWxhdGVPcmRlckluZGV4KG51bGwsIG51bGwpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgb3JkZXJJbmRleCA9IGNhbGN1bGF0ZU9yZGVySW5kZXgobnVsbCwgbnVsbCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIFxuICAgICAgICBjYXNlICdhZnRlcic6XG4gICAgICAgICAgICBpZiAoZGF0YS5yZWxhdGl2ZVRvSWQpIHtcbiAgICAgICAgICAgICAgICBjb25zdCByZWxhdGl2ZUZvbGRlciA9IHNpYmxpbmdzLmZpbmQoZiA9PiBmLmlkID09PSBkYXRhLnJlbGF0aXZlVG9JZCk7XG4gICAgICAgICAgICAgICAgaWYgKHJlbGF0aXZlRm9sZGVyKSB7XG4gICAgICAgICAgICAgICAgICAgIG9yZGVySW5kZXggPSBjYWxjdWxhdGVPcmRlckluZGV4KHJlbGF0aXZlRm9sZGVyLm9yZGVySW5kZXgsIG51bGwpO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIG9yZGVySW5kZXggPSBjYWxjdWxhdGVPcmRlckluZGV4KG51bGwsIG51bGwpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgb3JkZXJJbmRleCA9IGNhbGN1bGF0ZU9yZGVySW5kZXgobnVsbCwgbnVsbCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIFxuICAgICAgICBjYXNlICdpbnRvJzpcbiAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICAgIC8vIOyekOyLneycvOuhnCDsnbTrj5ntlZjripQg6rK97JqwIOuniOyngOuniSDsnITsuZjsl5Ag67Cw7LmYXG4gICAgICAgICAgICBjb25zdCBtYXhPcmRlckluZGV4ID0gc2libGluZ3MubGVuZ3RoID4gMCA/IE1hdGgubWF4KC4uLnNpYmxpbmdzLm1hcChmID0+IGYub3JkZXJJbmRleCkpIDogMDtcbiAgICAgICAgICAgIG9yZGVySW5kZXggPSBjYWxjdWxhdGVPcmRlckluZGV4KG1heE9yZGVySW5kZXgsIG51bGwpO1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgfVxuXG4gICAgcmV0dXJuIGF3YWl0IHVwZGF0ZUZvbGRlclJlcG8oaWQsIHsgXG4gICAgICAgIHBhcmVudElkOiBkYXRhLnRhcmdldFBhcmVudElkLCBcbiAgICAgICAgb3JkZXJJbmRleCxcbiAgICAgICAgdXBkYXRlZEJ5OiBtb3ZlZEJ5IFxuICAgIH0pO1xufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gbW92ZUZvbGRlckJhdGNoKGl0ZW1zOiBBcnJheTx7XG4gICAgaWQ6IHN0cmluZztcbiAgICB0YXJnZXRQYXJlbnRJZD86IG51bWJlcjtcbiAgICBkcm9wVHlwZTogJ2ludG8nIHwgJ2JlZm9yZScgfCAnYWZ0ZXInO1xuICAgIHJlbGF0aXZlVG9JZD86IG51bWJlcjtcbiAgICBvcmRlckluZGV4PzogbnVtYmVyO1xufT4sIG1vdmVkQnk6IHN0cmluZyk6IFByb21pc2U8e1xuICAgIHN1Y2Nlc3M6IEFycmF5PHsgaWQ6IHN0cmluZzsgZm9sZGVyOiBhbnkgfT47XG4gICAgZmFpbGVkOiBBcnJheTx7IGlkOiBzdHJpbmc7IGVycm9yOiBzdHJpbmc7IHJlYXNvbjogc3RyaW5nIH0+O1xufT4ge1xuICAgIGNvbnN0IHJlc3VsdHMgPSB7XG4gICAgICAgIHN1Y2Nlc3M6IFtdIGFzIEFycmF5PHsgaWQ6IHN0cmluZzsgZm9sZGVyOiBhbnkgfT4sXG4gICAgICAgIGZhaWxlZDogW10gYXMgQXJyYXk8eyBpZDogc3RyaW5nOyBlcnJvcjogc3RyaW5nOyByZWFzb246IHN0cmluZyB9PlxuICAgIH07XG5cbiAgICAvLyDtirjrnpzsnq3shZjsnLzroZwg67Cw7LmYIOyymOumrFxuICAgIGZvciAoY29uc3QgaXRlbSBvZiBpdGVtcykge1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgY29uc3QgZm9sZGVyID0gYXdhaXQgbW92ZUZvbGRlcihwYXJzZUludChpdGVtLmlkKSwge1xuICAgICAgICAgICAgICAgIHRhcmdldFBhcmVudElkOiBpdGVtLnRhcmdldFBhcmVudElkLFxuICAgICAgICAgICAgICAgIGRyb3BUeXBlOiBpdGVtLmRyb3BUeXBlLFxuICAgICAgICAgICAgICAgIHJlbGF0aXZlVG9JZDogaXRlbS5yZWxhdGl2ZVRvSWQsXG4gICAgICAgICAgICAgICAgb3JkZXJJbmRleDogaXRlbS5vcmRlckluZGV4XG4gICAgICAgICAgICB9LCBtb3ZlZEJ5KTtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgaWYgKGZvbGRlcikge1xuICAgICAgICAgICAgICAgIHJlc3VsdHMuc3VjY2Vzcy5wdXNoKHsgaWQ6IGl0ZW0uaWQsIGZvbGRlciB9KTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgcmVzdWx0cy5mYWlsZWQucHVzaCh7IFxuICAgICAgICAgICAgICAgICAgICBpZDogaXRlbS5pZCwgXG4gICAgICAgICAgICAgICAgICAgIGVycm9yOiAn7Y+0642U66W8IOywvuydhCDsiJgg7JeG7Iq164uI64ukLicsXG4gICAgICAgICAgICAgICAgICAgIHJlYXNvbjogJ0ZPTERFUl9OT1RfRk9VTkQnXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gY2F0Y2ggKGVycm9yOiBhbnkpIHtcbiAgICAgICAgICAgIGxldCByZWFzb24gPSAnVU5LTk9XTl9FUlJPUic7XG4gICAgICAgICAgICBpZiAoZXJyb3IubWVzc2FnZS5pbmNsdWRlcygn7Iic7ZmYJykpIHJlYXNvbiA9ICdDWUNMSUNfTU9WRSc7XG4gICAgICAgICAgICBlbHNlIGlmIChlcnJvci5tZXNzYWdlLmluY2x1ZGVzKCfqtoztlZwnKSkgcmVhc29uID0gJ1BFUk1JU1NJT05fREVOSUVEJztcbiAgICAgICAgICAgIGVsc2UgaWYgKGVycm9yLm1lc3NhZ2UuaW5jbHVkZXMoJ+ydtOumhCcpKSByZWFzb24gPSAnTkFNRV9DT05GTElDVCc7XG4gICAgICAgICAgICBlbHNlIGlmIChlcnJvci5tZXNzYWdlLmluY2x1ZGVzKCfsnqDquIgnKSkgcmVhc29uID0gJ0xPQ0tFRCc7XG4gICAgICAgICAgICBlbHNlIGlmIChlcnJvci5tZXNzYWdlLmluY2x1ZGVzKCfslYTsubTsnbTruIwnKSkgcmVhc29uID0gJ0FSQ0hJVkVEJztcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgcmVzdWx0cy5mYWlsZWQucHVzaCh7IFxuICAgICAgICAgICAgICAgIGlkOiBpdGVtLmlkLCBcbiAgICAgICAgICAgICAgICBlcnJvcjogZXJyb3IubWVzc2FnZSxcbiAgICAgICAgICAgICAgICByZWFzb25cbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIHJlc3VsdHM7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGNoZWNrSXNEZXNjZW5kYW50KGZvbGRlcklkOiBudW1iZXIsIHRhcmdldFBhcmVudElkOiBudW1iZXIpOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICBjb25zdCBjaGlsZHJlbiA9IGF3YWl0IGxpc3RGb2xkZXJzKHsgcGFyZW50SWQ6IGZvbGRlcklkIH0pO1xuICAgIGZvciAoY29uc3QgY2hpbGQgb2YgY2hpbGRyZW4pIHtcbiAgICAgICAgaWYgKGNoaWxkLmlkID09PSB0YXJnZXRQYXJlbnRJZCkgcmV0dXJuIHRydWU7XG4gICAgICAgIGlmIChhd2FpdCBjaGVja0lzRGVzY2VuZGFudChjaGlsZC5pZCwgdGFyZ2V0UGFyZW50SWQpKSByZXR1cm4gdHJ1ZTtcbiAgICB9XG4gICAgcmV0dXJuIGZhbHNlO1xufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZGVsZXRlRm9sZGVyKGlkOiBudW1iZXIsIG1vZGU6ICdzb2Z0JyB8ICdoYXJkJyA9ICdzb2Z0JywgZGVsZXRlZEJ5OiBzdHJpbmcpOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICBjb25zb2xlLmxvZyhg8J+Xke+4jyDtj7TrjZQg7IKt7KCcIOyLnOuPhDogSUQgJHtpZH0sIOuqqOuTnDogJHttb2RlfWApO1xuICAgIFxuICAgIGNvbnN0IGZvbGRlciA9IGF3YWl0IGdldEZvbGRlckJ5SWRSZXBvKGlkKTtcbiAgICBpZiAoIWZvbGRlcikge1xuICAgICAgICBjb25zb2xlLmxvZyhg4p2MIO2PtOuNlOulvCDssL7snYQg7IiYIOyXhuydjDogSUQgJHtpZH1gKTtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cblxuICAgIGNvbnNvbGUubG9nKGDinIUg7Y+0642UIOywvuydjDogJHtmb2xkZXIubmFtZX0gKElEOiAke2ZvbGRlci5pZH0pYCk7XG5cbiAgICAvLyDtlZjsnIQg7Y+0642U65Ok7J2EIOyerOq3gOyggeycvOuhnCDsgq3soJxcbiAgICBjb25zdCBjaGlsZHJlbiA9IGF3YWl0IGxpc3RGb2xkZXJzKHsgcGFyZW50SWQ6IGlkIH0pO1xuICAgIGNvbnNvbGUubG9nKGDwn5OBIO2VmOychCDtj7TrjZQgJHtjaGlsZHJlbi5sZW5ndGh96rCcIOuwnOqyrGApO1xuICAgIFxuICAgIGZvciAoY29uc3QgY2hpbGQgb2YgY2hpbGRyZW4pIHtcbiAgICAgICAgY29uc29sZS5sb2coYPCfl5HvuI8g7ZWY7JyEIO2PtOuNlCDsgq3soJw6ICR7Y2hpbGQubmFtZX0gKElEOiAke2NoaWxkLmlkfSlgKTtcbiAgICAgICAgYXdhaXQgZGVsZXRlRm9sZGVyKGNoaWxkLmlkLCBtb2RlLCBkZWxldGVkQnkpO1xuICAgIH1cblxuICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGRlbGV0ZUZvbGRlclJlcG8oaWQsIG1vZGUsIGRlbGV0ZWRCeSk7XG4gICAgY29uc29sZS5sb2coYPCfl5HvuI8g7Y+0642UIOyCreygnCDqsrDqs7w6ICR7cmVzdWx0ID8gJ+yEseqztScgOiAn7Iuk7YyoJ30gKElEOiAke2lkfSlgKTtcbiAgICByZXR1cm4gcmVzdWx0O1xufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZ2V0Rm9sZGVyVHJlZShwcm9qZWN0SWQ6IG51bWJlciwgZGVwdGg/OiBudW1iZXIpOiBQcm9taXNlPEZvbGRlclRyZWVbXT4ge1xuICAgIHJldHVybiBhd2FpdCBnZXRGb2xkZXJUcmVlUmVwbyhwcm9qZWN0SWQsIGRlcHRoKTtcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdldEZvbGRlckJ5SWQoaWQ6IG51bWJlcik6IFByb21pc2U8Rm9sZGVyIHwgbnVsbD4ge1xuICAgIHJldHVybiBhd2FpdCBnZXRGb2xkZXJCeUlkUmVwbyhpZCk7XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBsaXN0Rm9sZGVyc0J5UHJvamVjdChwcm9qZWN0SWQ6IG51bWJlcik6IFByb21pc2U8Rm9sZGVyW10+IHtcbiAgICByZXR1cm4gYXdhaXQgbGlzdEZvbGRlcnMoeyBwcm9qZWN0SWQgfSk7XG59ICJdLCJ2ZXJzaW9uIjozfQ==