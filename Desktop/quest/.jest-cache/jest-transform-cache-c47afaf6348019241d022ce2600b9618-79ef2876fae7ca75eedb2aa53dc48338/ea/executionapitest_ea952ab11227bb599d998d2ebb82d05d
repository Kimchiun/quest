29c51889e5a4b4312cc380afeeb5916d
"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
// 모킹 설정 - 올바른 경로 사용
jest.mock('../src/main/app/infrastructure/database/pgClient', () => ({
    query: jest.fn().mockResolvedValue({ rows: [] }),
    connect: jest.fn().mockResolvedValue({}),
}));
jest.mock('../src/main/app/infrastructure/elasticsearch/esClient', () => ({
    search: jest.fn().mockResolvedValue({ hits: { hits: [] } }),
    index: jest.fn().mockResolvedValue({}),
}));
const util_1 = require("util");
global.TextEncoder = util_1.TextEncoder;
global.TextDecoder = util_1.TextDecoder;
// ClearImmediate 폴리필 추가
if (typeof global.clearImmediate === 'undefined') {
    global.clearImmediate = jest.fn();
}
if (typeof global.ReadableStream === 'undefined') {
    global.ReadableStream = require('stream').Readable;
}
if (typeof global.setImmediate === 'undefined') {
    global.setImmediate = (fn, ...args) => setTimeout(fn, 0, ...args);
}
const supertest_1 = __importDefault(require("supertest"));
const app_1 = __importDefault(require("../src/main/app/app"));
// 테스트용 fixture 데이터
const TESTCASE_ID = 1;
const EXECUTED_BY = 'testuser';
let executionId;
describe('Execution API', () => {
    beforeEach(() => {
        // 각 테스트 전에 모킹 초기화
        jest.clearAllMocks();
        // PostgreSQL 모킹 설정
        const { query } = require('../src/main/app/infrastructure/database/pgClient');
        query.mockImplementation((sql, params) => {
            if (sql.includes('INSERT INTO executions')) {
                return Promise.resolve({ rows: [{ id: 1 }] });
            }
            if (sql.includes('SELECT * FROM executions')) {
                return Promise.resolve({
                    rows: [{
                            id: 1,
                            testcase_id: TESTCASE_ID,
                            status: 'Fail',
                            executed_by: EXECUTED_BY,
                            executed_at: new Date().toISOString(),
                            repro_steps: '1. 실행\n2. 실패',
                            comment: '테스트 실패'
                        }]
                });
            }
            if (sql.includes('UPDATE executions')) {
                return Promise.resolve({ rows: [{ id: 1, status: 'Pass', comment: '수정됨' }] });
            }
            if (sql.includes('DELETE FROM executions')) {
                return Promise.resolve({ rows: [] });
            }
            return Promise.resolve({ rows: [] });
        });
    });
    it('should create an execution', async () => {
        const res = await (0, supertest_1.default)(app_1.default)
            .post('/api/executions')
            .send({
            testcaseId: TESTCASE_ID,
            status: 'Fail',
            executedBy: EXECUTED_BY,
            executedAt: new Date().toISOString(),
            reproSteps: '1. 실행\n2. 실패',
            comment: '테스트 실패',
        });
        expect(res.status).toBe(201);
        expect(res.body).toHaveProperty('id');
        executionId = res.body.id;
    }, 60000);
    it('should get execution by id', async () => {
        const res = await (0, supertest_1.default)(app_1.default).get(`/api/executions/${executionId}`);
        expect(res.status).toBe(200);
        expect(res.body.id).toBe(executionId);
    }, 60000);
    it('should get executions by testcase', async () => {
        const res = await (0, supertest_1.default)(app_1.default).get(`/api/executions/testcase/${TESTCASE_ID}`);
        expect(res.status).toBe(200);
        expect(Array.isArray(res.body)).toBe(true);
    }, 60000);
    it('should update execution', async () => {
        const res = await (0, supertest_1.default)(app_1.default)
            .put(`/api/executions/${executionId}`)
            .send({ status: 'Pass', comment: '수정됨' });
        expect(res.status).toBe(200);
        expect(res.body.status).toBe('Pass');
        expect(res.body.comment).toBe('수정됨');
    }, 60000);
    it('should delete execution', async () => {
        const res = await (0, supertest_1.default)(app_1.default).delete(`/api/executions/${executionId}`);
        expect(res.status).toBe(204);
    }, 60000);
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzLzNpLWExLTIwMjEtMDE3L0RvY3VtZW50cy9xdWVzdC9EZXNrdG9wL3F1ZXN0L3Rlc3RzL2V4ZWN1dGlvbi5hcGkudGVzdC50cyIsIm1hcHBpbmdzIjoiOzs7OztBQW1CQSxvQkFBb0I7QUFDcEIsSUFBSSxDQUFDLElBQUksQ0FBQyxrREFBa0QsRUFBRSxHQUFHLEVBQUUsQ0FBQyxDQUFDO0lBQ25FLEtBQUssRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUMsaUJBQWlCLENBQUMsRUFBRSxJQUFJLEVBQUUsRUFBRSxFQUFFLENBQUM7SUFDaEQsT0FBTyxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQyxpQkFBaUIsQ0FBQyxFQUFFLENBQUM7Q0FDekMsQ0FBQyxDQUFDLENBQUM7QUFFSixJQUFJLENBQUMsSUFBSSxDQUFDLHVEQUF1RCxFQUFFLEdBQUcsRUFBRSxDQUFDLENBQUM7SUFDeEUsTUFBTSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQyxpQkFBaUIsQ0FBQyxFQUFFLElBQUksRUFBRSxFQUFFLElBQUksRUFBRSxFQUFFLEVBQUUsRUFBRSxDQUFDO0lBQzNELEtBQUssRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUMsaUJBQWlCLENBQUMsRUFBRSxDQUFDO0NBQ3ZDLENBQUMsQ0FBQyxDQUFDO0FBNUJKLCtCQUFnRDtBQUMvQyxNQUFjLENBQUMsV0FBVyxHQUFHLGtCQUFXLENBQUM7QUFDekMsTUFBYyxDQUFDLFdBQVcsR0FBRyxrQkFBVyxDQUFDO0FBRTFDLHdCQUF3QjtBQUN4QixJQUFJLE9BQVEsTUFBYyxDQUFDLGNBQWMsS0FBSyxXQUFXLEVBQUUsQ0FBQztJQUN6RCxNQUFjLENBQUMsY0FBYyxHQUFHLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQztBQUM3QyxDQUFDO0FBRUQsSUFBSSxPQUFRLE1BQWMsQ0FBQyxjQUFjLEtBQUssV0FBVyxFQUFFLENBQUM7SUFDekQsTUFBYyxDQUFDLGNBQWMsR0FBRyxPQUFPLENBQUMsUUFBUSxDQUFDLENB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QyxhQUFHLENBQUM7YUFDekIsR0FBRyxDQUFDLG1CQUFtQixXQUFXLEVBQUUsQ0FBQzthQUNyQyxJQUFJLENBQUMsRUFBRSxNQUFNLEVBQUUsTUFBTSxFQUFFLE9BQU8sRUFBRSxLQUFLLEVBQUUsQ0FBQyxDQUFDO1FBQzlDLE1BQU0sQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQzdCLE1BQU0sQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUNyQyxNQUFNLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDekMsQ0FBQyxFQUFFLEtBQUssQ0FBQyxDQUFDO0lBRVYsRUFBRSxDQUFDLHlCQUF5QixFQUFFLEtBQUssSUFBSSxFQUFFO1FBQ3JDLE1BQU0sR0FBRyxHQUFHLE1BQU0sSUFBQSxtQkFBTyxFQUFDLGFBQUcsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxtQkFBbUIsV0FBVyxFQUFFLENBQUMsQ0FBQztRQUN4RSxNQUFNLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUNqQyxDQUFDLEVBQUUsS0FBSyxDQUFDLENBQUM7QUFDZCxDQUFDLENBQUMsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvVXNlcnMvM2ktYTEtMjAyMS0wMTcvRG9jdW1lbnRzL3F1ZXN0L0Rlc2t0b3AvcXVlc3QvdGVzdHMvZXhlY3V0aW9uLmFwaS50ZXN0LnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFRleHRFbmNvZGVyLCBUZXh0RGVjb2RlciB9IGZyb20gJ3V0aWwnO1xuKGdsb2JhbCBhcyBhbnkpLlRleHRFbmNvZGVyID0gVGV4dEVuY29kZXI7XG4oZ2xvYmFsIGFzIGFueSkuVGV4dERlY29kZXIgPSBUZXh0RGVjb2RlcjtcblxuLy8gQ2xlYXJJbW1lZGlhdGUg7Y+066as7ZWEIOy2lOqwgFxuaWYgKHR5cGVvZiAoZ2xvYmFsIGFzIGFueSkuY2xlYXJJbW1lZGlhdGUgPT09ICd1bmRlZmluZWQnKSB7XG4gIChnbG9iYWwgYXMgYW55KS5jbGVhckltbWVkaWF0ZSA9IGplc3QuZm4oKTtcbn1cblxuaWYgKHR5cGVvZiAoZ2xvYmFsIGFzIGFueSkuUmVhZGFibGVTdHJlYW0gPT09ICd1bmRlZmluZWQnKSB7XG4gIChnbG9iYWwgYXMgYW55KS5SZWFkYWJsZVN0cmVhbSA9IHJlcXVpcmUoJ3N0cmVhbScpLlJlYWRhYmxlO1xufVxuaWYgKHR5cGVvZiAoZ2xvYmFsIGFzIGFueSkuc2V0SW1tZWRpYXRlID09PSAndW5kZWZpbmVkJykge1xuICAoZ2xvYmFsIGFzIGFueSkuc2V0SW1tZWRpYXRlID0gKGZuOiBhbnksIC4uLmFyZ3M6IGFueVtdKSA9PiBzZXRUaW1lb3V0KGZuLCAwLCAuLi5hcmdzKTtcbn1cblxuaW1wb3J0IHJlcXVlc3QgZnJvbSAnc3VwZXJ0ZXN0JztcbmltcG9ydCBhcHAgZnJvbSAnLi4vc3JjL21haW4vYXBwL2FwcCc7XG5cbi8vIOuqqO2CuSDshKTsoJUgLSDsmKzrsJTrpbgg6rK966GcIOyCrOyaqVxuamVzdC5tb2NrKCcuLi9zcmMvbWFpbi9hcHAvaW5mcmFzdHJ1Y3R1cmUvZGF0YWJhc2UvcGdDbGllbnQnLCAoKSA9PiAoe1xuICBxdWVyeTogamVzdC5mbigpLm1vY2tSZXNvbHZlZFZhbHVlKHsgcm93czogW10gfSksXG4gIGNvbm5lY3Q6IGplc3QuZm4oKS5tb2NrUmVzb2x2ZWRWYWx1ZSh7fSksXG59KSk7XG5cbmplc3QubW9jaygnLi4vc3JjL21haW4vYXBwL2luZnJhc3RydWN0dXJlL2VsYXN0aWNzZWFyY2gvZXNDbGllbnQnLCAoKSA9PiAoe1xuICBzZWFyY2g6IGplc3QuZm4oKS5tb2NrUmVzb2x2ZWRWYWx1ZSh7IGhpdHM6IHsgaGl0czogW10gfSB9KSxcbiAgaW5kZXg6IGplc3QuZm4oKS5tb2NrUmVzb2x2ZWRWYWx1ZSh7fSksXG59KSk7XG5cbi8vIO2FjOyKpO2KuOyaqSBmaXh0dXJlIOuNsOydtO2EsFxuY29uc3QgVEVTVENBU0VfSUQgPSAxO1xuY29uc3QgRVhFQ1VURURfQlkgPSAndGVzdHVzZXInO1xuXG5sZXQgZXhlY3V0aW9uSWQ6IG51bWJlcjtcblxuZGVzY3JpYmUoJ0V4ZWN1dGlvbiBBUEknLCAoKSA9PiB7XG4gICAgYmVmb3JlRWFjaCgoKSA9PiB7XG4gICAgICAgIC8vIOqwgSDthYzsiqTtirgg7KCE7JeQIOuqqO2CuSDstIjquLDtmZRcbiAgICAgICAgamVzdC5jbGVhckFsbE1vY2tzKCk7XG4gICAgICAgIFxuICAgICAgICAvLyBQb3N0Z3JlU1FMIOuqqO2CuSDshKTsoJVcbiAgICAgICAgY29uc3QgeyBxdWVyeSB9ID0gcmVxdWlyZSgnLi4vc3JjL21haW4vYXBwL2luZnJhc3RydWN0dXJlL2RhdGFiYXNlL3BnQ2xpZW50Jyk7XG4gICAgICAgIHF1ZXJ5Lm1vY2tJbXBsZW1lbnRhdGlvbigoc3FsOiBzdHJpbmcsIHBhcmFtczogYW55W10pID0+IHtcbiAgICAgICAgICBpZiAoc3FsLmluY2x1ZGVzKCdJTlNFUlQgSU5UTyBleGVjdXRpb25zJykpIHtcbiAgICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoeyByb3dzOiBbeyBpZDogMSB9XSB9KTtcbiAgICAgICAgICB9XG4gICAgICAgICAgaWYgKHNxbC5pbmNsdWRlcygnU0VMRUNUICogRlJPTSBleGVjdXRpb25zJykpIHtcbiAgICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoeyBcbiAgICAgICAgICAgICAgcm93czogW3sgXG4gICAgICAgICAgICAgICAgaWQ6IDEsIFxuICAgICAgICAgICAgICAgIHRlc3RjYXNlX2lkOiBURVNUQ0FTRV9JRCwgXG4gICAgICAgICAgICAgICAgc3RhdHVzOiAnRmFpbCcsIFxuICAgICAgICAgICAgICAgIGV4ZWN1dGVkX2J5OiBFWEVDVVRFRF9CWSxcbiAgICAgICAgICAgICAgICBleGVjdXRlZF9hdDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpLFxuICAgICAgICAgICAgICAgIHJlcHJvX3N0ZXBzOiAnMS4g7Iuk7ZaJXFxuMi4g7Iuk7YyoJyxcbiAgICAgICAgICAgICAgICBjb21tZW50OiAn7YWM7Iqk7Yq4IOyLpO2MqCdcbiAgICAgICAgICAgICAgfV0gXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICB9XG4gICAgICAgICAgaWYgKHNxbC5pbmNsdWRlcygnVVBEQVRFIGV4ZWN1dGlvbnMnKSkge1xuICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh7IHJvd3M6IFt7IGlkOiAxLCBzdGF0dXM6ICdQYXNzJywgY29tbWVudDogJ+yImOygleuQqCcgfV0gfSk7XG4gICAgICAgICAgfVxuICAgICAgICAgIGlmIChzcWwuaW5jbHVkZXMoJ0RFTEVURSBGUk9NIGV4ZWN1dGlvbnMnKSkge1xuICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh7IHJvd3M6IFtdIH0pO1xuICAgICAgICAgIH1cbiAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHsgcm93czogW10gfSk7XG4gICAgICAgIH0pO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBjcmVhdGUgYW4gZXhlY3V0aW9uJywgYXN5bmMgKCkgPT4ge1xuICAgICAgICBjb25zdCByZXMgPSBhd2FpdCByZXF1ZXN0KGFwcClcbiAgICAgICAgICAgIC5wb3N0KCcvYXBpL2V4ZWN1dGlvbnMnKVxuICAgICAgICAgICAgLnNlbmQoe1xuICAgICAgICAgICAgICAgIHRlc3RjYXNlSWQ6IFRFU1RDQVNFX0lELFxuICAgICAgICAgICAgICAgIHN0YXR1czogJ0ZhaWwnLFxuICAgICAgICAgICAgICAgIGV4ZWN1dGVkQnk6IEVYRUNVVEVEX0JZLFxuICAgICAgICAgICAgICAgIGV4ZWN1dGVkQXQ6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSxcbiAgICAgICAgICAgICAgICByZXByb1N0ZXBzOiAnMS4g7Iuk7ZaJXFxuMi4g7Iuk7YyoJyxcbiAgICAgICAgICAgICAgICBjb21tZW50OiAn7YWM7Iqk7Yq4IOyLpO2MqCcsXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgZXhwZWN0KHJlcy5zdGF0dXMpLnRvQmUoMjAxKTtcbiAgICAgICAgZXhwZWN0KHJlcy5ib2R5KS50b0hhdmVQcm9wZXJ0eSgnaWQnKTtcbiAgICAgICAgZXhlY3V0aW9uSWQgPSByZXMuYm9keS5pZDtcbiAgICB9LCA2MDAwMCk7XG5cbiAgICBpdCgnc2hvdWxkIGdldCBleGVjdXRpb24gYnkgaWQnLCBhc3luYyAoKSA9PiB7XG4gICAgICAgIGNvbnN0IHJlcyA9IGF3YWl0IHJlcXVlc3QoYXBwKS5nZXQoYC9hcGkvZXhlY3V0aW9ucy8ke2V4ZWN1dGlvbklkfWApO1xuICAgICAgICBleHBlY3QocmVzLnN0YXR1cykudG9CZSgyMDApO1xuICAgICAgICBleHBlY3QocmVzLmJvZHkuaWQpLnRvQmUoZXhlY3V0aW9uSWQpO1xuICAgIH0sIDYwMDAwKTtcblxuICAgIGl0KCdzaG91bGQgZ2V0IGV4ZWN1dGlvbnMgYnkgdGVzdGNhc2UnLCBhc3luYyAoKSA9PiB7XG4gICAgICAgIGNvbnN0IHJlcyA9IGF3YWl0IHJlcXVlc3QoYXBwKS5nZXQoYC9hcGkvZXhlY3V0aW9ucy90ZXN0Y2FzZS8ke1RFU1RDQVNFX0lEfWApO1xuICAgICAgICBleHBlY3QocmVzLnN0YXR1cykudG9CZSgyMDApO1xuICAgICAgICBleHBlY3QoQXJyYXkuaXNBcnJheShyZXMuYm9keSkpLnRvQmUodHJ1ZSk7XG4gICAgfSwgNjAwMDApO1xuXG4gICAgaXQoJ3Nob3VsZCB1cGRhdGUgZXhlY3V0aW9uJywgYXN5bmMgKCkgPT4ge1xuICAgICAgICBjb25zdCByZXMgPSBhd2FpdCByZXF1ZXN0KGFwcClcbiAgICAgICAgICAgIC5wdXQoYC9hcGkvZXhlY3V0aW9ucy8ke2V4ZWN1dGlvbklkfWApXG4gICAgICAgICAgICAuc2VuZCh7IHN0YXR1czogJ1Bhc3MnLCBjb21tZW50OiAn7IiY7KCV65CoJyB9KTtcbiAgICAgICAgZXhwZWN0KHJlcy5zdGF0dXMpLnRvQmUoMjAwKTtcbiAgICAgICAgZXhwZWN0KHJlcy5ib2R5LnN0YXR1cykudG9CZSgnUGFzcycpO1xuICAgICAgICBleHBlY3QocmVzLmJvZHkuY29tbWVudCkudG9CZSgn7IiY7KCV65CoJyk7XG4gICAgfSwgNjAwMDApO1xuXG4gICAgaXQoJ3Nob3VsZCBkZWxldGUgZXhlY3V0aW9uJywgYXN5bmMgKCkgPT4ge1xuICAgICAgICBjb25zdCByZXMgPSBhd2FpdCByZXF1ZXN0KGFwcCkuZGVsZXRlKGAvYXBpL2V4ZWN1dGlvbnMvJHtleGVjdXRpb25JZH1gKTtcbiAgICAgICAgZXhwZWN0KHJlcy5zdGF0dXMpLnRvQmUoMjA0KTtcbiAgICB9LCA2MDAwMCk7XG59KTsgIl0sInZlcnNpb24iOjN9