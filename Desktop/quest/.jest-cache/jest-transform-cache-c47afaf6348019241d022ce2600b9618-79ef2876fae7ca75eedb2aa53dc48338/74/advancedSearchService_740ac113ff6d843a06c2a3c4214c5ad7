4326d4e712584d528ba637373d7f5f38
"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.buildAdvancedQuery = buildAdvancedQuery;
exports.advancedSearch = advancedSearch;
exports.saveSearchPreset = saveSearchPreset;
exports.getSearchPresets = getSearchPresets;
exports.deleteSearchPreset = deleteSearchPreset;
const esClient_1 = __importDefault(require("../../../infrastructure/elasticsearch/esClient"));
const INDEX = 'testcases';
/**
 * 복합 조건을 Elasticsearch 쿼리로 변환
 */
function buildAdvancedQuery(filters, page = 0, size = 20) {
    const must = [];
    const should = [];
    const filter = [];
    // 키워드 검색 (제목, 설명, 스텝에서 검색)
    if (filters.keyword) {
        should.push({ match: { title: { query: filters.keyword, boost: 3 } } }, { match: { prereq: { query: filters.keyword, boost: 2 } } }, { match: { steps: { query: filters.keyword, boost: 1 } } }, { match: { expected: { query: filters.keyword, boost: 1 } } });
    }
    // 폴더 필터
    if (filters.folders && filters.folders.length > 0) {
        filter.push({ terms: { folder: filters.folders } });
    }
    // 태그 필터
    if (filters.tags && filters.tags.length > 0) {
        filter.push({ terms: { tags: filters.tags } });
    }
    // 상태 필터
    if (filters.status && filters.status.length > 0) {
        filter.push({ terms: { status: filters.status } });
    }
    // 작성자 필터
    if (filters.createdBy && filters.createdBy.length > 0) {
        filter.push({ terms: { createdBy: filters.createdBy } });
    }
    // 우선순위 필터
    if (filters.priority && filters.priority.length > 0) {
        filter.push({ terms: { priority: filters.priority } });
    }
    // 날짜 범위 필터
    if (filters.dateRange) {
        const range = {};
        if (filters.dateRange.from)
            range.gte = filters.dateRange.from;
        if (filters.dateRange.to)
            range.lte = filters.dateRange.to;
        if (Object.keys(range).length > 0) {
            filter.push({ range: { createdAt: range } });
        }
    }
    const query = {
        bool: {
            must,
            should,
            filter,
            minimum_should_match: filters.keyword ? 1 : 0
        }
    };
    return {
        query,
        highlight: {
            fields: {
                title: {},
                prereq: {},
                steps: {},
                expected: {}
            },
            pre_tags: ['<mark>'],
            post_tags: ['</mark>']
        },
        from: page * size,
        size,
        sort: [
            '_score:desc',
            'createdAt:desc'
        ]
    };
}
/**
 * 고급 검색 실행
 */
async function advancedSearch(filters, page = 0, size = 20) {
    const query = buildAdvancedQuery(filters, page, size);
    const result = await esClient_1.default.search({
        index: INDEX,
        ...query
    });
    const testCases = result.hits.hits.map((hit) => hit._source);
    const highlights = {};
    result.hits.hits.forEach((hit) => {
        if (hit.highlight) {
            highlights[hit._id] = Object.values(hit.highlight).flat();
        }
    });
    return {
        testCases,
        total: typeof result.hits.total === 'number' ? result.hits.total : result.hits.total?.value || 0,
        highlights
    };
}
/**
 * 검색 프리셋 저장
 */
async function saveSearchPreset(preset) {
    const id = `preset_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
    const newPreset = {
        ...preset,
        id,
        createdAt: new Date().toISOString()
    };
    await esClient_1.default.index({
        index: 'search_presets',
        id,
        document: newPreset
    });
    return newPreset;
}
/**
 * 검색 프리셋 목록 조회
 */
async function getSearchPresets(createdBy) {
    const query = {
        query: {
            match_all: {}
        },
        sort: [{ createdAt: { order: 'desc' } }]
    };
    if (createdBy) {
        query.query = { term: { createdBy } };
    }
    const result = await esClient_1.default.search({
        index: 'search_presets',
        ...query
    });
    return result.hits.hits.map((hit) => hit._source);
}
/**
 * 검색 프리셋 삭제
 */
async function deleteSearchPreset(id) {
    try {
        await esClient_1.default.delete({
            index: 'search_presets',
            id
        });
        return true;
    }
    catch (error) {
        console.error('Failed to delete search preset:', error);
        return false;
    }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzLzNpLWExLTIwMjEtMDE3L0RvY3VtZW50cy9xdWVzdC9EZXNrdG9wL3F1ZXN0L3NyYy9tYWluL2FwcC9kb21haW5zL3Rlc3RjYXNlcy9lbGFzdGljc2VhcmNoL2FkdmFuY2VkU2VhcmNoU2VydmljZS50cyIsIm1hcHBpbmdzIjoiOzs7OztBQW1DQSxnREE4RUM7QUFLRCx3Q0EwQkM7QUFLRCw0Q0FlQztBQUtELDRDQWtCQztBQUtELGdEQVdDO0FBM01ELDhGQUFzRTtBQUd0RSxNQUFNLEtBQUssR0FBRyxXQUFXLENBQUM7QUE2QjFCOztHQUVHO0FBQ0gsU0FBZ0Isa0JBQWtCLENBQUMsT0FBNkIsRUFBRSxPQUFlLENBQUMsRUFBRSxPQUFlLEVBQUU7SUFDbkcsTUFBTSxJQUFJLEdBQVUsRUFBRSxDQUFDO0lBQ3ZCLE1BQU0sTUFBTSxHQUFVLEVBQUUsQ0FBQztJQUN6QixNQUFNLE1BQU0sR0FBVSxFQUFFLENBQUM7SUFFekIsMkJBQTJCO0lBQzNCLElBQUksT0FBTyxDQUFDLE9BQU8sRUFBRSxDQUFDO1FBQ3BCLE1BQU0sQ0FBQyxJQUFJLENBQ1QsRUFBRSxLQUFLLEVBQUUsRUFBRSxLQUFLLEVBQUUsRUFBRSxLQUFLLEVBQUUsT0FBTyxDQUFDLE9BQU8sRUFBRSxLQUFLLEVBQUUsQ0FBQyxFQUFFLEVBQUUsRUFBRSxFQUMxRCxFQUFFLEtBQUssRUFBRSxFQUFFLE1BQU0sRUFBRSxFQUFFLEtBQUssRUFBRSxPQUFPLENBQUMsT0FBTyxFQUFFLEtBQUssRUFBRSxDQUFDLEVBQUUsRUFBRSxFQUFFLEVBQzNELEVBQUUsS0FBSyxFQUFFLEVBQUUsS0FBSyxFQUFFLEVBQUUsS0FBSyxFQUFFLE9BQU8sQ0FBQyxPQUFPLEVBQUUsS0FBSyxFQUFFLENBQUMsRUFBRSxFQUFFLEVBQUUsRUFDMUQsRUFBRSxLQUFLLEVBQUUsRUFBRSxRQUFRLEVBQUUsRUFBRSxLQUFLLEVBQUUsT0FBTyxDQUFDLE9BQU8sRUFBRSxLQUFLLEVBQUUsQ0FBQyxFQUFFLEVBQUUsRUFBRSxDQUM5RCxDQUFDO0lBQ0osQ0FBQztJQUVELFFBQVE7SUFDUixJQUFJLE9BQU8sQ0FBQyxPQUFPLElBQUksT0FBTyxDQUFDLE9BQU8sQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFLENBQUM7UUFDbEQsTUFBTSxDQUFDLElBQUksQ0FBQyxFQUFFLEtBQUssRUFBRSxFQUFFLE1BQU0sRUFBRSxPQUFPLENBQUMsT0FBTyxFQUFFLEVBQUUsQ0FBQyxDQUFDO0lBQ3RELENBQUM7SUFFRCxRQUFRO0lBQ1IsSUFBSSxPQUFPLENBQUMsSUFBSSxJQUFJLE9BQU8sQ0FBQyxJQUFJLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRSxDQUFDO1FBQzVDLE1BQU0sQ0FBQyxJQUFJLENBQUMsRUFBRSxLQUFLLEVBQUUsRUFBRSxJQUFJLEVBQUUsT0FBTyxDQUFDLElBQUksRUFBRSxFQUFFLENBQUMsQ0FBQztJQUNqRCxDQUFDO0lBRUQsUUFBUTtJQUNSLElBQUksT0FBTyxDQUFDLE1BQU0sSUFBSSxPQUFPLENBQUMsTUFBTSxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUUsQ0FBQztRQUNoRCxNQUFNLENBQUMsSUFBSSxDQUFDLEVBQUUsS0FBSyxFQUFFLEVBQUUsTUFBTSxFQUFFLE9BQU8sQ0FBQyxNQUFNLEVBQUUsRUFBRSxDQUFDLENBQUM7SUFDckQsQ0FBQztJQUVELFNBQVM7SUFDVCxJQUFJLE9BQU8sQ0FBQyxTQUFTLElBQUksT0FBTyxDQUFDLFNBQVMsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFLENBQUM7UUFDdEQsTUFBTSxDQUFDLElBQUksQ0FBQyxFQUFFLEtBQUssRUFBRSxFQUFFLFNBQVMsRUFBRSxPQUFPLENBQUMsU0FBUyxFQUFFLEVBQUUsQ0FBQyxDQUFDO0lBQzNELENBQUM7SUFFRCxVQUFVO0lBQ1YsSUFBSSxPQUFPLENBQUMsUUFBUSxJQUFJLE9BQU8sQ0FBQyxRQUFRLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRSxDQUFDO1FBQ3BELE1BQU0sQ0FBQyxJQUFJLENBQUMsRUFBRSxLQUFLLEVBQUUsRUFBRSxRQUFRLEVBQUUs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SSxLQUFLLFVBQVUsa0JBQWtCLENBQUMsRUFBVTtJQUNqRCxJQUFJLENBQUM7UUFDSCxNQUFNLGtCQUFRLENBQUMsTUFBTSxDQUFDO1lBQ3BCLEtBQUssRUFBRSxnQkFBZ0I7WUFDdkIsRUFBRTtTQUNILENBQUMsQ0FBQztRQUNILE9BQU8sSUFBSSxDQUFDO0lBQ2QsQ0FBQztJQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7UUFDZixPQUFPLENBQUMsS0FBSyxDQUFDLGlDQUFpQyxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBQ3hELE9BQU8sS0FBSyxDQUFDO0lBQ2YsQ0FBQztBQUNILENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL1VzZXJzLzNpLWExLTIwMjEtMDE3L0RvY3VtZW50cy9xdWVzdC9EZXNrdG9wL3F1ZXN0L3NyYy9tYWluL2FwcC9kb21haW5zL3Rlc3RjYXNlcy9lbGFzdGljc2VhcmNoL2FkdmFuY2VkU2VhcmNoU2VydmljZS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgZXNDbGllbnQgZnJvbSAnLi4vLi4vLi4vaW5mcmFzdHJ1Y3R1cmUvZWxhc3RpY3NlYXJjaC9lc0NsaWVudCc7XG5pbXBvcnQgeyBUZXN0Q2FzZSB9IGZyb20gJy4uL21vZGVscy9UZXN0Q2FzZSc7XG5cbmNvbnN0IElOREVYID0gJ3Rlc3RjYXNlcyc7XG5cbmV4cG9ydCBpbnRlcmZhY2UgQWR2YW5jZWRTZWFyY2hGaWx0ZXIge1xuICBmb2xkZXJzPzogc3RyaW5nW107XG4gIHRhZ3M/OiBzdHJpbmdbXTtcbiAgc3RhdHVzPzogKCdBY3RpdmUnIHwgJ0FyY2hpdmVkJylbXTtcbiAgY3JlYXRlZEJ5Pzogc3RyaW5nW107XG4gIHByaW9yaXR5PzogKCdIaWdoJyB8ICdNZWRpdW0nIHwgJ0xvdycpW107XG4gIGRhdGVSYW5nZT86IHtcbiAgICBmcm9tOiBzdHJpbmc7XG4gICAgdG86IHN0cmluZztcbiAgfTtcbiAga2V5d29yZD86IHN0cmluZztcbn1cblxuZXhwb3J0IGludGVyZmFjZSBTZWFyY2hQcmVzZXQge1xuICBpZDogc3RyaW5nO1xuICBuYW1lOiBzdHJpbmc7XG4gIGZpbHRlcnM6IEFkdmFuY2VkU2VhcmNoRmlsdGVyO1xuICBjcmVhdGVkQnk6IHN0cmluZztcbiAgY3JlYXRlZEF0OiBzdHJpbmc7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgU2VhcmNoUmVzdWx0IHtcbiAgdGVzdENhc2VzOiBUZXN0Q2FzZVtdO1xuICB0b3RhbDogbnVtYmVyO1xuICBoaWdobGlnaHRzOiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmdbXT47XG59XG5cbi8qKlxuICog67O17ZWpIOyhsOqxtOydhCBFbGFzdGljc2VhcmNoIOy/vOumrOuhnCDrs4DtmZhcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGJ1aWxkQWR2YW5jZWRRdWVyeShmaWx0ZXJzOiBBZHZhbmNlZFNlYXJjaEZpbHRlciwgcGFnZTogbnVtYmVyID0gMCwgc2l6ZTogbnVtYmVyID0gMjApIHtcbiAgY29uc3QgbXVzdDogYW55W10gPSBbXTtcbiAgY29uc3Qgc2hvdWxkOiBhbnlbXSA9IFtdO1xuICBjb25zdCBmaWx0ZXI6IGFueVtdID0gW107XG5cbiAgLy8g7YKk7JuM65OcIOqygOyDiSAo7KCc66qpLCDshKTrqoUsIOyKpO2FneyXkOyEnCDqsoDsg4kpXG4gIGlmIChmaWx0ZXJzLmtleXdvcmQpIHtcbiAgICBzaG91bGQucHVzaChcbiAgICAgIHsgbWF0Y2g6IHsgdGl0bGU6IHsgcXVlcnk6IGZpbHRlcnMua2V5d29yZCwgYm9vc3Q6IDMgfSB9IH0sXG4gICAgICB7IG1hdGNoOiB7IHByZXJlcTogeyBxdWVyeTogZmlsdGVycy5rZXl3b3JkLCBib29zdDogMiB9IH0gfSxcbiAgICAgIHsgbWF0Y2g6IHsgc3RlcHM6IHsgcXVlcnk6IGZpbHRlcnMua2V5d29yZCwgYm9vc3Q6IDEgfSB9IH0sXG4gICAgICB7IG1hdGNoOiB7IGV4cGVjdGVkOiB7IHF1ZXJ5OiBmaWx0ZXJzLmtleXdvcmQsIGJvb3N0OiAxIH0gfSB9XG4gICAgKTtcbiAgfVxuXG4gIC8vIO2PtOuNlCDtlYTthLBcbiAgaWYgKGZpbHRlcnMuZm9sZGVycyAmJiBmaWx0ZXJzLmZvbGRlcnMubGVuZ3RoID4gMCkge1xuICAgIGZpbHRlci5wdXNoKHsgdGVybXM6IHsgZm9sZGVyOiBmaWx0ZXJzLmZvbGRlcnMgfSB9KTtcbiAgfVxuXG4gIC8vIO2DnOq3uCDtlYTthLBcbiAgaWYgKGZpbHRlcnMudGFncyAmJiBmaWx0ZXJzLnRhZ3MubGVuZ3RoID4gMCkge1xuICAgIGZpbHRlci5wdXNoKHsgdGVybXM6IHsgdGFnczogZmlsdGVycy50YWdzIH0gfSk7XG4gIH1cblxuICAvLyDsg4Htg5wg7ZWE7YSwXG4gIGlmIChmaWx0ZXJzLnN0YXR1cyAmJiBmaWx0ZXJzLnN0YXR1cy5sZW5ndGggPiAwKSB7XG4gICAgZmlsdGVyLnB1c2goeyB0ZXJtczogeyBzdGF0dXM6IGZpbHRlcnMuc3RhdHVzIH0gfSk7XG4gIH1cblxuICAvLyDsnpHshLHsnpAg7ZWE7YSwXG4gIGlmIChmaWx0ZXJzLmNyZWF0ZWRCeSAmJiBmaWx0ZXJzLmNyZWF0ZWRCeS5sZW5ndGggPiAwKSB7XG4gICAgZmlsdGVyLnB1c2goeyB0ZXJtczogeyBjcmVhdGVkQnk6IGZpbHRlcnMuY3JlYXRlZEJ5IH0gfSk7XG4gIH1cblxuICAvLyDsmrDshKDsiJzsnIQg7ZWE7YSwXG4gIGlmIChmaWx0ZXJzLnByaW9yaXR5ICYmIGZpbHRlcnMucHJpb3JpdHkubGVuZ3RoID4gMCkge1xuICAgIGZpbHRlci5wdXNoKHsgdGVybXM6IHsgcHJpb3JpdHk6IGZpbHRlcnMucHJpb3JpdHkgfSB9KTtcbiAgfVxuXG4gIC8vIOuCoOynnCDrspTsnIQg7ZWE7YSwXG4gIGlmIChmaWx0ZXJzLmRhdGVSYW5nZSkge1xuICAgIGNvbnN0IHJhbmdlOiBhbnkgPSB7fTtcbiAgICBpZiAoZmlsdGVycy5kYXRlUmFuZ2UuZnJvbSkgcmFuZ2UuZ3RlID0gZmlsdGVycy5kYXRlUmFuZ2UuZnJvbTtcbiAgICBpZiAoZmlsdGVycy5kYXRlUmFuZ2UudG8pIHJhbmdlLmx0ZSA9IGZpbHRlcnMuZGF0ZVJhbmdlLnRvO1xuICAgIGlmIChPYmplY3Qua2V5cyhyYW5nZSkubGVuZ3RoID4gMCkge1xuICAgICAgZmlsdGVyLnB1c2goeyByYW5nZTogeyBjcmVhdGVkQXQ6IHJhbmdlIH0gfSk7XG4gICAgfVxuICB9XG5cbiAgY29uc3QgcXVlcnk6IGFueSA9IHtcbiAgICBib29sOiB7XG4gICAgICBtdXN0LFxuICAgICAgc2hvdWxkLFxuICAgICAgZmlsdGVyLFxuICAgICAgbWluaW11bV9zaG91bGRfbWF0Y2g6IGZpbHRlcnMua2V5d29yZCA/IDEgOiAwXG4gICAgfVxuICB9O1xuXG4gIHJldHVybiB7XG4gICAgcXVlcnksXG4gICAgaGlnaGxpZ2h0OiB7XG4gICAgICBmaWVsZHM6IHtcbiAgICAgICAgdGl0bGU6IHt9LFxuICAgICAgICBwcmVyZXE6IHt9LFxuICAgICAgICBzdGVwczoge30sXG4gICAgICAgIGV4cGVjdGVkOiB7fVxuICAgICAgfSxcbiAgICAgIHByZV90YWdzOiBbJzxtYXJrPiddLFxuICAgICAgcG9zdF90YWdzOiBbJzwvbWFyaz4nXVxuICAgIH0sXG4gICAgZnJvbTogcGFnZSAqIHNpemUsXG4gICAgc2l6ZSxcbiAgICBzb3J0OiBbXG4gICAgICAnX3Njb3JlOmRlc2MnLFxuICAgICAgJ2NyZWF0ZWRBdDpkZXNjJ1xuICAgIF1cbiAgfTtcbn1cblxuLyoqXG4gKiDqs6DquIkg6rKA7IOJIOyLpO2WiVxuICovXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gYWR2YW5jZWRTZWFyY2goXG4gIGZpbHRlcnM6IEFkdmFuY2VkU2VhcmNoRmlsdGVyLFxuICBwYWdlOiBudW1iZXIgPSAwLFxuICBzaXplOiBudW1iZXIgPSAyMFxuKTogUHJvbWlzZTxTZWFyY2hSZXN1bHQ+IHtcbiAgY29uc3QgcXVlcnkgPSBidWlsZEFkdmFuY2VkUXVlcnkoZmlsdGVycywgcGFnZSwgc2l6ZSk7XG4gIFxuICBjb25zdCByZXN1bHQgPSBhd2FpdCBlc0NsaWVudC5zZWFyY2goe1xuICAgIGluZGV4OiBJTkRFWCxcbiAgICAuLi5xdWVyeVxuICB9KTtcblxuICBjb25zdCB0ZXN0Q2FzZXMgPSByZXN1bHQuaGl0cy5oaXRzLm1hcCgoaGl0OiBhbnkpID0+IGhpdC5fc291cmNlIGFzIFRlc3RDYXNlKTtcbiAgY29uc3QgaGlnaGxpZ2h0czogUmVjb3JkPHN0cmluZywgc3RyaW5nW10+ID0ge307XG4gIFxuICByZXN1bHQuaGl0cy5oaXRzLmZvckVhY2goKGhpdDogYW55KSA9PiB7XG4gICAgaWYgKGhpdC5oaWdobGlnaHQpIHtcbiAgICAgIGhpZ2hsaWdodHNbaGl0Ll9pZF0gPSBPYmplY3QudmFsdWVzKGhpdC5oaWdobGlnaHQpLmZsYXQoKSBhcyBzdHJpbmdbXTtcbiAgICB9XG4gIH0pO1xuXG4gIHJldHVybiB7XG4gICAgdGVzdENhc2VzLFxuICAgIHRvdGFsOiB0eXBlb2YgcmVzdWx0LmhpdHMudG90YWwgPT09ICdudW1iZXInID8gcmVzdWx0LmhpdHMudG90YWwgOiByZXN1bHQuaGl0cy50b3RhbD8udmFsdWUgfHwgMCxcbiAgICBoaWdobGlnaHRzXG4gIH07XG59XG5cbi8qKlxuICog6rKA7IOJIO2UhOumrOyFiyDsoIDsnqVcbiAqL1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHNhdmVTZWFyY2hQcmVzZXQocHJlc2V0OiBPbWl0PFNlYXJjaFByZXNldCwgJ2lkJyB8ICdjcmVhdGVkQXQnPik6IFByb21pc2U8U2VhcmNoUHJlc2V0PiB7XG4gIGNvbnN0IGlkID0gYHByZXNldF8ke0RhdGUubm93KCl9XyR7TWF0aC5yYW5kb20oKS50b1N0cmluZygzNikuc3Vic3RyKDIsIDkpfWA7XG4gIGNvbnN0IG5ld1ByZXNldDogU2VhcmNoUHJlc2V0ID0ge1xuICAgIC4uLnByZXNldCxcbiAgICBpZCxcbiAgICBjcmVhdGVkQXQ6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKVxuICB9O1xuXG4gIGF3YWl0IGVzQ2xpZW50LmluZGV4KHtcbiAgICBpbmRleDogJ3NlYXJjaF9wcmVzZXRzJyxcbiAgICBpZCxcbiAgICBkb2N1bWVudDogbmV3UHJlc2V0XG4gIH0pO1xuXG4gIHJldHVybiBuZXdQcmVzZXQ7XG59XG5cbi8qKlxuICog6rKA7IOJIO2UhOumrOyFiyDrqqnroZ0g7KGw7ZqMXG4gKi9cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBnZXRTZWFyY2hQcmVzZXRzKGNyZWF0ZWRCeT86IHN0cmluZyk6IFByb21pc2U8U2VhcmNoUHJlc2V0W10+IHtcbiAgY29uc3QgcXVlcnk6IGFueSA9IHtcbiAgICBxdWVyeToge1xuICAgICAgbWF0Y2hfYWxsOiB7fVxuICAgIH0sXG4gICAgc29ydDogW3sgY3JlYXRlZEF0OiB7IG9yZGVyOiAnZGVzYycgfSB9XVxuICB9O1xuXG4gIGlmIChjcmVhdGVkQnkpIHtcbiAgICBxdWVyeS5xdWVyeSA9IHsgdGVybTogeyBjcmVhdGVkQnkgfSB9O1xuICB9XG5cbiAgY29uc3QgcmVzdWx0ID0gYXdhaXQgZXNDbGllbnQuc2VhcmNoKHtcbiAgICBpbmRleDogJ3NlYXJjaF9wcmVzZXRzJyxcbiAgICAuLi5xdWVyeVxuICB9KTtcblxuICByZXR1cm4gcmVzdWx0LmhpdHMuaGl0cy5tYXAoKGhpdDogYW55KSA9PiBoaXQuX3NvdXJjZSBhcyBTZWFyY2hQcmVzZXQpO1xufVxuXG4vKipcbiAqIOqygOyDiSDtlITrpqzshYsg7IKt7KCcXG4gKi9cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBkZWxldGVTZWFyY2hQcmVzZXQoaWQ6IHN0cmluZyk6IFByb21pc2U8Ym9vbGVhbj4ge1xuICB0cnkge1xuICAgIGF3YWl0IGVzQ2xpZW50LmRlbGV0ZSh7XG4gICAgICBpbmRleDogJ3NlYXJjaF9wcmVzZXRzJyxcbiAgICAgIGlkXG4gICAgfSk7XG4gICAgcmV0dXJuIHRydWU7XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgY29uc29sZS5lcnJvcignRmFpbGVkIHRvIGRlbGV0ZSBzZWFyY2ggcHJlc2V0OicsIGVycm9yKTtcbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cbn0gIl0sInZlcnNpb24iOjN9