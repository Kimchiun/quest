089e217e2fdb80e49a392c483ca33230
"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
// 모킹 설정 - 올바른 경로 사용
jest.mock('../src/main/app/infrastructure/database/pgClient', () => ({
    query: jest.fn().mockResolvedValue({ rows: [] }),
    connect: jest.fn().mockResolvedValue({}),
}));
jest.mock('../src/main/app/infrastructure/elasticsearch/esClient', () => ({
    search: jest.fn().mockResolvedValue({ hits: { hits: [] } }),
    index: jest.fn().mockResolvedValue({}),
}));
const util_1 = require("util");
global.TextEncoder = util_1.TextEncoder;
global.TextDecoder = util_1.TextDecoder;
// ClearImmediate 폴리필 추가
if (typeof global.clearImmediate === 'undefined') {
    global.clearImmediate = jest.fn();
}
if (typeof global.ReadableStream === 'undefined') {
    global.ReadableStream = require('stream').Readable;
}
if (typeof global.setImmediate === 'undefined') {
    global.setImmediate = (fn, ...args) => setTimeout(fn, 0, ...args);
}
const supertest_1 = __importDefault(require("supertest"));
const app_1 = __importDefault(require("../src/main/app/app"));
// 테스트용 fixture 데이터 - 스키마에 맞게 수정
const TESTCASE_ID = 1;
const RELEASE_ID = '550e8400-e29b-41d4-a716-446655440000'; // UUID 형식
const EXECUTED_BY = 'testuser';
let executionId;
describe('Execution API', () => {
    beforeEach(() => {
        // 각 테스트 전에 모킹 초기화
        jest.clearAllMocks();
        // PostgreSQL 모킹 설정 - 스키마에 맞게 수정
        const { query } = require('../src/main/app/infrastructure/database/pgClient');
        query.mockImplementation((sql, params) => {
            if (sql.includes('INSERT INTO executions')) {
                return Promise.resolve({ rows: [{ id: 1 }] });
            }
            if (sql.includes('SELECT * FROM executions')) {
                return Promise.resolve({
                    rows: [{
                            id: 1,
                            testcase_id: TESTCASE_ID,
                            release_id: RELEASE_ID, // UUID 형식
                            status: 'Fail',
                            executed_by: EXECUTED_BY,
                            executed_at: new Date().toISOString(),
                            comments: '테스트 실패' // comments (복수형)
                        }]
                });
            }
            if (sql.includes('UPDATE executions')) {
                return Promise.resolve({ rows: [{ id: 1, status: 'Pass', comments: '수정됨' }] });
            }
            if (sql.includes('DELETE FROM executions')) {
                return Promise.resolve({ rows: [] });
            }
            return Promise.resolve({ rows: [] });
        });
    });
    it('should create an execution', async () => {
        const res = await (0, supertest_1.default)(app_1.default)
            .post('/api/executions')
            .send({
            testcaseId: TESTCASE_ID,
            releaseId: RELEASE_ID, // UUID 형식
            status: 'Fail',
            executedBy: EXECUTED_BY,
            executedAt: new Date().toISOString(),
            comment: '테스트 실패' // comment (단수형)
        });
        expect(res.status).toBe(201);
        expect(res.body).toHaveProperty('id');
        executionId = res.body.id;
    }, 60000);
    it('should get execution by id', async () => {
        const res = await (0, supertest_1.default)(app_1.default).get(`/api/executions/${executionId}`);
        expect(res.status).toBe(200);
        expect(res.body.id).toBe(executionId);
    }, 60000);
    it('should get executions by testcase', async () => {
        const res = await (0, supertest_1.default)(app_1.default).get(`/api/executions/testcase/${TESTCASE_ID}`);
        expect(res.status).toBe(200);
        expect(Array.isArray(res.body)).toBe(true);
    }, 60000);
    it('should update execution', async () => {
        const res = await (0, supertest_1.default)(app_1.default)
            .put(`/api/executions/${executionId}`)
            .send({ status: 'Pass', comment: '수정됨' });
        expect(res.status).toBe(200);
        expect(res.body.status).toBe('Pass');
        expect(res.body.comment).toBe('수정됨');
    }, 60000);
    it('should delete execution', async () => {
        const res = await (0, supertest_1.default)(app_1.default).delete(`/api/executions/${executionId}`);
        expect(res.status).toBe(204);
    }, 60000);
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzLzNpLWExLTIwMjEtMDE3L0RvY3VtZW50cy9xdWVzdC9EZXNrdG9wL3F1ZXN0L3Rlc3RzL2V4ZWN1dGlvbi5hcGkudGVzdC50cyIsIm1hcHBpbmdzIjoiOzs7OztBQW1CQSxvQkFBb0I7QUFDcEIsSUFBSSxDQUFDLElBQUksQ0FBQyxrREFBa0QsRUFBRSxHQUFHLEVBQUUsQ0FBQyxDQUFDO0lBQ25FLEtBQUssRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUMsaUJBQWlCLENBQUMsRUFBRSxJQUFJLEVBQUUsRUFBRSxFQUFFLENBQUM7SUFDaEQsT0FBTyxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQyxpQkFBaUIsQ0FBQyxFQUFFLENBQUM7Q0FDekMsQ0FBQyxDQUFDLENBQUM7QUFFSixJQUFJLENBQUMsSUFBSSxDQUFDLHVEQUF1RCxFQUFFLEdBQUcsRUFBRSxDQUFDLENBQUM7SUFDeEUsTUFBTSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQyxpQkFBaUIsQ0FBQyxFQUFFLElBQUksRUFBRSxFQUFFLElBQUksRUFBRSxFQUFFLEVBQUUsRUFBRSxDQUFDO0lBQzNELEtBQUssRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUMsaUJBQWlCLENBQUMsRUFBRSxDQUFDO0NBQ3ZDLENBQUMsQ0FBQyxDQUFDO0FBNUJKLCtCQUFnRDtBQUMvQyxNQUFjLENBQUMsV0FBVyxHQUFHLGtCQUFXLENBQUM7QUFDekMsTUFBYyxDQUFDLFdBQVcsR0FBRyxrQkFBVyxDQUFDO0FBRTFDLHdCQUF3QjtBQUN4QixJQUFJLE9BQVEsTUFBYyxDQUFDLGNBQWMsS0FBSyxXQUFXLEVBQUUsQ0FBQztJQUN6RCxNQUFjLENBQUMsY0FBYyxHQUFHLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQztBQUM3QyxDQUFDO0FBRUQsSUFBSSxPQUFRLE1BQWMsQ0FBQyxjQUFjLEtBQUssV0FBVyxFQUFFLENBQUM7SUFDekQsTUFBYyxDQUFDLGNBQWMsR0FBRyxPQUFPLENBQUMsUUFBUSxDQUFDLENB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Q0FBQztJQUVWLEVBQUUsQ0FBQyx5QkFBeUIsRUFBRSxLQUFLLElBQUksRUFBRTtRQUNyQyxNQUFNLEdBQUcsR0FBRyxNQUFNLElBQUEsbUJBQU8sRUFBQyxhQUFHLENBQUM7YUFDekIsR0FBRyxDQUFDLG1CQUFtQixXQUFXLEVBQUUsQ0FBQzthQUNyQyxJQUFJLENBQUMsRUFBRSxNQUFNLEVBQUUsTUFBTSxFQUFFLE9BQU8sRUFBRSxLQUFLLEVBQUUsQ0FBQyxDQUFDO1FBQzlDLE1BQU0sQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQzdCLE1BQU0sQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUNyQyxNQUFNLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDekMsQ0FBQyxFQUFFLEtBQUssQ0FBQyxDQUFDO0lBRVYsRUFBRSxDQUFDLHlCQUF5QixFQUFFLEtBQUssSUFBSSxFQUFFO1FBQ3JDLE1BQU0sR0FBRyxHQUFHLE1BQU0sSUFBQSxtQkFBTyxFQUFDLGFBQUcsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxtQkFBbUIsV0FBVyxFQUFFLENBQUMsQ0FBQztRQUN4RSxNQUFNLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUNqQyxDQUFDLEVBQUUsS0FBSyxDQUFDLENBQUM7QUFDZCxDQUFDLENBQUMsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvVXNlcnMvM2ktYTEtMjAyMS0wMTcvRG9jdW1lbnRzL3F1ZXN0L0Rlc2t0b3AvcXVlc3QvdGVzdHMvZXhlY3V0aW9uLmFwaS50ZXN0LnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFRleHRFbmNvZGVyLCBUZXh0RGVjb2RlciB9IGZyb20gJ3V0aWwnO1xuKGdsb2JhbCBhcyBhbnkpLlRleHRFbmNvZGVyID0gVGV4dEVuY29kZXI7XG4oZ2xvYmFsIGFzIGFueSkuVGV4dERlY29kZXIgPSBUZXh0RGVjb2RlcjtcblxuLy8gQ2xlYXJJbW1lZGlhdGUg7Y+066as7ZWEIOy2lOqwgFxuaWYgKHR5cGVvZiAoZ2xvYmFsIGFzIGFueSkuY2xlYXJJbW1lZGlhdGUgPT09ICd1bmRlZmluZWQnKSB7XG4gIChnbG9iYWwgYXMgYW55KS5jbGVhckltbWVkaWF0ZSA9IGplc3QuZm4oKTtcbn1cblxuaWYgKHR5cGVvZiAoZ2xvYmFsIGFzIGFueSkuUmVhZGFibGVTdHJlYW0gPT09ICd1bmRlZmluZWQnKSB7XG4gIChnbG9iYWwgYXMgYW55KS5SZWFkYWJsZVN0cmVhbSA9IHJlcXVpcmUoJ3N0cmVhbScpLlJlYWRhYmxlO1xufVxuaWYgKHR5cGVvZiAoZ2xvYmFsIGFzIGFueSkuc2V0SW1tZWRpYXRlID09PSAndW5kZWZpbmVkJykge1xuICAoZ2xvYmFsIGFzIGFueSkuc2V0SW1tZWRpYXRlID0gKGZuOiBhbnksIC4uLmFyZ3M6IGFueVtdKSA9PiBzZXRUaW1lb3V0KGZuLCAwLCAuLi5hcmdzKTtcbn1cblxuaW1wb3J0IHJlcXVlc3QgZnJvbSAnc3VwZXJ0ZXN0JztcbmltcG9ydCBhcHAgZnJvbSAnLi4vc3JjL21haW4vYXBwL2FwcCc7XG5cbi8vIOuqqO2CuSDshKTsoJUgLSDsmKzrsJTrpbgg6rK966GcIOyCrOyaqVxuamVzdC5tb2NrKCcuLi9zcmMvbWFpbi9hcHAvaW5mcmFzdHJ1Y3R1cmUvZGF0YWJhc2UvcGdDbGllbnQnLCAoKSA9PiAoe1xuICBxdWVyeTogamVzdC5mbigpLm1vY2tSZXNvbHZlZFZhbHVlKHsgcm93czogW10gfSksXG4gIGNvbm5lY3Q6IGplc3QuZm4oKS5tb2NrUmVzb2x2ZWRWYWx1ZSh7fSksXG59KSk7XG5cbmplc3QubW9jaygnLi4vc3JjL21haW4vYXBwL2luZnJhc3RydWN0dXJlL2VsYXN0aWNzZWFyY2gvZXNDbGllbnQnLCAoKSA9PiAoe1xuICBzZWFyY2g6IGplc3QuZm4oKS5tb2NrUmVzb2x2ZWRWYWx1ZSh7IGhpdHM6IHsgaGl0czogW10gfSB9KSxcbiAgaW5kZXg6IGplc3QuZm4oKS5tb2NrUmVzb2x2ZWRWYWx1ZSh7fSksXG59KSk7XG5cbi8vIO2FjOyKpO2KuOyaqSBmaXh0dXJlIOuNsOydtO2EsCAtIOyKpO2CpOuniOyXkCDrp57qsowg7IiY7KCVXG5jb25zdCBURVNUQ0FTRV9JRCA9IDE7XG5jb25zdCBSRUxFQVNFX0lEID0gJzU1MGU4NDAwLWUyOWItNDFkNC1hNzE2LTQ0NjY1NTQ0MDAwMCc7IC8vIFVVSUQg7ZiV7IudXG5jb25zdCBFWEVDVVRFRF9CWSA9ICd0ZXN0dXNlcic7XG5cbmxldCBleGVjdXRpb25JZDogbnVtYmVyO1xuXG5kZXNjcmliZSgnRXhlY3V0aW9uIEFQSScsICgpID0+IHtcbiAgICBiZWZvcmVFYWNoKCgpID0+IHtcbiAgICAgICAgLy8g6rCBIO2FjOyKpO2KuCDsoITsl5Ag66qo7YK5IOy0iOq4sO2ZlFxuICAgICAgICBqZXN0LmNsZWFyQWxsTW9ja3MoKTtcbiAgICAgICAgXG4gICAgICAgIC8vIFBvc3RncmVTUUwg66qo7YK5IOyEpOyglSAtIOyKpO2CpOuniOyXkCDrp57qsowg7IiY7KCVXG4gICAgICAgIGNvbnN0IHsgcXVlcnkgfSA9IHJlcXVpcmUoJy4uL3NyYy9tYWluL2FwcC9pbmZyYXN0cnVjdHVyZS9kYXRhYmFzZS9wZ0NsaWVudCcpO1xuICAgICAgICBxdWVyeS5tb2NrSW1wbGVtZW50YXRpb24oKHNxbDogc3RyaW5nLCBwYXJhbXM6IGFueVtdKSA9PiB7XG4gICAgICAgICAgaWYgKHNxbC5pbmNsdWRlcygnSU5TRVJUIElOVE8gZXhlY3V0aW9ucycpKSB7XG4gICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHsgcm93czogW3sgaWQ6IDEgfV0gfSk7XG4gICAgICAgICAgfVxuICAgICAgICAgIGlmIChzcWwuaW5jbHVkZXMoJ1NFTEVDVCAqIEZST00gZXhlY3V0aW9ucycpKSB7XG4gICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHsgXG4gICAgICAgICAgICAgIHJvd3M6IFt7IFxuICAgICAgICAgICAgICAgIGlkOiAxLCBcbiAgICAgICAgICAgICAgICB0ZXN0Y2FzZV9pZDogVEVTVENBU0VfSUQsXG4gICAgICAgICAgICAgICAgcmVsZWFzZV9pZDogUkVMRUFTRV9JRCwgLy8gVVVJRCDtmJXsi51cbiAgICAgICAgICAgICAgICBzdGF0dXM6ICdGYWlsJywgXG4gICAgICAgICAgICAgICAgZXhlY3V0ZWRfYnk6IEVYRUNVVEVEX0JZLFxuICAgICAgICAgICAgICAgIGV4ZWN1dGVkX2F0OiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCksXG4gICAgICAgICAgICAgICAgY29tbWVudHM6ICfthYzsiqTtirgg7Iuk7YyoJyAvLyBjb21tZW50cyAo67O17IiY7ZiVKVxuICAgICAgICAgICAgICB9XSBcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH1cbiAgICAgICAgICBpZiAoc3FsLmluY2x1ZGVzKCdVUERBVEUgZXhlY3V0aW9ucycpKSB7XG4gICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHsgcm93czogW3sgaWQ6IDEsIHN0YXR1czogJ1Bhc3MnLCBjb21tZW50czogJ+yImOygleuQqCcgfV0gfSk7XG4gICAgICAgICAgfVxuICAgICAgICAgIGlmIChzcWwuaW5jbHVkZXMoJ0RFTEVURSBGUk9NIGV4ZWN1dGlvbnMnKSkge1xuICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh7IHJvd3M6IFtdIH0pO1xuICAgICAgICAgIH1cbiAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHsgcm93czogW10gfSk7XG4gICAgICAgIH0pO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBjcmVhdGUgYW4gZXhlY3V0aW9uJywgYXN5bmMgKCkgPT4ge1xuICAgICAgICBjb25zdCByZXMgPSBhd2FpdCByZXF1ZXN0KGFwcClcbiAgICAgICAgICAgIC5wb3N0KCcvYXBpL2V4ZWN1dGlvbnMnKVxuICAgICAgICAgICAgLnNlbmQoe1xuICAgICAgICAgICAgICAgIHRlc3RjYXNlSWQ6IFRFU1RDQVNFX0lELFxuICAgICAgICAgICAgICAgIHJlbGVhc2VJZDogUkVMRUFTRV9JRCwgLy8gVVVJRCDtmJXsi51cbiAgICAgICAgICAgICAgICBzdGF0dXM6ICdGYWlsJyxcbiAgICAgICAgICAgICAgICBleGVjdXRlZEJ5OiBFWEVDVVRFRF9CWSxcbiAgICAgICAgICAgICAgICBleGVjdXRlZEF0OiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCksXG4gICAgICAgICAgICAgICAgY29tbWVudDogJ+2FjOyKpO2KuCDsi6TtjKgnIC8vIGNvbW1lbnQgKOuLqOyImO2YlSlcbiAgICAgICAgICAgIH0pO1xuICAgICAgICBleHBlY3QocmVzLnN0YXR1cykudG9CZSgyMDEpO1xuICAgICAgICBleHBlY3QocmVzLmJvZHkpLnRvSGF2ZVByb3BlcnR5KCdpZCcpO1xuICAgICAgICBleGVjdXRpb25JZCA9IHJlcy5ib2R5LmlkO1xuICAgIH0sIDYwMDAwKTtcblxuICAgIGl0KCdzaG91bGQgZ2V0IGV4ZWN1dGlvbiBieSBpZCcsIGFzeW5jICgpID0+IHtcbiAgICAgICAgY29uc3QgcmVzID0gYXdhaXQgcmVxdWVzdChhcHApLmdldChgL2FwaS9leGVjdXRpb25zLyR7ZXhlY3V0aW9uSWR9YCk7XG4gICAgICAgIGV4cGVjdChyZXMuc3RhdHVzKS50b0JlKDIwMCk7XG4gICAgICAgIGV4cGVjdChyZXMuYm9keS5pZCkudG9CZShleGVjdXRpb25JZCk7XG4gICAgfSwgNjAwMDApO1xuXG4gICAgaXQoJ3Nob3VsZCBnZXQgZXhlY3V0aW9ucyBieSB0ZXN0Y2FzZScsIGFzeW5jICgpID0+IHtcbiAgICAgICAgY29uc3QgcmVzID0gYXdhaXQgcmVxdWVzdChhcHApLmdldChgL2FwaS9leGVjdXRpb25zL3Rlc3RjYXNlLyR7VEVTVENBU0VfSUR9YCk7XG4gICAgICAgIGV4cGVjdChyZXMuc3RhdHVzKS50b0JlKDIwMCk7XG4gICAgICAgIGV4cGVjdChBcnJheS5pc0FycmF5KHJlcy5ib2R5KSkudG9CZSh0cnVlKTtcbiAgICB9LCA2MDAwMCk7XG5cbiAgICBpdCgnc2hvdWxkIHVwZGF0ZSBleGVjdXRpb24nLCBhc3luYyAoKSA9PiB7XG4gICAgICAgIGNvbnN0IHJlcyA9IGF3YWl0IHJlcXVlc3QoYXBwKVxuICAgICAgICAgICAgLnB1dChgL2FwaS9leGVjdXRpb25zLyR7ZXhlY3V0aW9uSWR9YClcbiAgICAgICAgICAgIC5zZW5kKHsgc3RhdHVzOiAnUGFzcycsIGNvbW1lbnQ6ICfsiJjsoJXrkKgnIH0pO1xuICAgICAgICBleHBlY3QocmVzLnN0YXR1cykudG9CZSgyMDApO1xuICAgICAgICBleHBlY3QocmVzLmJvZHkuc3RhdHVzKS50b0JlKCdQYXNzJyk7XG4gICAgICAgIGV4cGVjdChyZXMuYm9keS5jb21tZW50KS50b0JlKCfsiJjsoJXrkKgnKTtcbiAgICB9LCA2MDAwMCk7XG5cbiAgICBpdCgnc2hvdWxkIGRlbGV0ZSBleGVjdXRpb24nLCBhc3luYyAoKSA9PiB7XG4gICAgICAgIGNvbnN0IHJlcyA9IGF3YWl0IHJlcXVlc3QoYXBwKS5kZWxldGUoYC9hcGkvZXhlY3V0aW9ucy8ke2V4ZWN1dGlvbklkfWApO1xuICAgICAgICBleHBlY3QocmVzLnN0YXR1cykudG9CZSgyMDQpO1xuICAgIH0sIDYwMDAwKTtcbn0pOyAiXSwidmVyc2lvbiI6M30=