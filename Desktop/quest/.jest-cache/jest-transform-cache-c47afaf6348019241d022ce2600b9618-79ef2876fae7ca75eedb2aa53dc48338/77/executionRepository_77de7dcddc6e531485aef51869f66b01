3bbd867ec73305e2743d4840f075fbf0
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.executionRepository = void 0;
const pgClient_1 = require("../../../infrastructure/database/pgClient");
exports.executionRepository = {
    async insert(execution) {
        await (0, pgClient_1.ensurePgConnected)();
        const pgClient = (0, pgClient_1.getPgClient)();
        if (!pgClient) {
            throw new Error('PostgreSQL 클라이언트가 초기화되지 않았습니다.');
        }
        const now = new Date();
        console.log('Inserting execution:', execution);
        const sql = `INSERT INTO executions 
            (testcase_id, release_id, status, executed_by, executed_at, comments, created_at, updated_at)
         VALUES ($1, $2, $3, $4, $5, $6, $7, $8)
         RETURNING *`;
        const params = [
            execution.testcaseId,
            execution.releaseId,
            execution.status,
            execution.executedBy,
            execution.executedAt,
            execution.comment || null,
            now,
            now
        ];
        console.log('Executing SQL:', sql);
        console.log('With params:', params);
        const result = await pgClient.query(sql, params);
        return mapRowToExecution(result.rows[0]);
    },
    async findById(id) {
        await (0, pgClient_1.ensurePgConnected)();
        const pgClient = (0, pgClient_1.getPgClient)();
        if (!pgClient) {
            throw new Error('PostgreSQL 클라이언트가 초기화되지 않았습니다.');
        }
        const result = await pgClient.query('SELECT * FROM executions WHERE id = $1', [id]);
        return result.rows[0] ? mapRowToExecution(result.rows[0]) : null;
    },
    async findByTestCase(testcaseId) {
        await (0, pgClient_1.ensurePgConnected)();
        const pgClient = (0, pgClient_1.getPgClient)();
        if (!pgClient) {
            throw new Error('PostgreSQL 클라이언트가 초기화되지 않았습니다.');
        }
        const result = await pgClient.query('SELECT * FROM executions WHERE testcase_id = $1', [testcaseId]);
        return result.rows.map(mapRowToExecution);
    },
    async update(id, update) {
        await (0, pgClient_1.ensurePgConnected)();
        const pgClient = (0, pgClient_1.getPgClient)();
        if (!pgClient) {
            throw new Error('PostgreSQL 클라이언트가 초기화되지 않았습니다.');
        }
        const setClauses = [];
        const values = [];
        let paramIndex = 1;
        if (update.status !== undefined) {
            setClauses.push(`status = $${paramIndex++}`);
            values.push(update.status);
        }
        if (update.executedBy !== undefined) {
            setClauses.push(`executed_by = $${paramIndex++}`);
            values.push(update.executedBy);
        }
        if (update.executedAt !== undefined) {
            setClauses.push(`executed_at = $${paramIndex++}`);
            values.push(update.executedAt);
        }
        if (update.comment !== undefined) {
            setClauses.push(`comments = $${paramIndex++}`);
            values.push(update.comment);
        }
        if (setClauses.length === 0)
            return this.findById(id);
        setClauses.push(`updated_at = $${paramIndex++}`);
        values.push(new Date());
        values.push(id);
        const result = await pgClient.query(`UPDATE executions SET ${setClauses.join(', ')} WHERE id = $${paramIndex} RETURNING *`, values);
        return result.rows[0] ? mapRowToExecution(result.rows[0]) : null;
    },
    async delete(id) {
        await (0, pgClient_1.ensurePgConnected)();
        const pgClient = (0, pgClient_1.getPgClient)();
        if (!pgClient) {
            throw new Error('PostgreSQL 클라이언트가 초기화되지 않았습니다.');
        }
        await pgClient.query('DELETE FROM executions WHERE id = $1', [id]);
    }
};
function mapRowToExecution(row) {
    return {
        id: row.id,
        testcaseId: row.testcase_id,
        releaseId: row.release_id,
        status: row.status,
        executedBy: row.executed_by,
        executedAt: row.executed_at,
        comment: row.comments,
        createdAt: row.created_at,
        updatedAt: row.updated_at
    };
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzLzNpLWExLTIwMjEtMDE3L0RvY3VtZW50cy9xdWVzdC9EZXNrdG9wL3F1ZXN0L3NyYy9tYWluL2FwcC9kb21haW5zL2V4ZWN1dGlvbnMvcmVwb3NpdG9yaWVzL2V4ZWN1dGlvblJlcG9zaXRvcnkudHMiLCJtYXBwaW5ncyI6Ijs7O0FBQ0Esd0VBQTJGO0FBRTlFLFFBQUEsbUJBQW1CLEdBQUc7SUFDL0IsS0FBSyxDQUFDLE1BQU0sQ0FBQyxTQUE0RDtRQUNyRSxNQUFNLElBQUEsNEJBQWlCLEdBQUUsQ0FBQztRQUMxQixNQUFNLFFBQVEsR0FBRyxJQUFBLHNCQUFXLEdBQUUsQ0FBQztRQUMvQixJQUFJLENBQUMsUUFBUSxFQUFFLENBQUM7WUFDWixNQUFNLElBQUksS0FBSyxDQUFDLGdDQUFnQyxDQUFDLENBQUM7UUFDdEQsQ0FBQztRQUNELE1BQU0sR0FBRyxHQUFHLElBQUksSUFBSSxFQUFFLENBQUM7UUFFdkIsT0FBTyxDQUFDLEdBQUcsQ0FBQyxzQkFBc0IsRUFBRSxTQUFTLENBQUMsQ0FBQztRQUUvQyxNQUFNLEdBQUcsR0FBRzs7O3FCQUdDLENBQUM7UUFFZCxNQUFNLE1BQU0sR0FBRztZQUNYLFNBQVMsQ0FBQyxVQUFVO1lBQ3BCLFNBQVMsQ0FBQyxTQUFTO1lBQ25CLFNBQVMsQ0FBQyxNQUFNO1lBQ2hCLFNBQVMsQ0FBQyxVQUFVO1lBQ3BCLFNBQVMsQ0FBQyxVQUFVO1lBQ3BCLFNBQVMsQ0FBQyxPQUFPLElBQUksSUFBSTtZQUN6QixHQUFHO1lBQ0gsR0FBRztTQUNOLENBQUM7UUFFRixPQUFPLENBQUMsR0FBRyxDQUFDLGdCQUFnQixFQUFFLEdBQUcsQ0FBQyxDQUFDO1FBQ25DLE9BQU8sQ0FBQyxHQUFHLENBQUMsY0FBYyxFQUFFLE1BQU0sQ0FBQyxDQUFDO1FBRXBDLE1BQU0sTUFBTSxHQUFHLE1BQU0sUUFBUSxDQUFDLEtBQUssQ0FBQyxHQUFHLEVBQUUsTUFBTSxDQUFDLENBQUM7UUFDakQsT0FBTyxpQkFBaUIsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFD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LEVBQUUsR0FBRyxDQUFDLFdBQVc7UUFDM0IsT0FBTyxFQUFFLEdBQUcsQ0FBQyxRQUFRO1FBQ3JCLFNBQVMsRUFBRSxHQUFHLENBQUMsVUFBVTtRQUN6QixTQUFTLEVBQUUsR0FBRyxDQUFDLFVBQVU7S0FDNUIsQ0FBQztBQUNOLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL1VzZXJzLzNpLWExLTIwMjEtMDE3L0RvY3VtZW50cy9xdWVzdC9EZXNrdG9wL3F1ZXN0L3NyYy9tYWluL2FwcC9kb21haW5zL2V4ZWN1dGlvbnMvcmVwb3NpdG9yaWVzL2V4ZWN1dGlvblJlcG9zaXRvcnkudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRXhlY3V0aW9uIH0gZnJvbSAnLi4vdHlwZXMnO1xuaW1wb3J0IHsgZ2V0UGdDbGllbnQsIGVuc3VyZVBnQ29ubmVjdGVkIH0gZnJvbSAnLi4vLi4vLi4vaW5mcmFzdHJ1Y3R1cmUvZGF0YWJhc2UvcGdDbGllbnQnO1xuXG5leHBvcnQgY29uc3QgZXhlY3V0aW9uUmVwb3NpdG9yeSA9IHtcbiAgICBhc3luYyBpbnNlcnQoZXhlY3V0aW9uOiBPbWl0PEV4ZWN1dGlvbiwgJ2lkJyB8ICdjcmVhdGVkQXQnIHwgJ3VwZGF0ZWRBdCc+KTogUHJvbWlzZTxFeGVjdXRpb24+IHtcbiAgICAgICAgYXdhaXQgZW5zdXJlUGdDb25uZWN0ZWQoKTtcbiAgICAgICAgY29uc3QgcGdDbGllbnQgPSBnZXRQZ0NsaWVudCgpO1xuICAgICAgICBpZiAoIXBnQ2xpZW50KSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1Bvc3RncmVTUUwg7YG065287J207Ja47Yq46rCAIOy0iOq4sO2ZlOuQmOyngCDslYrslZjsirXri4jri6QuJyk7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3Qgbm93ID0gbmV3IERhdGUoKTtcbiAgICAgICAgXG4gICAgICAgIGNvbnNvbGUubG9nKCdJbnNlcnRpbmcgZXhlY3V0aW9uOicsIGV4ZWN1dGlvbik7XG4gICAgICAgIFxuICAgICAgICBjb25zdCBzcWwgPSBgSU5TRVJUIElOVE8gZXhlY3V0aW9ucyBcbiAgICAgICAgICAgICh0ZXN0Y2FzZV9pZCwgcmVsZWFzZV9pZCwgc3RhdHVzLCBleGVjdXRlZF9ieSwgZXhlY3V0ZWRfYXQsIGNvbW1lbnRzLCBjcmVhdGVkX2F0LCB1cGRhdGVkX2F0KVxuICAgICAgICAgVkFMVUVTICgkMSwgJDIsICQzLCAkNCwgJDUsICQ2LCAkNywgJDgpXG4gICAgICAgICBSRVRVUk5JTkcgKmA7XG4gICAgICAgIFxuICAgICAgICBjb25zdCBwYXJhbXMgPSBbXG4gICAgICAgICAgICBleGVjdXRpb24udGVzdGNhc2VJZCxcbiAgICAgICAgICAgIGV4ZWN1dGlvbi5yZWxlYXNlSWQsXG4gICAgICAgICAgICBleGVjdXRpb24uc3RhdHVzLFxuICAgICAgICAgICAgZXhlY3V0aW9uLmV4ZWN1dGVkQnksXG4gICAgICAgICAgICBleGVjdXRpb24uZXhlY3V0ZWRBdCxcbiAgICAgICAgICAgIGV4ZWN1dGlvbi5jb21tZW50IHx8IG51bGwsXG4gICAgICAgICAgICBub3csXG4gICAgICAgICAgICBub3dcbiAgICAgICAgXTtcbiAgICAgICAgXG4gICAgICAgIGNvbnNvbGUubG9nKCdFeGVjdXRpbmcgU1FMOicsIHNxbCk7XG4gICAgICAgIGNvbnNvbGUubG9nKCdXaXRoIHBhcmFtczonLCBwYXJhbXMpO1xuICAgICAgICBcbiAgICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgcGdDbGllbnQucXVlcnkoc3FsLCBwYXJhbXMpO1xuICAgICAgICByZXR1cm4gbWFwUm93VG9FeGVjdXRpb24ocmVzdWx0LnJvd3NbMF0pO1xuICAgIH0sXG5cbiAgICBhc3luYyBmaW5kQnlJZChpZDogbnVtYmVyKTogUHJvbWlzZTxFeGVjdXRpb24gfCBudWxsPiB7XG4gICAgICAgIGF3YWl0IGVuc3VyZVBnQ29ubmVjdGVkKCk7XG4gICAgICAgIGNvbnN0IHBnQ2xpZW50ID0gZ2V0UGdDbGllbnQoKTtcbiAgICAgICAgaWYgKCFwZ0NsaWVudCkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdQb3N0Z3JlU1FMIO2BtOudvOydtOyWuO2KuOqwgCDstIjquLDtmZTrkJjsp4Ag7JWK7JWY7Iq164uI64ukLicpO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHBnQ2xpZW50LnF1ZXJ5KCdTRUxFQ1QgKiBGUk9NIGV4ZWN1dGlvbnMgV0hFUkUgaWQgPSAkMScsIFtpZF0pO1xuICAgICAgICByZXR1cm4gcmVzdWx0LnJvd3NbMF0gPyBtYXBSb3dUb0V4ZWN1dGlvbihyZXN1bHQucm93c1swXSkgOiBudWxsO1xuICAgIH0sXG5cbiAgICBhc3luYyBmaW5kQnlUZXN0Q2FzZSh0ZXN0Y2FzZUlkOiBudW1iZXIpOiBQcm9taXNlPEV4ZWN1dGlvbltdPiB7XG4gICAgICAgIGF3YWl0IGVuc3VyZVBnQ29ubmVjdGVkKCk7XG4gICAgICAgIGNvbnN0IHBnQ2xpZW50ID0gZ2V0UGdDbGllbnQoKTtcbiAgICAgICAgaWYgKCFwZ0NsaWVudCkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdQb3N0Z3JlU1FMIO2BtOudvOydtOyWuO2KuOqwgCDstIjquLDtmZTrkJjsp4Ag7JWK7JWY7Iq164uI64ukLicpO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHBnQ2xpZW50LnF1ZXJ5KCdTRUxFQ1QgKiBGUk9NIGV4ZWN1dGlvbnMgV0hFUkUgdGVzdGNhc2VfaWQgPSAkMScsIFt0ZXN0Y2FzZUlkXSk7XG4gICAgICAgIHJldHVybiByZXN1bHQucm93cy5tYXAobWFwUm93VG9FeGVjdXRpb24pO1xuICAgIH0sXG5cbiAgICBhc3luYyB1cGRhdGUoaWQ6IG51bWJlciwgdXBkYXRlOiBQYXJ0aWFsPE9taXQ8RXhlY3V0aW9uLCAnaWQnIHwgJ2NyZWF0ZWRBdCc+Pik6IFByb21pc2U8RXhlY3V0aW9uIHwgbnVsbD4ge1xuICAgICAgICBhd2FpdCBlbnN1cmVQZ0Nvbm5lY3RlZCgpO1xuICAgICAgICBjb25zdCBwZ0NsaWVudCA9IGdldFBnQ2xpZW50KCk7XG4gICAgICAgIGlmICghcGdDbGllbnQpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignUG9zdGdyZVNRTCDtgbTrnbzsnbTslrjtirjqsIAg7LSI6riw7ZmU65CY7KeAIOyViuyVmOyKteuLiOuLpC4nKTtcbiAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgY29uc3Qgc2V0Q2xhdXNlczogc3RyaW5nW10gPSBbXTtcbiAgICAgICAgY29uc3QgdmFsdWVzOiBhbnlbXSA9IFtdO1xuICAgICAgICBsZXQgcGFyYW1JbmRleCA9IDE7XG4gICAgICAgIFxuICAgICAgICBpZiAodXBkYXRlLnN0YXR1cyAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICBzZXRDbGF1c2VzLnB1c2goYHN0YXR1cyA9ICQke3BhcmFtSW5kZXgrK31gKTtcbiAgICAgICAgICAgIHZhbHVlcy5wdXNoKHVwZGF0ZS5zdGF0dXMpO1xuICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICBpZiAodXBkYXRlLmV4ZWN1dGVkQnkgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgc2V0Q2xhdXNlcy5wdXNoKGBleGVjdXRlZF9ieSA9ICQke3BhcmFtSW5kZXgrK31gKTtcbiAgICAgICAgICAgIHZhbHVlcy5wdXNoKHVwZGF0ZS5leGVjdXRlZEJ5KTtcbiAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgaWYgKHVwZGF0ZS5leGVjdXRlZEF0ICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgIHNldENsYXVzZXMucHVzaChgZXhlY3V0ZWRfYXQgPSAkJHtwYXJhbUluZGV4Kyt9YCk7XG4gICAgICAgICAgICB2YWx1ZXMucHVzaCh1cGRhdGUuZXhlY3V0ZWRBdCk7XG4gICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgIGlmICh1cGRhdGUuY29tbWVudCAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICBzZXRDbGF1c2VzLnB1c2goYGNvbW1lbnRzID0gJCR7cGFyYW1JbmRleCsrfWApO1xuICAgICAgICAgICAgdmFsdWVzLnB1c2godXBkYXRlLmNvbW1lbnQpO1xuICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICBpZiAoc2V0Q2xhdXNlcy5sZW5ndGggPT09IDApIHJldHVybiB0aGlzLmZpbmRCeUlkKGlkKTtcbiAgICAgICAgXG4gICAgICAgIHNldENsYXVzZXMucHVzaChgdXBkYXRlZF9hdCA9ICQke3BhcmFtSW5kZXgrK31gKTtcbiAgICAgICAgdmFsdWVzLnB1c2gobmV3IERhdGUoKSk7XG4gICAgICAgIHZhbHVlcy5wdXNoKGlkKTtcbiAgICAgICAgXG4gICAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHBnQ2xpZW50LnF1ZXJ5KFxuICAgICAgICAgICAgYFVQREFURSBleGVjdXRpb25zIFNFVCAke3NldENsYXVzZXMuam9pbignLCAnKX0gV0hFUkUgaWQgPSAkJHtwYXJhbUluZGV4fSBSRVRVUk5JTkcgKmAsXG4gICAgICAgICAgICB2YWx1ZXNcbiAgICAgICAgKTtcbiAgICAgICAgcmV0dXJuIHJlc3VsdC5yb3dzWzBdID8gbWFwUm93VG9FeGVjdXRpb24ocmVzdWx0LnJvd3NbMF0pIDogbnVsbDtcbiAgICB9LFxuXG4gICAgYXN5bmMgZGVsZXRlKGlkOiBudW1iZXIpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAgICAgYXdhaXQgZW5zdXJlUGdDb25uZWN0ZWQoKTtcbiAgICAgICAgY29uc3QgcGdDbGllbnQgPSBnZXRQZ0NsaWVudCgpO1xuICAgICAgICBpZiAoIXBnQ2xpZW50KSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1Bvc3RncmVTUUwg7YG065287J207Ja47Yq46rCAIOy0iOq4sO2ZlOuQmOyngCDslYrslZjsirXri4jri6QuJyk7XG4gICAgICAgIH1cbiAgICAgICAgYXdhaXQgcGdDbGllbnQucXVlcnkoJ0RFTEVURSBGUk9NIGV4ZWN1dGlvbnMgV0hFUkUgaWQgPSAkMScsIFtpZF0pO1xuICAgIH1cbn07XG5cbmZ1bmN0aW9uIG1hcFJvd1RvRXhlY3V0aW9uKHJvdzogYW55KTogRXhlY3V0aW9uIHtcbiAgICByZXR1cm4ge1xuICAgICAgICBpZDogcm93LmlkLFxuICAgICAgICB0ZXN0Y2FzZUlkOiByb3cudGVzdGNhc2VfaWQsXG4gICAgICAgIHJlbGVhc2VJZDogcm93LnJlbGVhc2VfaWQsXG4gICAgICAgIHN0YXR1czogcm93LnN0YXR1cyxcbiAgICAgICAgZXhlY3V0ZWRCeTogcm93LmV4ZWN1dGVkX2J5LFxuICAgICAgICBleGVjdXRlZEF0OiByb3cuZXhlY3V0ZWRfYXQsXG4gICAgICAgIGNvbW1lbnQ6IHJvdy5jb21tZW50cyxcbiAgICAgICAgY3JlYXRlZEF0OiByb3cuY3JlYXRlZF9hdCxcbiAgICAgICAgdXBkYXRlZEF0OiByb3cudXBkYXRlZF9hdFxuICAgIH07XG59Il0sInZlcnNpb24iOjN9