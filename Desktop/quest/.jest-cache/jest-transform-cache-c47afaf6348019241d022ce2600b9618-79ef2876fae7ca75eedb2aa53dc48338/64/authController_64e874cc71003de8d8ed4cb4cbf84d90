8671c707af76f431d9085368294bada9
"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const express_1 = require("express");
const passport_1 = __importDefault(require("../../../infrastructure/security/passport"));
const jsonwebtoken_1 = __importDefault(require("jsonwebtoken"));
const userService_1 = require("../services/userService");
/**
 * @swagger
 * components:
 *   schemas:
 *     User:
 *       type: object
 *       properties:
 *         id:
 *           type: integer
 *           description: ÏÇ¨Ïö©Ïûê ID
 *         username:
 *           type: string
 *           description: ÏÇ¨Ïö©ÏûêÎ™Ö (Ïù¥Î©îÏùº)
 *         role:
 *           type: string
 *           enum: [ADMIN, QA, DEV, PM]
 *           description: ÏÇ¨Ïö©Ïûê Ïó≠Ìï†
 *     LoginRequest:
 *       type: object
 *       required:
 *         - email
 *         - password
 *       properties:
 *         email:
 *           type: string
 *           format: email
 *           description: ÏÇ¨Ïö©Ïûê Ïù¥Î©îÏùº
 *         password:
 *           type: string
 *           description: ÎπÑÎ∞ÄÎ≤àÌò∏
 *     LoginResponse:
 *       type: object
 *       properties:
 *         token:
 *           type: string
 *           description: JWT ÌÜ†ÌÅ∞
 *         user:
 *           $ref: '#/components/schemas/User'
 *     RegisterRequest:
 *       type: object
 *       required:
 *         - username
 *         - password
 *         - role
 *       properties:
 *         username:
 *           type: string
 *           description: ÏÇ¨Ïö©ÏûêÎ™Ö (Ïù¥Î©îÏùº)
 *         password:
 *           type: string
 *           description: ÎπÑÎ∞ÄÎ≤àÌò∏
 *         role:
 *           type: string
 *           enum: [ADMIN, QA, DEV, PM]
 *           description: ÏÇ¨Ïö©Ïûê Ïó≠Ìï†
 */
const router = (0, express_1.Router)();
const JWT_SECRET = process.env.JWT_SECRET || 'dev_secret';
// Í∞úÎ∞ú ÌôòÍ≤ΩÏóêÏÑúÎäî 24ÏãúÍ∞Ñ, ÌîÑÎ°úÎçïÏÖòÏóêÏÑúÎäî 1ÏãúÍ∞Ñ
const JWT_EXPIRES_IN = process.env.NODE_ENV === 'production' ? '1h' : '24h';
/**
 * @swagger
 * /api/auth/register:
 *   post:
 *     summary: ÏÇ¨Ïö©Ïûê Îì±Î°ù
 *     description: ÏÉàÎ°úÏö¥ ÏÇ¨Ïö©ÏûêÎ•º Îì±Î°ùÌï©ÎãàÎã§.
 *     tags: [Authentication]
 *     requestBody:
 *       required: true
 *       content:
 *         application/json:
 *           schema:
 *             $ref: '#/components/schemas/RegisterRequest'
 *     responses:
 *       201:
 *         description: ÏÇ¨Ïö©Ïûê Îì±Î°ù ÏÑ±Í≥µ
 *         content:
 *           application/json:
 *             schema:
 *               $ref: '#/components/schemas/User'
 *       400:
 *         description: ÏûòÎ™ªÎêú ÏöîÏ≤≠
 *         content:
 *           application/json:
 *             schema:
 *               type: object
 *               properties:
 *                 message:
 *                   type: string
 *       409:
 *         description: ÏÇ¨Ïö©ÏûêÎ™Ö Ï§ëÎ≥µ
 *         content:
 *           application/json:
 *             schema:
 *               type: object
 *               properties:
 *                 message:
 *                   type: string
 */
router.post('/register', async (req, res) => {
    const { username, password, role } = req.body;
    if (!username || !password || !role) {
        return res.status(400).json({ message: 'ÌïÑÏàò ÏûÖÎ†•Í∞í ÎàÑÎùΩ' });
    }
    if (!['ADMIN', 'QA', 'DEV', 'PM'].includes(role)) {
        return res.status(400).json({ message: 'Ïú†Ìö®ÌïòÏßÄ ÏïäÏùÄ Ïó≠Ìï†' });
    }
    const existing = await (0, userService_1.findUserByUsername)(username);
    if (existing) {
        return res.status(409).json({ message: 'Ïù¥ÎØ∏ Ï°¥Ïû¨ÌïòÎäî ÏÇ¨Ïö©ÏûêÎ™Ö' });
    }
    const user = await (0, userService_1.createUser)(username, password, role);
    res.status(201).json({ id: user.id, username: user.username, role: user.role });
});
/**
 * @swagger
 * /api/auth/login:
 *   post:
 *     summary: ÏÇ¨Ïö©Ïûê Î°úÍ∑∏Ïù∏
 *     description: ÏÇ¨Ïö©Ïûê Ïù∏Ï¶ù ÌõÑ JWT ÌÜ†ÌÅ∞ÏùÑ Î∞òÌôòÌï©ÎãàÎã§.
 *     tags: [Authentication]
 *     requestBody:
 *       required: true
 *       content:
 *         application/json:
 *           schema:
 *             $ref: '#/components/schemas/LoginRequest'
 *     responses:
 *       200:
 *         description: Î°úÍ∑∏Ïù∏ ÏÑ±Í≥µ
 *         content:
 *           application/json:
 *             schema:
 *               $ref: '#/components/schemas/LoginResponse'
 *       401:
 *         description: Ïù∏Ï¶ù Ïã§Ìå®
 *         content:
 *           application/json:
 *             schema:
 *               type: object
 *               properties:
 *                 message:
 *                   type: string
 */
router.post('/login', (req, res, next) => {
    console.log('üîê Î°úÍ∑∏Ïù∏ ÏöîÏ≤≠ Î∞õÏùå');
    console.log('üì• ÏöîÏ≤≠ Î≥∏Î¨∏:', req.body);
    console.log('üì• ÏöîÏ≤≠ Ìó§Îçî:', req.headers);
    passport_1.default.authenticate('local', { session: false }, (err, user, info) => {
        if (err) {
            console.log('‚ùå Ïù∏Ï¶ù Ïò§Î•ò:', err);
            return next(err);
        }
        if (!user) {
            console.log('‚ùå Ïù∏Ï¶ù Ïã§Ìå®:', info?.message || 'ÏÇ¨Ïö©ÏûêÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏùå');
            return res.status(401).json({ message: info?.message || 'Ïù∏Ï¶ù Ïã§Ìå®' });
        }
        console.log('‚úÖ Ïù∏Ï¶ù ÏÑ±Í≥µ:', user.username);
        const token = jsonwebtoken_1.default.sign({ id: user.id, username: user.username, role: user.role }, JWT_SECRET, { expiresIn: JWT_EXPIRES_IN });
        const response = { token, user: { id: user.id, username: user.username, role: user.role } };
        console.log('üì§ ÏùëÎãµ Îç∞Ïù¥ÌÑ∞:', response);
        res.json(response);
    })(req, res, next);
});
exports.default = router;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzLzNpLWExLTIwMjEtMDE3L0RvY3VtZW50cy9xdWVzdC9EZXNrdG9wL3F1ZXN0L3NyYy9tYWluL2FwcC9kb21haW5zL3VzZXJzL2NvbnRyb2xsZXJzL2F1dGhDb250cm9sbGVyLnRzIiwibWFwcGluZ3MiOiI7Ozs7O0FBQUEscUNBQWlDO0FBQ2pDLHlGQUFpRTtBQUNqRSxnRUFBK0I7QUFDL0IseURBQXlFO0FBR3pFOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0dBdURHO0FBRUgsTUFBTSxNQUFNLEdBQUcsSUFBQSxnQkFBTSxHQUFFLENBQUM7QUFDeEIsTUFBTSxVQUFVLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxVQUFVLElBQUksWUFBWSxDQUFDO0FBRTFELDZCQUE2QjtBQUM3QixNQUFNLGNBQWMsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLFFBQVEsS0FBSyxZQUFZLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDO0FBRTVFOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztHQXNDRztBQUNILE1BQU0sQ0FBQyxJQUFJLENBQUMsV0FBVyxFQUFFLEtBQUssRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEVBQUU7SUFDeEMsTUFBTSxFQUFFLFFBQVEsRUFBRSxRQUFRLEVBQUUsSUFBSSxFQUFFLEdBQUcsR0FBRyxDQUFDLElBQUksQ0FBQztJQUM5QyxJQUFJLENBQUMsUUFBUSxJQUFJLENBQUMsUUFBUSxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUM7UUFDbEMsT0FBTyxHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxFQUFFLE9BQU8sRUFBRSxXQUFXLEVBQUUsQ0FBQyxDQUFDO0lBQzFELENBQUM7SUFDRCxJQUFJLENBQUMsQ0FBQyxPQUFPLEVBQUUsSUFBSSxFQUFFLEtBQUssRUFBRSxJQUFJLENBQUMsQ0FBQyxRQUFRLENBQUMsSUFB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RyxFQUFFLEdBQUcsRUFBRSxJQUFJLENBQUMsQ0FBQztBQUN2QixDQUFDLENBQUMsQ0FBQztBQUVILGtCQUFlLE1BQU0sQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvVXNlcnMvM2ktYTEtMjAyMS0wMTcvRG9jdW1lbnRzL3F1ZXN0L0Rlc2t0b3AvcXVlc3Qvc3JjL21haW4vYXBwL2RvbWFpbnMvdXNlcnMvY29udHJvbGxlcnMvYXV0aENvbnRyb2xsZXIudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgUm91dGVyIH0gZnJvbSAnZXhwcmVzcyc7XG5pbXBvcnQgcGFzc3BvcnQgZnJvbSAnLi4vLi4vLi4vaW5mcmFzdHJ1Y3R1cmUvc2VjdXJpdHkvcGFzc3BvcnQnO1xuaW1wb3J0IGp3dCBmcm9tICdqc29ud2VidG9rZW4nO1xuaW1wb3J0IHsgY3JlYXRlVXNlciwgZmluZFVzZXJCeVVzZXJuYW1lIH0gZnJvbSAnLi4vc2VydmljZXMvdXNlclNlcnZpY2UnO1xuaW1wb3J0IHsgVXNlclJvbGUgfSBmcm9tICcuLi90eXBlcyc7XG5cbi8qKlxuICogQHN3YWdnZXJcbiAqIGNvbXBvbmVudHM6XG4gKiAgIHNjaGVtYXM6XG4gKiAgICAgVXNlcjpcbiAqICAgICAgIHR5cGU6IG9iamVjdFxuICogICAgICAgcHJvcGVydGllczpcbiAqICAgICAgICAgaWQ6XG4gKiAgICAgICAgICAgdHlwZTogaW50ZWdlclxuICogICAgICAgICAgIGRlc2NyaXB0aW9uOiDsgqzsmqnsnpAgSURcbiAqICAgICAgICAgdXNlcm5hbWU6XG4gKiAgICAgICAgICAgdHlwZTogc3RyaW5nXG4gKiAgICAgICAgICAgZGVzY3JpcHRpb246IOyCrOyaqeyekOuqhSAo7J2066mU7J28KVxuICogICAgICAgICByb2xlOlxuICogICAgICAgICAgIHR5cGU6IHN0cmluZ1xuICogICAgICAgICAgIGVudW06IFtBRE1JTiwgUUEsIERFViwgUE1dXG4gKiAgICAgICAgICAgZGVzY3JpcHRpb246IOyCrOyaqeyekCDsl63tlaBcbiAqICAgICBMb2dpblJlcXVlc3Q6XG4gKiAgICAgICB0eXBlOiBvYmplY3RcbiAqICAgICAgIHJlcXVpcmVkOlxuICogICAgICAgICAtIGVtYWlsXG4gKiAgICAgICAgIC0gcGFzc3dvcmRcbiAqICAgICAgIHByb3BlcnRpZXM6XG4gKiAgICAgICAgIGVtYWlsOlxuICogICAgICAgICAgIHR5cGU6IHN0cmluZ1xuICogICAgICAgICAgIGZvcm1hdDogZW1haWxcbiAqICAgICAgICAgICBkZXNjcmlwdGlvbjog7IKs7Jqp7J6QIOydtOuplOydvFxuICogICAgICAgICBwYXNzd29yZDpcbiAqICAgICAgICAgICB0eXBlOiBzdHJpbmdcbiAqICAgICAgICAgICBkZXNjcmlwdGlvbjog67mE67CA67KI7Zi4XG4gKiAgICAgTG9naW5SZXNwb25zZTpcbiAqICAgICAgIHR5cGU6IG9iamVjdFxuICogICAgICAgcHJvcGVydGllczpcbiAqICAgICAgICAgdG9rZW46XG4gKiAgICAgICAgICAgdHlwZTogc3RyaW5nXG4gKiAgICAgICAgICAgZGVzY3JpcHRpb246IEpXVCDthqDtgbBcbiAqICAgICAgICAgdXNlcjpcbiAqICAgICAgICAgICAkcmVmOiAnIy9jb21wb25lbnRzL3NjaGVtYXMvVXNlcidcbiAqICAgICBSZWdpc3RlclJlcXVlc3Q6XG4gKiAgICAgICB0eXBlOiBvYmplY3RcbiAqICAgICAgIHJlcXVpcmVkOlxuICogICAgICAgICAtIHVzZXJuYW1lXG4gKiAgICAgICAgIC0gcGFzc3dvcmRcbiAqICAgICAgICAgLSByb2xlXG4gKiAgICAgICBwcm9wZXJ0aWVzOlxuICogICAgICAgICB1c2VybmFtZTpcbiAqICAgICAgICAgICB0eXBlOiBzdHJpbmdcbiAqICAgICAgICAgICBkZXNjcmlwdGlvbjog7IKs7Jqp7J6Q66qFICjsnbTrqZTsnbwpXG4gKiAgICAgICAgIHBhc3N3b3JkOlxuICogICAgICAgICAgIHR5cGU6IHN0cmluZ1xuICogICAgICAgICAgIGRlc2NyaXB0aW9uOiDruYTrsIDrsojtmLhcbiAqICAgICAgICAgcm9sZTpcbiAqICAgICAgICAgICB0eXBlOiBzdHJpbmdcbiAqICAgICAgICAgICBlbnVtOiBbQURNSU4sIFFBLCBERVYsIFBNXVxuICogICAgICAgICAgIGRlc2NyaXB0aW9uOiDsgqzsmqnsnpAg7Jet7ZWgXG4gKi9cblxuY29uc3Qgcm91dGVyID0gUm91dGVyKCk7XG5jb25zdCBKV1RfU0VDUkVUID0gcHJvY2Vzcy5lbnYuSldUX1NFQ1JFVCB8fCAnZGV2X3NlY3JldCc7XG5cbi8vIOqwnOuwnCDtmZjqsr3sl5DshJzripQgMjTsi5zqsIQsIO2UhOuhnOuNleyFmOyXkOyEnOuKlCAx7Iuc6rCEXG5jb25zdCBKV1RfRVhQSVJFU19JTiA9IHByb2Nlc3MuZW52Lk5PREVfRU5WID09PSAncHJvZHVjdGlvbicgPyAnMWgnIDogJzI0aCc7XG5cbi8qKlxuICogQHN3YWdnZXJcbiAqIC9hcGkvYXV0aC9yZWdpc3RlcjpcbiAqICAgcG9zdDpcbiAqICAgICBzdW1tYXJ5OiDsgqzsmqnsnpAg65Ox66GdXG4gKiAgICAgZGVzY3JpcHRpb246IOyDiOuhnOyatCDsgqzsmqnsnpDrpbwg65Ox66Gd7ZWp64uI64ukLlxuICogICAgIHRhZ3M6IFtBdXRoZW50aWNhdGlvbl1cbiAqICAgICByZXF1ZXN0Qm9keTpcbiAqICAgICAgIHJlcXVpcmVkOiB0cnVlXG4gKiAgICAgICBjb250ZW50OlxuICogICAgICAgICBhcHBsaWNhdGlvbi9qc29uOlxuICogICAgICAgICAgIHNjaGVtYTpcbiAqICAgICAgICAgICAgICRyZWY6ICcjL2NvbXBvbmVudHMvc2NoZW1hcy9SZWdpc3RlclJlcXVlc3QnXG4gKiAgICAgcmVzcG9uc2VzOlxuICogICAgICAgMjAxOlxuICogICAgICAgICBkZXNjcmlwdGlvbjog7IKs7Jqp7J6QIOuTseuhnSDshLHqs7VcbiAqICAgICAgICAgY29udGVudDpcbiAqICAgICAgICAgICBhcHBsaWNhdGlvbi9qc29uOlxuICogICAgICAgICAgICAgc2NoZW1hOlxuICogICAgICAgICAgICAgICAkcmVmOiAnIy9jb21wb25lbnRzL3NjaGVtYXMvVXNlcidcbiAqICAgICAgIDQwMDpcbiAqICAgICAgICAgZGVzY3JpcHRpb246IOyemOuqu+uQnCDsmpTssq1cbiAqICAgICAgICAgY29udGVudDpcbiAqICAgICAgICAgICBhcHBsaWNhdGlvbi9qc29uOlxuICogICAgICAgICAgICAgc2NoZW1hOlxuICogICAgICAgICAgICAgICB0eXBlOiBvYmplY3RcbiAqICAgICAgICAgICAgICAgcHJvcGVydGllczpcbiAqICAgICAgICAgICAgICAgICBtZXNzYWdlOlxuICogICAgICAgICAgICAgICAgICAgdHlwZTogc3RyaW5nXG4gKiAgICAgICA0MDk6XG4gKiAgICAgICAgIGRlc2NyaXB0aW9uOiDsgqzsmqnsnpDrqoUg7KSR67O1XG4gKiAgICAgICAgIGNvbnRlbnQ6XG4gKiAgICAgICAgICAgYXBwbGljYXRpb24vanNvbjpcbiAqICAgICAgICAgICAgIHNjaGVtYTpcbiAqICAgICAgICAgICAgICAgdHlwZTogb2JqZWN0XG4gKiAgICAgICAgICAgICAgIHByb3BlcnRpZXM6XG4gKiAgICAgICAgICAgICAgICAgbWVzc2FnZTpcbiAqICAgICAgICAgICAgICAgICAgIHR5cGU6IHN0cmluZ1xuICovXG5yb3V0ZXIucG9zdCgnL3JlZ2lzdGVyJywgYXN5bmMgKHJlcSwgcmVzKSA9PiB7XG4gICAgY29uc3QgeyB1c2VybmFtZSwgcGFzc3dvcmQsIHJvbGUgfSA9IHJlcS5ib2R5O1xuICAgIGlmICghdXNlcm5hbWUgfHwgIXBhc3N3b3JkIHx8ICFyb2xlKSB7XG4gICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMCkuanNvbih7IG1lc3NhZ2U6ICftlYTsiJgg7J6F66Cl6rCSIOuIhOudvScgfSk7XG4gICAgfVxuICAgIGlmICghWydBRE1JTicsICdRQScsICdERVYnLCAnUE0nXS5pbmNsdWRlcyhyb2xlKSkge1xuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDApLmpzb24oeyBtZXNzYWdlOiAn7Jyg7Zqo7ZWY7KeAIOyViuydgCDsl63tlaAnIH0pO1xuICAgIH1cbiAgICBjb25zdCBleGlzdGluZyA9IGF3YWl0IGZpbmRVc2VyQnlVc2VybmFtZSh1c2VybmFtZSk7XG4gICAgaWYgKGV4aXN0aW5nKSB7XG4gICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwOSkuanNvbih7IG1lc3NhZ2U6ICfsnbTrr7gg7KG07J6s7ZWY64qUIOyCrOyaqeyekOuqhScgfSk7XG4gICAgfVxuICAgIGNvbnN0IHVzZXIgPSBhd2FpdCBjcmVhdGVVc2VyKHVzZXJuYW1lLCBwYXNzd29yZCwgcm9sZSBhcyBVc2VyUm9sZSk7XG4gICAgcmVzLnN0YXR1cygyMDEpLmpzb24oeyBpZDogdXNlci5pZCwgdXNlcm5hbWU6IHVzZXIudXNlcm5hbWUsIHJvbGU6IHVzZXIucm9sZSB9KTtcbn0pO1xuXG4vKipcbiAqIEBzd2FnZ2VyXG4gKiAvYXBpL2F1dGgvbG9naW46XG4gKiAgIHBvc3Q6XG4gKiAgICAgc3VtbWFyeTog7IKs7Jqp7J6QIOuhnOq3uOyduFxuICogICAgIGRlc2NyaXB0aW9uOiDsgqzsmqnsnpAg7J247KadIO2bhCBKV1Qg7Yag7YGw7J2EIOuwmO2ZmO2VqeuLiOuLpC5cbiAqICAgICB0YWdzOiBbQXV0aGVudGljYXRpb25dXG4gKiAgICAgcmVxdWVzdEJvZHk6XG4gKiAgICAgICByZXF1aXJlZDogdHJ1ZVxuICogICAgICAgY29udGVudDpcbiAqICAgICAgICAgYXBwbGljYXRpb24vanNvbjpcbiAqICAgICAgICAgICBzY2hlbWE6XG4gKiAgICAgICAgICAgICAkcmVmOiAnIy9jb21wb25lbnRzL3NjaGVtYXMvTG9naW5SZXF1ZXN0J1xuICogICAgIHJlc3BvbnNlczpcbiAqICAgICAgIDIwMDpcbiAqICAgICAgICAgZGVzY3JpcHRpb246IOuhnOq3uOyduCDshLHqs7VcbiAqICAgICAgICAgY29udGVudDpcbiAqICAgICAgICAgICBhcHBsaWNhdGlvbi9qc29uOlxuICogICAgICAgICAgICAgc2NoZW1hOlxuICogICAgICAgICAgICAgICAkcmVmOiAnIy9jb21wb25lbnRzL3NjaGVtYXMvTG9naW5SZXNwb25zZSdcbiAqICAgICAgIDQwMTpcbiAqICAgICAgICAgZGVzY3JpcHRpb246IOyduOymnSDsi6TtjKhcbiAqICAgICAgICAgY29udGVudDpcbiAqICAgICAgICAgICBhcHBsaWNhdGlvbi9qc29uOlxuICogICAgICAgICAgICAgc2NoZW1hOlxuICogICAgICAgICAgICAgICB0eXBlOiBvYmplY3RcbiAqICAgICAgICAgICAgICAgcHJvcGVydGllczpcbiAqICAgICAgICAgICAgICAgICBtZXNzYWdlOlxuICogICAgICAgICAgICAgICAgICAgdHlwZTogc3RyaW5nXG4gKi9cbnJvdXRlci5wb3N0KCcvbG9naW4nLCAocmVxLCByZXMsIG5leHQpID0+IHtcbiAgICBjb25zb2xlLmxvZygn8J+UkCDroZzqt7jsnbgg7JqU7LKtIOuwm+ydjCcpO1xuICAgIGNvbnNvbGUubG9nKCfwn5OlIOyalOyyrSDrs7jrrLg6JywgcmVxLmJvZHkpO1xuICAgIGNvbnNvbGUubG9nKCfwn5OlIOyalOyyrSDtl6TrjZQ6JywgcmVxLmhlYWRlcnMpO1xuICAgIFxuICAgIHBhc3Nwb3J0LmF1dGhlbnRpY2F0ZSgnbG9jYWwnLCB7IHNlc3Npb246IGZhbHNlIH0sIChlcnI6IGFueSwgdXNlcjogYW55LCBpbmZvOiBhbnkpID0+IHtcbiAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgICAgY29uc29sZS5sb2coJ+KdjCDsnbjspp0g7Jik66WYOicsIGVycik7XG4gICAgICAgICAgICByZXR1cm4gbmV4dChlcnIpO1xuICAgICAgICB9XG4gICAgICAgIGlmICghdXNlcikge1xuICAgICAgICAgICAgY29uc29sZS5sb2coJ+KdjCDsnbjspp0g7Iuk7YyoOicsIGluZm8/Lm1lc3NhZ2UgfHwgJ+yCrOyaqeyekOulvCDssL7snYQg7IiYIOyXhuydjCcpO1xuICAgICAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAxKS5qc29uKHsgbWVzc2FnZTogaW5mbz8ubWVzc2FnZSB8fCAn7J247KadIOyLpO2MqCcgfSk7XG4gICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgIGNvbnNvbGUubG9nKCfinIUg7J247KadIOyEseqztTonLCB1c2VyLnVzZXJuYW1lKTtcbiAgICAgICAgY29uc3QgdG9rZW4gPSBqd3Quc2lnbih7IGlkOiB1c2VyLmlkLCB1c2VybmFtZTogdXNlci51c2VybmFtZSwgcm9sZTogdXNlci5yb2xlIH0sIEpXVF9TRUNSRVQsIHsgZXhwaXJlc0luOiBKV1RfRVhQSVJFU19JTiB9KTtcbiAgICAgICAgY29uc3QgcmVzcG9uc2UgPSB7IHRva2VuLCB1c2VyOiB7IGlkOiB1c2VyLmlkLCB1c2VybmFtZTogdXNlci51c2VybmFtZSwgcm9sZTogdXNlci5yb2xlIH0gfTtcbiAgICAgICAgY29uc29sZS5sb2coJ/Cfk6Qg7J2R64u1IOuNsOydtO2EsDonLCByZXNwb25zZSk7XG4gICAgICAgIHJlcy5qc29uKHJlc3BvbnNlKTtcbiAgICB9KShyZXEsIHJlcywgbmV4dCk7XG59KTtcblxuZXhwb3J0IGRlZmF1bHQgcm91dGVyOyAiXSwidmVyc2lvbiI6M30=