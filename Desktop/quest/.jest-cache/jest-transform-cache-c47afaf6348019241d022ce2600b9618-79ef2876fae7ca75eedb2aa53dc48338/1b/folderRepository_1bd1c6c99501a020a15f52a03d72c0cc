7d90f5fdfe4ac653f36741f93de17cb7
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.createFolder = createFolder;
exports.getFolderById = getFolderById;
exports.updateFolder = updateFolder;
exports.deleteFolder = deleteFolder;
exports.listFolders = listFolders;
exports.getFolderTree = getFolderTree;
const pgClient_1 = require("../../../infrastructure/database/pgClient");
async function createFolder(data) {
    try {
        const pgClient = (0, pgClient_1.getPgClient)();
        if (!pgClient) {
            throw new Error('PostgreSQL í´ë¼ì´ì–¸íŠ¸ê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
        }
        const result = await pgClient.query(`
            INSERT INTO tree_nodes (name, type, parent_id, sort_order, created_by)
            VALUES ($1, $2, $3, $4, $5)
            RETURNING id, name, type, parent_id, sort_order, created_by, created_at, updated_at
        `, [data.name, 'folder', data.parentId, data.orderIndex, data.createdBy]);
        const row = result.rows[0];
        return {
            id: row.id,
            projectId: data.projectId,
            parentId: row.parent_id,
            name: row.name,
            description: data.description || '',
            orderIndex: row.sort_order,
            depth: data.depth || 0,
            createdBy: row.created_by,
            updatedBy: data.createdBy,
            isLocked: false,
            isArchived: false,
            createdAt: row.created_at,
            updatedAt: row.updated_at
        };
    }
    catch (error) {
        console.error('í´ë” ìƒì„± ì‹¤íŒ¨:', error);
        throw error;
    }
}
async function getFolderById(id) {
    try {
        const pgClient = (0, pgClient_1.getPgClient)();
        if (!pgClient) {
            throw new Error('PostgreSQL í´ë¼ì´ì–¸íŠ¸ê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
        }
        console.log(`ðŸ” í´ë” ì¡°íšŒ ì‹œë„: ID ${id}`);
        // ë¨¼ì € ëª¨ë“  í´ë”ë¥¼ ì¡°íšŒí•´ì„œ ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° í™•ì¸
        const allFolders = await pgClient.query(`
            SELECT id, name, type FROM tree_nodes WHERE type = 'folder' ORDER BY id
        `);
        console.log(`ðŸ” ì „ì²´ í´ë” ìˆ˜: ${allFolders.rows.length}ê°œ`);
        allFolders.rows.forEach(row => {
            console.log(`  - ID: ${row.id}, ì´ë¦„: ${row.name}`);
        });
        const result = await pgClient.query(`
            SELECT id, name, type, parent_id, sort_order, created_by, created_at, updated_at
            FROM tree_nodes 
            WHERE id = $1 AND type = 'folder'
        `, [id]);
        console.log(`ðŸ” ì¿¼ë¦¬ ê²°ê³¼: ${result.rows.length}ê°œ í–‰`);
        if (result.rows.length === 0) {
            console.log(`âŒ í´ë”ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ: ID ${id}`);
            return null;
        }
        const row = result.rows[0];
        console.log(`âœ… í´ë” ì°¾ìŒ: ${row.name} (ID: ${row.id})`);
        return {
            id: row.id,
            projectId: 1, // ê¸°ë³¸ê°’
            parentId: row.parent_id,
            name: row.name,
            description: '',
            orderIndex: row.sort_order,
            depth: 0, // ê¸°ë³¸ê°’
            createdBy: row.created_by,
            updatedBy: row.created_by,
            isLocked: false,
            isArchived: false,
            createdAt: row.created_at,
            updatedAt: row.updated_at
        };
    }
    catch (error) {
        console.error('í´ë” ì¡°íšŒ ì‹¤íŒ¨:', error);
        return null;
    }
}
async function updateFolder(id, data) {
    try {
        const pgClient = (0, pgClient_1.getPgClient)();
        if (!pgClient) {
            throw new Error('PostgreSQL í´ë¼ì´ì–¸íŠ¸ê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
        }
        // ì—…ë°ì´íŠ¸í•  í•„ë“œë“¤ì„ ë™ì ìœ¼ë¡œ êµ¬ì„±
        const updateFields = [];
        const queryParams = [];
        let paramIndex = 1;
        if (data.name !== undefined) {
            updateFields.push(`name = $${paramIndex}`);
            queryParams.push(data.name);
            paramIndex++;
        }
        if (data.parentId !== undefined) {
            updateFields.push(`parent_id = $${paramIndex}`);
            queryParams.push(data.parentId);
            paramIndex++;
        }
        if (data.orderIndex !== undefined) {
            updateFields.push(`sort_order = $${paramIndex}`);
            queryParams.push(data.orderIndex);
            paramIndex++;
        }
        updateFields.push(`updated_at = NOW()`);
        const result = await pgClient.query(`
            UPDATE tree_nodes 
            SET ${updateFields.join(', ')}
            WHERE id = $${paramIndex} AND type = 'folder'
            RETURNING id, name, type, parent_id, sort_order, created_by, created_at, updated_at
        `, [...queryParams, id]);
        if (result.rows.length === 0) {
            return null;
        }
        const row = result.rows[0];
        return {
            id: row.id,
            projectId: 1, // ê¸°ë³¸ê°’
            parentId: row.parent_id,
            name: row.name,
            description: '',
            orderIndex: row.sort_order,
            depth: 0, // ê¸°ë³¸ê°’
            createdBy: row.created_by,
            updatedBy: data.updatedBy || row.created_by,
            isLocked: false,
            isArchived: false,
            createdAt: row.created_at,
            updatedAt: row.updated_at
        };
    }
    catch (error) {
        console.error('í´ë” ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
        return null;
    }
}
async function deleteFolder(id, mode = 'soft', deletedBy) {
    try {
        const pgClient = (0, pgClient_1.getPgClient)();
        if (!pgClient) {
            throw new Error('PostgreSQL í´ë¼ì´ì–¸íŠ¸ê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
        }
        // í˜„ìž¬ëŠ” í•˜ë“œ ì‚­ì œë§Œ ì§€ì›
        const result = await pgClient.query(`
            DELETE FROM tree_nodes 
            WHERE id = $1 AND type = 'folder'
        `, [id]);
        return (result.rowCount || 0) > 0;
    }
    catch (error) {
        console.error('í´ë” ì‚­ì œ ì‹¤íŒ¨:', error);
        return false;
    }
}
async function listFolders(params = {}) {
    try {
        const pgClient = (0, pgClient_1.getPgClient)();
        if (!pgClient) {
            throw new Error('PostgreSQL í´ë¼ì´ì–¸íŠ¸ê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
        }
        let query = `
            SELECT id, name, type, parent_id, sort_order, created_by, created_at, updated_at
            FROM tree_nodes 
            WHERE type = 'folder'
        `;
        const queryParams = [];
        let paramIndex = 1;
        if (params.parentId !== undefined) {
            query += ` AND parent_id = $${paramIndex}`;
            queryParams.push(params.parentId);
            paramIndex++;
        }
        // project_id ì»¬ëŸ¼ì´ ì—†ìœ¼ë¯€ë¡œ ì œê±°
        // if (params.projectId !== undefined) {
        //     query += ` AND project_id = $${paramIndex}`;
        //     queryParams.push(params.projectId);
        // }
        query += ` ORDER BY sort_order`;
        const result = await pgClient.query(query, queryParams);
        return result.rows.map((row) => ({
            id: row.id,
            projectId: params.projectId || 1,
            parentId: row.parent_id,
            name: row.name,
            description: '',
            orderIndex: row.sort_order,
            depth: 0, // ê¸°ë³¸ê°’
            createdBy: row.created_by,
            updatedBy: row.created_by,
            isLocked: false,
            isArchived: false,
            createdAt: row.created_at,
            updatedAt: row.updated_at
        }));
    }
    catch (error) {
        console.error('í´ë” ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨:', error);
        return [];
    }
}
async function getFolderTree(projectId, depth) {
    const allFolders = await listFolders({ projectId });
    const folderMap = new Map();
    const rootFolders = [];
    // í´ë”ê°€ ì—†ìœ¼ë©´ ë¹ˆ ë°°ì—´ ë°˜í™˜ (ìžë™ ìƒì„±í•˜ì§€ ì•ŠìŒ)
    if (allFolders.length === 0) {
        console.log('ðŸ“ í´ë”ê°€ ì—†ìŠµë‹ˆë‹¤. ë¹ˆ ë°°ì—´ì„ ë°˜í™˜í•©ë‹ˆë‹¤.');
        return [];
    }
    // depth ê³„ì‚° í•¨ìˆ˜
    const calculateDepth = (folderId, visited = new Set()) => {
        if (visited.has(folderId))
            return 0; // ìˆœí™˜ ì°¸ì¡° ë°©ì§€
        visited.add(folderId);
        const folder = allFolders.find(f => f.id === folderId);
        if (!folder || !folder.parentId)
            return 0;
        return 1 + calculateDepth(folder.parentId, visited);
    };
    // ëª¨ë“  í´ë”ë¥¼ ë§µì— ì¶”ê°€ (depth ê³„ì‚° í¬í•¨)
    allFolders.forEach(folder => {
        const calculatedDepth = calculateDepth(folder.id);
        if (depth === undefined || calculatedDepth <= depth) {
            folderMap.set(folder.id, {
                ...folder,
                depth: calculatedDepth,
                children: [],
                testCaseCount: 0
            });
        }
    });
    // íŠ¸ë¦¬ êµ¬ì¡° ìƒì„±
    allFolders.forEach(folder => {
        const calculatedDepth = calculateDepth(folder.id);
        if (depth === undefined || calculatedDepth <= depth) {
            const folderTree = folderMap.get(folder.id);
            if (folder.parentId && folderMap.has(folder.parentId)) {
                const parent = folderMap.get(folder.parentId);
                parent.children.push(folderTree);
            }
            else {
                rootFolders.push(folderTree);
            }
        }
    });
    // ê° í´ë”ì˜ í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ ê°œìˆ˜ ê³„ì‚°
    for (const folderTree of folderMap.values()) {
        try {
            const pgClient = (0, pgClient_1.getPgClient)();
            if (pgClient) {
                const result = await pgClient.query(`
                    SELECT COUNT(*) as count 
                    FROM tree_nodes 
                    WHERE type = 'testcase' AND parent_id = $1
                `, [folderTree.id]);
                folderTree.testCaseCount = parseInt(result.rows[0].count);
            }
        }
        catch (error) {
            console.error(`í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ ê°œìˆ˜ ê³„ì‚° ì‹¤íŒ¨ (í´ë” ID: ${folderTree.id}):`, error);
            folderTree.testCaseCount = 0;
        }
    }
    return rootFolders.sort((a, b) => a.orderIndex - b.orderIndex);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzLzNpLWExLTIwMjEtMDE3L0RvY3VtZW50cy9xdWVzdC9EZXNrdG9wL3F1ZXN0L3NyYy9tYWluL2FwcC9kb21haW5zL2ZvbGRlcnMvcmVwb3NpdG9yaWVzL2ZvbGRlclJlcG9zaXRvcnkudHMiLCJtYXBwaW5ncyI6Ijs7QUFHQSxvQ0FpQ0M7QUFFRCxzQ0FtREM7QUFFRCxvQ0ErREM7QUFFRCxvQ0FpQkM7QUFFRCxrQ0FxREM7QUFFRCxzQ0FzRUM7QUEzU0Qsd0VBQXdFO0FBRWpFLEtBQUssVUFBVSxZQUFZLENBQUMsSUFBb0Q7SUFDbkYsSUFBSSxDQUFDO1FBQ0QsTUFBTSxRQUFRLEdBQUcsSUFBQSxzQkFBVyxHQUFFLENBQUM7UUFDL0IsSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFDO1lBQ1osTUFBTSxJQUFJLEtBQUssQ0FBQyxnQ0FBZ0MsQ0FBQyxDQUFDO1FBQ3RELENBQUM7UUFFRCxNQUFNLE1BQU0sR0FBRyxNQUFNLFFBQVEsQ0FBQyxLQUFLLENBQUM7Ozs7U0FJbkMsRUFBRSxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsUUFBUSxFQUFFLElBQUksQ0FBQyxRQUFRLEVBQUUsSUFBSSxDQUFDLFVBQVUsRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQztRQUUxRSxNQUFNLEdBQUcsR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQzNCLE9BQU87WUFDSCxFQUFFLEVBQUUsR0FBRyxDQUFDLEVBQUU7WUFDVixTQUFTLEVBQUUsSUFBSSxDQUFDLFNBQVM7WUFDekIsUUFBUSxFQUFFLEdBQUcsQ0FBQyxTQUFTO1lBQ3ZCLElBQUksRUFBRSxHQUFHLENBQUMsSUFBSTtZQUNkLFdBQVcsRUFBRSxJQUFJLENBQUMsV0FBVyxJQUFJLEVBQUU7WUFDbkMsVUFBVSxFQUFFLEdBQUcsQ0FBQyxVQUFVO1lBQzFCLEtBQUssRUFBRSxJQUFJLENBQUMsS0FBSyxJQUFJLENBQUM7WUFDdEIsU0FBUyxFQUFFLEdBQUcsQ0FBQyxVQUFVO1lBQ3pCLFNBQVMsRUFBRSxJQUFJLENBQUMsU0FBUztZQUN6QixRQUFRLEVBQUUsS0FBSztZQUNmLFVBQVUsRUFBRSxLQUFLO1lBQ2pCLFNBQVMsRUFBRSxHQUFHLENBQUMsVUFBVTtZQUN6QixTQUFTLEVBQUUsR0FBRyxDQUFDLFVBQVU7U0FDNUIsQ0FBQztJQUNOLENBQUM7SUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1FBQ2IsT0FBTyxDQUFDLEtBQUssQ0FBQyxXQUFXLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFDbEMsTUFBTSxLQUFLLENBQUM7SUFDaEIsQ0FBQztBQUNMLENBQUM7QUFFTSxLQUFLLFVBQVUsYUFBYSxDQUFDLEVBQVU7SUFDMUMsSUFBSSxDQUFDO1FBQ0QsTUFBTSxRQUFRLEdBQUcsSUFBQSxzQkFBVyxHQUFFLENBQUM7UUFDL0IsSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFDO1lBQ1osTUFBTSxJQUFJLEtBQUssQ0FBQyxnQ0FBZ0MsQ0FBQyxDQUFDO1FBQ3RELENBQUM7UUFFRCxPQUFPLENBQUMsR0FBRyxDQUFDLG1CQUFtQixFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBRXJDLDhCQUE4QjtRQUM5QixNQUFNLFVBQVUsR0FBRyxNQUFNLFFBQVEsQ0FBQyxLQUFLLENBQUM7O1NBRXZDLENBQUMsQ0FBQztRQUNILE9BQU8sQ0FBQyxHQUFHLENBQUMsZUFBZSxVQUFVLENBQUMsSUFBSSxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUM7UUFDdEQsVUFBVSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLEVBQUU7WUFDMUIsT0FBTyxDQUFDLEdBQUcsQ0FBQyxXQUFXLEdBQUcsQ0FBQyxFQUFFLFNBQVMsR0FBRyxDQUFDLElBQUksRUFBRSxDQUFDLENBQUM7UUFDdEQsQ0FBQyxDQUFDLENBQUM7UUFFSCxNQUFNLE1BQU0sR0FBRyxNQUFNLFFBQVEsQ0FBQyxLQUFLLENBQUM7Ozs7U0FJbkMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7UUFFVCxPQUFPLENBQUMsR0FBRyxDQUFDLGFBQWEsTUFBTSxDQUFDLElBQUksQ0FBQyxNQUFNLEtBQUssQ0FBQyxDQUFDO1FBQ2xELElBQUksTUFBTSxDQUFDLElBQUksQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFLENBQUM7WUFDM0IsT0FBTyxDQUFDLEdBQUcsQ0FBQyxxQkFBcUIsRUFBRSxFQUFFLENBQUMsQ0FBQztZQUN2QyxPQUFPLElBQUksQ0FBQztRQUNoQixDQUFDO1FBRUQsTUFBTSxHQUFHLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUMzQixPQUFPLENBQUMsR0FBRyxDQUFDLFlBQVksR0FBRyxDQUFDLElBQUksU0FBUyxHQUFHLENBQUMsRUFBRSxHQUFHLENBQUMsQ0FBQztRQUNwRCxPQUFPO1lBQ0gsRUFBRSxFQUFFLEdBQUcsQ0FBQyxFQUFFO1lBQ1YsU0FBUyxFQUFFLENBQUMsRUFBRSxNQUFNO1lBQ3BCLFFBQVEsRUFBRSxHQUFHLENBQUMsU0FBUztZQUN2QixJQUFJLEVBQUUsR0FBRyxDQUFDLElBQUk7WUFDZCxXQUFXLEVBQUUsRUFBRTtZQUNmLFVBQVUsRUFBRSxHQUFHLENBQUMsVUFBVTtZQUMxQixLQUFLLEVBQUUsQ0FBQyxFQUFFLE1BQU07WUFDaEIsU0FBUyxFQUFFLEdBQUcsQ0FBQyxVQUFVO1lBQ3pCLFNBQVMsRUFBRSxHQUFHLENBQUMsVUFBVTtZQUN6QixRQUFRLEVBQUUsS0FBSztZQUNmLFVBQVUsRUFBRSxLQUFLO1lBQ2pCLFNBQVMsRUFBRSxHQUFHLENBQUMsVUFBVTtZQUN6QixTQUFTLEVBQUUsR0FBRyxDQUFDLFVBQVU7U0FDNUIsQ0FBQztJQUNOLENBQUM7SUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1FBQ2IsT0FBTyxDQUFDLEtBQUssQ0FBQyxXQUFXLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFDbEMsT0FBTyxJQUFJLENBQUM7SUFDaEIsQ0FBQztBQUNMLENBQUM7QUFFTSxLQUFLLFVBQVUsWUFBWSxDQUFDLEVBQVUsRUFBRSxJQUE4QztJQUN6RixJQUFJLENBQUM7UUFDRCxNQUFNLFFBQVEsR0FBRyxJQUFBLHNCQUFXLEdBQUUsQ0FBQztRQUMvQixJQUFJLENBQUMsUUFBUSxFQUFFLENBQUM7WUFDWixNQUFNLElBQUksS0FBSyxDQUFDLGdDQUFnQyxDQUFDLENBQUM7UUFDdEQsQ0FBQztRQUVELHFCQUFxQjtRQUNyQixNQUFNLFlBQVksR0FBYSxFQUFFLENBQUM7UUFDbEMsTUFBTSxXQUFXLEdBQVUsRUFBRSxDQUFDO1FBQzlCLElBQUksVUFBVSxHQUFHLENBQUMsQ0FBQztRQUVuQixJQUFJLElBQUksQ0FBQyxJQUFJLEtBQUssU0FBUyxFQUFFLENBQUM7WUFDMUIsWUFBWSxDQUFDLElBQUksQ0FBQyxXQUFXLFVBQVUsRUFBRSxDQUFDLENBQUM7WUFDM0MsV0FBVyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDNUIsVUFBVSxFQUFFLENBQUM7UUFDakIsQ0FBQztRQUVELElBQUksSUFBSSxDQUFDLFFBQVEsS0FBSyxTQUFTLEVBQUUsQ0FBQztZQUM5QixZQUFZLENBQUMsSUFBSSxDQUFDLGdCQUFnQixVQUFVLEVBQUUsQ0FBQyxDQUFDO1lBQ2hELFdBQVcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBQ2hDLFVBQVUsRUFBRSxDQUFDO1FBQ2pCLENBQUM7UUFFRCxJQUFJLElBQUksQ0FBQyxVQUFVLEtBQUssU0FBUyxFQUFFLENBQUM7WUFDaEMsWUFBWSxDQUFDLElBQUksQ0FBQyxpQkFBaUIsVUFBVSxFQUFFLENBQUMsQ0FBQztZQUNqRCxXQUFXLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQztZQUNsQyxVQUFVLEVBQUUsQ0FBQztRQUNqQixDQUFDO1FBRUQsWUFBWSxDQUFDLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxDQUFDO1FBRXhDLE1BQU0sTUFBTSxHQUFHLE1BQU0sUUFBUSxDQUFDLEtBQUssQ0FBQzs7a0JBRTFCLFlBQVksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDOzBCQUNmLFVBQVU7O1NBRTNCLEVBQUUsQ0FBQyxHQUFHLFdBQVcsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDO1FBRXpCLElBQUksTUFBTSxDQUFDLElBQUksQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFLENBQUM7WUFDM0IsT0FBTyxJQUFJLENBQUM7UUFDaEIsQ0FBQztRQUVELE1BQU0sR0FBRyxHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDM0IsT0FBTztZQUNILEVBQUUsRUFBRSxHQUFHLENBQUMsRUFBRTtZQUNWLFNBQVMsRUFBRSxDQUFDLEVBQUUsTUFBTTtZQUNwQixRQUFRLEVBQUUsR0FBRyxDQUFDLFNBQVM7WUFDdkIsSUFBSSxFQUFFLEdBQUcsQ0FBQyxJQUFJO1lBQ2QsV0FBVyxFQUFFLEVBQUU7WUFDZixVQUFVLEVBQUUsR0FBRyxDQUFDLFVBQVU7WUFDMUIsS0FBSyxFQUFFLENBQUMsRUFBRSxNQUFNO1lBQ2hCLFNBQVMsRUFBRSxHQUFHLENBQUMsVUFBVTtZQUN6QixTQUFTLEVBQUUsSUFBSSxDQUFDLFNBQVMsSUFBSSxHQUFHLENBQUMsVUFBVTtZQUMzQyxRQUFRLEVBQUUsS0FBSztZQUNmLFVBQVUsRUFBRSxLQUFLO1lBQ2pCLFNBQVMsRUFBRSxHQUFHLENBQUMsVUFBVTtZQUN6QixTQUFTLEVBQUUsR0FBRyxDQUFDLFVBQVU7U0FDNUIsQ0FBQztJQUNOLENBQUM7SUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1FBQ2IsT0FBTyxDQUFDLEtBQUssQ0FBQyxhQUFhLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFDcEMsT0FBTyxJQUFJLENBQUM7SUFDaEIsQ0FBQztBQUNMLENBQUM7QUFFTSxLQUFLLFVBQVUsWUFBWSxDQUFDLEVBQVUsRUFBRSxPQUF3QixNQUFNLEVBQUUsU0FBaUI7SUFDNUYsSUFBSSxDQUFDO1FBQ0QsTUFBTSxRQUFRLEdBQUcsSUFBQSxzQkFBVyxHQUFFLENBQUM7UUFDL0IsSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFDO1lBQ1osTUFBTSxJQUFJLEtBQUssQ0FBQyxnQ0FBZ0MsQ0FBQyxDQUFDO1FBQ3RELENBQUM7UUFFRCxnQkFBZ0I7UUFDaEIsTUFBTSxNQUFNLEdBQUcsTUFBTSxRQUFRLENBQUMsS0FBSyxDQUFDOzs7U0FHbkMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7UUFDVCxPQUFPLENBQUMsTUFBTSxDQUFDLFFBQVEsSUFBSSxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDdEMsQ0FBQztJQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7UUFDYixPQUFPLENBQUMsS0FBSyxDQUFDLFdBQVcsRUFBRSxLQUFLLENBQUMsQ0FBQztRQUNsQyxPQUFPLEtBQUssQ0FBQztJQUNqQixDQUFDO0FBQ0wsQ0FBQztBQUVNLEtBQUssVUFBVSxXQUFXLENBQUMsU0FHOUIsRUFBRTtJQUNGLElBQUksQ0FBQztRQUNELE1BQU0sUUFBUSxHQUFHLElBQUEsc0JBQVcsR0FBRSxDQUFDO1FBQy9CLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQztZQUNaLE1BQU0sSUFBSSxLQUFLLENBQUMsZ0NBQWdDLENBQUMsQ0FBQztRQUN0RCxDQUFDO1FBRUQsSUFBSSxLQUFLLEdBQUc7Ozs7U0FJWCxDQUFDO1FBQ0YsTUFBTSxXQUFXLEdBQVUsRUFBRSxDQUFDO1FBQzlCLElBQUksVUFBVSxHQUFHLENBQUMsQ0FBQztRQUVuQixJQUFJLE1BQU0sQ0FBQyxRQUFRLEtBQUssU0FBUyxFQUFFLENBQUM7WUFDaEMsS0FBSyxJQUFJLHFCQUFxQixVQUFVLEVBQUUsQ0FBQztZQUMzQyxXQUFXLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQztZQUNsQyxVQUFVLEVBQUUsQ0FBQztRQUNqQixDQUFDO1FBRUQseUJBQXlCO1FBQ3pCLHdDQUF3QztRQUN4QyxtREFBbUQ7UUFDbkQsMENBQTBDO1FBQzFDLElBQUk7UUFFSixLQUFLLElBQUksc0JBQXNCLENBQUM7UUFFaEMsTUFBTSxNQUFNLEdBQUcsTUFBTSxRQUFRLENBQUMsS0FBSyxDQUFDLEtBQUssRUFBRSxXQUFXLENBQUMsQ0FBQztRQUV4RCxPQUFPLE1BQU0sQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsR0FBUSxFQUFFLEVBQUUsQ0FBQyxDQUFDO1lBQ2xDLEVBQUUsRUFBRSxHQUFHLENBQUMsRUFBRTtZQUNWLFNBQVMsRUFBRSxNQUFNLENBQUMsU0FBUyxJQUFJLENBQUM7WUFDaEMsUUFBUSxFQUFFLEdBQUcsQ0FBQyxTQUFTO1lBQ3ZCLElBQUksRUFBRSxHQUFHLENBQUMsSUFBSTtZQUNkLFdBQVcsRUFBRSxFQUFFO1lBQ2YsVUFBVSxFQUFFLEdBQUcsQ0FBQyxVQUFVO1lBQzFCLEtBQUssRUFBRSxDQUFDLEVBQUUsTUFBTTtZQUNoQixTQUFTLEVBQUUsR0FBRyxDQUFDLFVBQVU7WUFDekIsU0FBUyxFQUFFLEdBQUcsQ0FBQyxVQUFVO1lBQ3pCLFFBQVEsRUFBRSxLQUFLO1lBQ2YsVUFBVSxFQUFFLEtBQUs7WUFDakIsU0FBUyxFQUFFLEdBQUcsQ0FBQyxVQUFVO1lBQ3pCLFNBQVMsRUFBRSxHQUFHLENBQUMsVUFBVTtTQUM1QixDQUFDLENBQUMsQ0FBQztJQUNSLENBQUM7SUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1FBQ2IsT0FBTyxDQUFDLEtBQUssQ0FBQyxjQUFjLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFDckMsT0FBTyxFQUFFLENBQUM7SUFDZCxDQUFDO0FBQ0wsQ0FBQztBQUVNLEtBQUssVUFBVSxhQUFhLENBQUMsU0FBaUIsRUFBRSxLQUFjO0lBQ2pFLE1BQU0sVUFBVSxHQUFHLE1BQU0sV0FBVyxDQUFDLEVBQUUsU0FBUyxFQUFFLENBQUMsQ0FBQztJQUNwRCxNQUFNLFNBQVMsR0FBRyxJQUFJLEdBQUcsRUFBc0IsQ0FBQztJQUNoRCxNQUFNLFdBQVcsR0FBaUIsRUFBRSxDQUFDO0lBRXJDLCtCQUErQjtJQUMvQixJQUFJLFVBQVUsQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFLENBQUM7UUFDMUIsT0FBTyxDQUFDLEdBQUcsQ0FBQywyQkFBMkIsQ0FBQyxDQUFDO1FBQ3pDLE9BQU8sRUFBRSxDQUFDO0lBQ2QsQ0FBQztJQUVELGNBQWM7SUFDZCxNQUFNLGNBQWMsR0FBRyxDQUFDLFFBQWdCLEVBQUUsVUFBdUIsSUFBSSxHQUFHLEVBQUUsRUFBVSxFQUFFO1FBQ2xGLElBQUksT0FBTyxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUM7WUFBRSxPQUFPLENBQUMsQ0FBQyxDQUFDLFdBQVc7UUFDaEQsT0FBTyxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUV0QixNQUFNLE1BQU0sR0FBRyxVQUFVLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLEVBQUUsS0FBSyxRQUFRLENBQUMsQ0FBQztRQUN2RCxJQUFJLENBQUMsTUFBTSxJQUFJLENBQUMsTUFBTSxDQUFDLFFBQVE7WUFBRSxPQUFPLENBQUMsQ0FBQztRQUUxQyxPQUFPLENBQUMsR0FBRyxjQUFjLENBQUMsTUFBTSxDQUFDLFFBQVEsRUFBRSxPQUFPLENBQUMsQ0FBQztJQUN4RCxDQUFDLENBQUM7SUFFRiw2QkFBNkI7SUFDN0IsVUFBVSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsRUFBRTtRQUN4QixNQUFNLGVBQWUsR0FBRyxjQUFjLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQ2xELElBQUksS0FBSyxLQUFLLFNBQVMsSUFBSSxlQUFlLElBQUksS0FBSyxFQUFFLENBQUM7WUFDbEQsU0FBUyxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsRUFBRSxFQUFFO2dCQUNyQixHQUFHLE1BQU07Z0JBQ1QsS0FBSyxFQUFFLGVBQWU7Z0JBQ3RCLFFBQVEsRUFBRSxFQUFFO2dCQUNaLGFBQWEsRUFBRSxDQUFDO2FBQ25CLENBQUMsQ0FBQztRQUNQLENBQUM7SUFDTCxDQUFDLENBQUMsQ0FBQztJQUVILFdBQVc7SUFDWCxVQUFVLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxFQUFFO1FBQ3hCLE1BQU0sZUFBZSxHQUFHLGNBQWMsQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLENBQUM7UUFDbEQsSUFBSSxLQUFLLEtBQUssU0FBUyxJQUFJLGVBQWUsSUFBSSxLQUFLLEVBQUUsQ0FBQztZQUNsRCxNQUFNLFVBQVUsR0FBRyxTQUFTLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUUsQ0FBQztZQUU3QyxJQUFJLE1BQU0sQ0FBQyxRQUFRLElBQUksU0FBUyxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQztnQkFDcEQsTUFBTSxNQUFNLEdBQUcsU0FBUyxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFFLENBQUM7Z0JBQy9DLE1BQU0sQ0FBQyxRQUFTLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDO1lBQ3RDLENBQUM7aUJBQU0sQ0FBQztnQkFDSixXQUFXLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDO1lBQ2pDLENBQUM7UUFDTCxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUM7SUFFSCxzQkFBc0I7SUFDdEIsS0FBSyxNQUFNLFVBQVUsSUFBSSxTQUFTLENBQUMsTUFBTSxFQUFFLEVBQUUsQ0FBQztRQUMxQyxJQUFJLENBQUM7WUFDRCxNQUFNLFFBQVEsR0FBRyxJQUFBLHNCQUFXLEdBQUUsQ0FBQztZQUMvQixJQUFJLFFBQVEsRUFBRSxDQUFDO2dCQUNYLE1BQU0sTUFBTSxHQUFHLE1BQU0sUUFBUSxDQUFDLEtBQUssQ0FBQzs7OztpQkFJbkMsRUFBRSxDQUFDLFVBQVUsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO2dCQUVwQixVQUFVLENBQUMsYUFBYSxHQUFHLFFBQVEsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQzlELENBQUM7UUFDTCxDQUFDO1FBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztZQUNiLE9BQU8sQ0FBQyxLQUFLLENBQUMsNEJBQTRCLFVBQVUsQ0FBQyxFQUFFLElBQUksRUFBRSxLQUFLLENBQUMsQ0FBQztZQUNwRSxVQUFVLENBQUMsYUFBYSxHQUFHLENBQUMsQ0FBQztRQUNqQyxDQUFDO0lBQ0wsQ0FBQztJQUVELE9BQU8sV0FBVyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxVQUFVLEdBQUcsQ0FBQyxDQUFDLFVBQVUsQ0FBQyxDQUFDO0FBQ25FLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL1VzZXJzLzNpLWExLTIwMjEtMDE3L0RvY3VtZW50cy9xdWVzdC9EZXNrdG9wL3F1ZXN0L3NyYy9tYWluL2FwcC9kb21haW5zL2ZvbGRlcnMvcmVwb3NpdG9yaWVzL2ZvbGRlclJlcG9zaXRvcnkudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRm9sZGVyLCBGb2xkZXJUcmVlIH0gZnJvbSAnLi4vbW9kZWxzL0ZvbGRlcic7XG5pbXBvcnQgeyBnZXRQZ0NsaWVudCB9IGZyb20gJy4uLy4uLy4uL2luZnJhc3RydWN0dXJlL2RhdGFiYXNlL3BnQ2xpZW50JztcblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGNyZWF0ZUZvbGRlcihkYXRhOiBPbWl0PEZvbGRlciwgJ2lkJyB8ICdjcmVhdGVkQXQnIHwgJ3VwZGF0ZWRBdCc+KTogUHJvbWlzZTxGb2xkZXI+IHtcbiAgICB0cnkge1xuICAgICAgICBjb25zdCBwZ0NsaWVudCA9IGdldFBnQ2xpZW50KCk7XG4gICAgICAgIGlmICghcGdDbGllbnQpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignUG9zdGdyZVNRTCDtgbTrnbzsnbTslrjtirjqsIAg7LSI6riw7ZmU65CY7KeAIOyViuyVmOyKteuLiOuLpC4nKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHBnQ2xpZW50LnF1ZXJ5KGBcbiAgICAgICAgICAgIElOU0VSVCBJTlRPIHRyZWVfbm9kZXMgKG5hbWUsIHR5cGUsIHBhcmVudF9pZCwgc29ydF9vcmRlciwgY3JlYXRlZF9ieSlcbiAgICAgICAgICAgIFZBTFVFUyAoJDEsICQyLCAkMywgJDQsICQ1KVxuICAgICAgICAgICAgUkVUVVJOSU5HIGlkLCBuYW1lLCB0eXBlLCBwYXJlbnRfaWQsIHNvcnRfb3JkZXIsIGNyZWF0ZWRfYnksIGNyZWF0ZWRfYXQsIHVwZGF0ZWRfYXRcbiAgICAgICAgYCwgW2RhdGEubmFtZSwgJ2ZvbGRlcicsIGRhdGEucGFyZW50SWQsIGRhdGEub3JkZXJJbmRleCwgZGF0YS5jcmVhdGVkQnldKTtcblxuICAgICAgICBjb25zdCByb3cgPSByZXN1bHQucm93c1swXTtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIGlkOiByb3cuaWQsXG4gICAgICAgICAgICBwcm9qZWN0SWQ6IGRhdGEucHJvamVjdElkLFxuICAgICAgICAgICAgcGFyZW50SWQ6IHJvdy5wYXJlbnRfaWQsXG4gICAgICAgICAgICBuYW1lOiByb3cubmFtZSxcbiAgICAgICAgICAgIGRlc2NyaXB0aW9uOiBkYXRhLmRlc2NyaXB0aW9uIHx8ICcnLFxuICAgICAgICAgICAgb3JkZXJJbmRleDogcm93LnNvcnRfb3JkZXIsXG4gICAgICAgICAgICBkZXB0aDogZGF0YS5kZXB0aCB8fCAwLFxuICAgICAgICAgICAgY3JlYXRlZEJ5OiByb3cuY3JlYXRlZF9ieSxcbiAgICAgICAgICAgIHVwZGF0ZWRCeTogZGF0YS5jcmVhdGVkQnksXG4gICAgICAgICAgICBpc0xvY2tlZDogZmFsc2UsXG4gICAgICAgICAgICBpc0FyY2hpdmVkOiBmYWxzZSxcbiAgICAgICAgICAgIGNyZWF0ZWRBdDogcm93LmNyZWF0ZWRfYXQsXG4gICAgICAgICAgICB1cGRhdGVkQXQ6IHJvdy51cGRhdGVkX2F0XG4gICAgICAgIH07XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgY29uc29sZS5lcnJvcign7Y+0642UIOyDneyEsSDsi6TtjKg6JywgZXJyb3IpO1xuICAgICAgICB0aHJvdyBlcnJvcjtcbiAgICB9XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBnZXRGb2xkZXJCeUlkKGlkOiBudW1iZXIpOiBQcm9taXNlPEZvbGRlciB8IG51bGw+IHtcbiAgICB0cnkge1xuICAgICAgICBjb25zdCBwZ0NsaWVudCA9IGdldFBnQ2xpZW50KCk7XG4gICAgICAgIGlmICghcGdDbGllbnQpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignUG9zdGdyZVNRTCDtgbTrnbzsnbTslrjtirjqsIAg7LSI6riw7ZmU65CY7KeAIOyViuyVmOyKteuLiOuLpC4nKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnNvbGUubG9nKGDwn5SNIO2PtOuNlCDsobDtmowg7Iuc64+EOiBJRCAke2lkfWApO1xuICAgICAgICBcbiAgICAgICAgLy8g66i87KCAIOuqqOuToCDtj7TrjZTrpbwg7KGw7ZqM7ZW07IScIOuNsOydtO2EsOuyoOydtOyKpCDsl7DqsrAg7ZmV7J24XG4gICAgICAgIGNvbnN0IGFsbEZvbGRlcnMgPSBhd2FpdCBwZ0NsaWVudC5xdWVyeShgXG4gICAgICAgICAgICBTRUxFQ1QgaWQsIG5hbWUsIHR5cGUgRlJPTSB0cmVlX25vZGVzIFdIRVJFIHR5cGUgPSAnZm9sZGVyJyBPUkRFUiBCWSBpZFxuICAgICAgICBgKTtcbiAgICAgICAgY29uc29sZS5sb2coYPCflI0g7KCE7LK0IO2PtOuNlCDsiJg6ICR7YWxsRm9sZGVycy5yb3dzLmxlbmd0aH3qsJxgKTtcbiAgICAgICAgYWxsRm9sZGVycy5yb3dzLmZvckVhY2gocm93ID0+IHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKGAgIC0gSUQ6ICR7cm93LmlkfSwg7J2066aEOiAke3Jvdy5uYW1lfWApO1xuICAgICAgICB9KTtcbiAgICAgICAgXG4gICAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHBnQ2xpZW50LnF1ZXJ5KGBcbiAgICAgICAgICAgIFNFTEVDVCBpZCwgbmFtZSwgdHlwZSwgcGFyZW50X2lkLCBzb3J0X29yZGVyLCBjcmVhdGVkX2J5LCBjcmVhdGVkX2F0LCB1cGRhdGVkX2F0XG4gICAgICAgICAgICBGUk9NIHRyZWVfbm9kZXMgXG4gICAgICAgICAgICBXSEVSRSBpZCA9ICQxIEFORCB0eXBlID0gJ2ZvbGRlcidcbiAgICAgICAgYCwgW2lkXSk7XG5cbiAgICAgICAgY29uc29sZS5sb2coYPCflI0g7L+866asIOqysOqzvDogJHtyZXN1bHQucm93cy5sZW5ndGh96rCcIO2WiWApO1xuICAgICAgICBpZiAocmVzdWx0LnJvd3MubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhg4p2MIO2PtOuNlOulvCDssL7snYQg7IiYIOyXhuydjDogSUQgJHtpZH1gKTtcbiAgICAgICAgICAgIHJldHVybiBudWxsO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3Qgcm93ID0gcmVzdWx0LnJvd3NbMF07XG4gICAgICAgIGNvbnNvbGUubG9nKGDinIUg7Y+0642UIOywvuydjDogJHtyb3cubmFtZX0gKElEOiAke3Jvdy5pZH0pYCk7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBpZDogcm93LmlkLFxuICAgICAgICAgICAgcHJvamVjdElkOiAxLCAvLyDquLDrs7jqsJJcbiAgICAgICAgICAgIHBhcmVudElkOiByb3cucGFyZW50X2lkLFxuICAgICAgICAgICAgbmFtZTogcm93Lm5hbWUsXG4gICAgICAgICAgICBkZXNjcmlwdGlvbjogJycsXG4gICAgICAgICAgICBvcmRlckluZGV4OiByb3cuc29ydF9vcmRlcixcbiAgICAgICAgICAgIGRlcHRoOiAwLCAvLyDquLDrs7jqsJJcbiAgICAgICAgICAgIGNyZWF0ZWRCeTogcm93LmNyZWF0ZWRfYnksXG4gICAgICAgICAgICB1cGRhdGVkQnk6IHJvdy5jcmVhdGVkX2J5LFxuICAgICAgICAgICAgaXNMb2NrZWQ6IGZhbHNlLFxuICAgICAgICAgICAgaXNBcmNoaXZlZDogZmFsc2UsXG4gICAgICAgICAgICBjcmVhdGVkQXQ6IHJvdy5jcmVhdGVkX2F0LFxuICAgICAgICAgICAgdXBkYXRlZEF0OiByb3cudXBkYXRlZF9hdFxuICAgICAgICB9O1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoJ+2PtOuNlCDsobDtmowg7Iuk7YyoOicsIGVycm9yKTtcbiAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gdXBkYXRlRm9sZGVyKGlkOiBudW1iZXIsIGRhdGE6IFBhcnRpYWw8Rm9sZGVyPiAmIHsgdXBkYXRlZEJ5Pzogc3RyaW5nIH0pOiBQcm9taXNlPEZvbGRlciB8IG51bGw+IHtcbiAgICB0cnkge1xuICAgICAgICBjb25zdCBwZ0NsaWVudCA9IGdldFBnQ2xpZW50KCk7XG4gICAgICAgIGlmICghcGdDbGllbnQpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignUG9zdGdyZVNRTCDtgbTrnbzsnbTslrjtirjqsIAg7LSI6riw7ZmU65CY7KeAIOyViuyVmOyKteuLiOuLpC4nKTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIOyXheuNsOydtO2KuO2VoCDtlYTrk5zrk6TsnYQg64+Z7KCB7Jy866GcIOq1rOyEsVxuICAgICAgICBjb25zdCB1cGRhdGVGaWVsZHM6IHN0cmluZ1tdID0gW107XG4gICAgICAgIGNvbnN0IHF1ZXJ5UGFyYW1zOiBhbnlbXSA9IFtdO1xuICAgICAgICBsZXQgcGFyYW1JbmRleCA9IDE7XG5cbiAgICAgICAgaWYgKGRhdGEubmFtZSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICB1cGRhdGVGaWVsZHMucHVzaChgbmFtZSA9ICQke3BhcmFtSW5kZXh9YCk7XG4gICAgICAgICAgICBxdWVyeVBhcmFtcy5wdXNoKGRhdGEubmFtZSk7XG4gICAgICAgICAgICBwYXJhbUluZGV4Kys7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoZGF0YS5wYXJlbnRJZCAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICB1cGRhdGVGaWVsZHMucHVzaChgcGFyZW50X2lkID0gJCR7cGFyYW1JbmRleH1gKTtcbiAgICAgICAgICAgIHF1ZXJ5UGFyYW1zLnB1c2goZGF0YS5wYXJlbnRJZCk7XG4gICAgICAgICAgICBwYXJhbUluZGV4Kys7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoZGF0YS5vcmRlckluZGV4ICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgIHVwZGF0ZUZpZWxkcy5wdXNoKGBzb3J0X29yZGVyID0gJCR7cGFyYW1JbmRleH1gKTtcbiAgICAgICAgICAgIHF1ZXJ5UGFyYW1zLnB1c2goZGF0YS5vcmRlckluZGV4KTtcbiAgICAgICAgICAgIHBhcmFtSW5kZXgrKztcbiAgICAgICAgfVxuXG4gICAgICAgIHVwZGF0ZUZpZWxkcy5wdXNoKGB1cGRhdGVkX2F0ID0gTk9XKClgKTtcblxuICAgICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBwZ0NsaWVudC5xdWVyeShgXG4gICAgICAgICAgICBVUERBVEUgdHJlZV9ub2RlcyBcbiAgICAgICAgICAgIFNFVCAke3VwZGF0ZUZpZWxkcy5qb2luKCcsICcpfVxuICAgICAgICAgICAgV0hFUkUgaWQgPSAkJHtwYXJhbUluZGV4fSBBTkQgdHlwZSA9ICdmb2xkZXInXG4gICAgICAgICAgICBSRVRVUk5JTkcgaWQsIG5hbWUsIHR5cGUsIHBhcmVudF9pZCwgc29ydF9vcmRlciwgY3JlYXRlZF9ieSwgY3JlYXRlZF9hdCwgdXBkYXRlZF9hdFxuICAgICAgICBgLCBbLi4ucXVlcnlQYXJhbXMsIGlkXSk7XG5cbiAgICAgICAgaWYgKHJlc3VsdC5yb3dzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCByb3cgPSByZXN1bHQucm93c1swXTtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIGlkOiByb3cuaWQsXG4gICAgICAgICAgICBwcm9qZWN0SWQ6IDEsIC8vIOq4sOuzuOqwklxuICAgICAgICAgICAgcGFyZW50SWQ6IHJvdy5wYXJlbnRfaWQsXG4gICAgICAgICAgICBuYW1lOiByb3cubmFtZSxcbiAgICAgICAgICAgIGRlc2NyaXB0aW9uOiAnJyxcbiAgICAgICAgICAgIG9yZGVySW5kZXg6IHJvdy5zb3J0X29yZGVyLFxuICAgICAgICAgICAgZGVwdGg6IDAsIC8vIOq4sOuzuOqwklxuICAgICAgICAgICAgY3JlYXRlZEJ5OiByb3cuY3JlYXRlZF9ieSxcbiAgICAgICAgICAgIHVwZGF0ZWRCeTogZGF0YS51cGRhdGVkQnkgfHwgcm93LmNyZWF0ZWRfYnksXG4gICAgICAgICAgICBpc0xvY2tlZDogZmFsc2UsXG4gICAgICAgICAgICBpc0FyY2hpdmVkOiBmYWxzZSxcbiAgICAgICAgICAgIGNyZWF0ZWRBdDogcm93LmNyZWF0ZWRfYXQsXG4gICAgICAgICAgICB1cGRhdGVkQXQ6IHJvdy51cGRhdGVkX2F0XG4gICAgICAgIH07XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgY29uc29sZS5lcnJvcign7Y+0642UIOyXheuNsOydtO2KuCDsi6TtjKg6JywgZXJyb3IpO1xuICAgICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBkZWxldGVGb2xkZXIoaWQ6IG51bWJlciwgbW9kZTogJ3NvZnQnIHwgJ2hhcmQnID0gJ3NvZnQnLCBkZWxldGVkQnk6IHN0cmluZyk6IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgIHRyeSB7XG4gICAgICAgIGNvbnN0IHBnQ2xpZW50ID0gZ2V0UGdDbGllbnQoKTtcbiAgICAgICAgaWYgKCFwZ0NsaWVudCkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdQb3N0Z3JlU1FMIO2BtOudvOydtOyWuO2KuOqwgCDstIjquLDtmZTrkJjsp4Ag7JWK7JWY7Iq164uI64ukLicpO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8g7ZiE7J6s64qUIO2VmOuTnCDsgq3soJzrp4wg7KeA7JuQXG4gICAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHBnQ2xpZW50LnF1ZXJ5KGBcbiAgICAgICAgICAgIERFTEVURSBGUk9NIHRyZWVfbm9kZXMgXG4gICAgICAgICAgICBXSEVSRSBpZCA9ICQxIEFORCB0eXBlID0gJ2ZvbGRlcidcbiAgICAgICAgYCwgW2lkXSk7XG4gICAgICAgIHJldHVybiAocmVzdWx0LnJvd0NvdW50IHx8IDApID4gMDtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICBjb25zb2xlLmVycm9yKCftj7TrjZQg7IKt7KCcIOyLpO2MqDonLCBlcnJvcik7XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBsaXN0Rm9sZGVycyhwYXJhbXM6IHtcbiAgICBwYXJlbnRJZD86IG51bWJlcjtcbiAgICBwcm9qZWN0SWQ/OiBudW1iZXI7XG59ID0ge30pOiBQcm9taXNlPEZvbGRlcltdPiB7XG4gICAgdHJ5IHtcbiAgICAgICAgY29uc3QgcGdDbGllbnQgPSBnZXRQZ0NsaWVudCgpO1xuICAgICAgICBpZiAoIXBnQ2xpZW50KSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1Bvc3RncmVTUUwg7YG065287J207Ja47Yq46rCAIOy0iOq4sO2ZlOuQmOyngCDslYrslZjsirXri4jri6QuJyk7XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgcXVlcnkgPSBgXG4gICAgICAgICAgICBTRUxFQ1QgaWQsIG5hbWUsIHR5cGUsIHBhcmVudF9pZCwgc29ydF9vcmRlciwgY3JlYXRlZF9ieSwgY3JlYXRlZF9hdCwgdXBkYXRlZF9hdFxuICAgICAgICAgICAgRlJPTSB0cmVlX25vZGVzIFxuICAgICAgICAgICAgV0hFUkUgdHlwZSA9ICdmb2xkZXInXG4gICAgICAgIGA7XG4gICAgICAgIGNvbnN0IHF1ZXJ5UGFyYW1zOiBhbnlbXSA9IFtdO1xuICAgICAgICBsZXQgcGFyYW1JbmRleCA9IDE7XG5cbiAgICAgICAgaWYgKHBhcmFtcy5wYXJlbnRJZCAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICBxdWVyeSArPSBgIEFORCBwYXJlbnRfaWQgPSAkJHtwYXJhbUluZGV4fWA7XG4gICAgICAgICAgICBxdWVyeVBhcmFtcy5wdXNoKHBhcmFtcy5wYXJlbnRJZCk7XG4gICAgICAgICAgICBwYXJhbUluZGV4Kys7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBwcm9qZWN0X2lkIOy7rOufvOydtCDsl4bsnLzrr4DroZwg7KCc6rGwXG4gICAgICAgIC8vIGlmIChwYXJhbXMucHJvamVjdElkICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgLy8gICAgIHF1ZXJ5ICs9IGAgQU5EIHByb2plY3RfaWQgPSAkJHtwYXJhbUluZGV4fWA7XG4gICAgICAgIC8vICAgICBxdWVyeVBhcmFtcy5wdXNoKHBhcmFtcy5wcm9qZWN0SWQpO1xuICAgICAgICAvLyB9XG5cbiAgICAgICAgcXVlcnkgKz0gYCBPUkRFUiBCWSBzb3J0X29yZGVyYDtcblxuICAgICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBwZ0NsaWVudC5xdWVyeShxdWVyeSwgcXVlcnlQYXJhbXMpO1xuXG4gICAgICAgIHJldHVybiByZXN1bHQucm93cy5tYXAoKHJvdzogYW55KSA9PiAoe1xuICAgICAgICAgICAgaWQ6IHJvdy5pZCxcbiAgICAgICAgICAgIHByb2plY3RJZDogcGFyYW1zLnByb2plY3RJZCB8fCAxLFxuICAgICAgICAgICAgcGFyZW50SWQ6IHJvdy5wYXJlbnRfaWQsXG4gICAgICAgICAgICBuYW1lOiByb3cubmFtZSxcbiAgICAgICAgICAgIGRlc2NyaXB0aW9uOiAnJyxcbiAgICAgICAgICAgIG9yZGVySW5kZXg6IHJvdy5zb3J0X29yZGVyLFxuICAgICAgICAgICAgZGVwdGg6IDAsIC8vIOq4sOuzuOqwklxuICAgICAgICAgICAgY3JlYXRlZEJ5OiByb3cuY3JlYXRlZF9ieSxcbiAgICAgICAgICAgIHVwZGF0ZWRCeTogcm93LmNyZWF0ZWRfYnksXG4gICAgICAgICAgICBpc0xvY2tlZDogZmFsc2UsXG4gICAgICAgICAgICBpc0FyY2hpdmVkOiBmYWxzZSxcbiAgICAgICAgICAgIGNyZWF0ZWRBdDogcm93LmNyZWF0ZWRfYXQsXG4gICAgICAgICAgICB1cGRhdGVkQXQ6IHJvdy51cGRhdGVkX2F0XG4gICAgICAgIH0pKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICBjb25zb2xlLmVycm9yKCftj7TrjZQg66qp66GdIOyhsO2ajCDsi6TtjKg6JywgZXJyb3IpO1xuICAgICAgICByZXR1cm4gW107XG4gICAgfVxufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZ2V0Rm9sZGVyVHJlZShwcm9qZWN0SWQ6IG51bWJlciwgZGVwdGg/OiBudW1iZXIpOiBQcm9taXNlPEZvbGRlclRyZWVbXT4ge1xuICAgIGNvbnN0IGFsbEZvbGRlcnMgPSBhd2FpdCBsaXN0Rm9sZGVycyh7IHByb2plY3RJZCB9KTtcbiAgICBjb25zdCBmb2xkZXJNYXAgPSBuZXcgTWFwPG51bWJlciwgRm9sZGVyVHJlZT4oKTtcbiAgICBjb25zdCByb290Rm9sZGVyczogRm9sZGVyVHJlZVtdID0gW107XG4gICAgXG4gICAgLy8g7Y+0642U6rCAIOyXhuycvOuptCDruYgg67Cw7Je0IOuwmO2ZmCAo7J6Q64+ZIOyDneyEse2VmOyngCDslYrsnYwpXG4gICAgaWYgKGFsbEZvbGRlcnMubGVuZ3RoID09PSAwKSB7XG4gICAgICAgIGNvbnNvbGUubG9nKCfwn5OBIO2PtOuNlOqwgCDsl4bsirXri4jri6QuIOu5iCDrsLDsl7TsnYQg67CY7ZmY7ZWp64uI64ukLicpO1xuICAgICAgICByZXR1cm4gW107XG4gICAgfVxuICAgIFxuICAgIC8vIGRlcHRoIOqzhOyCsCDtlajsiJhcbiAgICBjb25zdCBjYWxjdWxhdGVEZXB0aCA9IChmb2xkZXJJZDogbnVtYmVyLCB2aXNpdGVkOiBTZXQ8bnVtYmVyPiA9IG5ldyBTZXQoKSk6IG51bWJlciA9PiB7XG4gICAgICAgIGlmICh2aXNpdGVkLmhhcyhmb2xkZXJJZCkpIHJldHVybiAwOyAvLyDsiJztmZgg7LC47KGwIOuwqeyngFxuICAgICAgICB2aXNpdGVkLmFkZChmb2xkZXJJZCk7XG4gICAgICAgIFxuICAgICAgICBjb25zdCBmb2xkZXIgPSBhbGxGb2xkZXJzLmZpbmQoZiA9PiBmLmlkID09PSBmb2xkZXJJZCk7XG4gICAgICAgIGlmICghZm9sZGVyIHx8ICFmb2xkZXIucGFyZW50SWQpIHJldHVybiAwO1xuICAgICAgICBcbiAgICAgICAgcmV0dXJuIDEgKyBjYWxjdWxhdGVEZXB0aChmb2xkZXIucGFyZW50SWQsIHZpc2l0ZWQpO1xuICAgIH07XG4gICAgXG4gICAgLy8g66qo65OgIO2PtOuNlOulvCDrp7Xsl5Ag7LaU6rCAIChkZXB0aCDqs4TsgrAg7Y+s7ZWoKVxuICAgIGFsbEZvbGRlcnMuZm9yRWFjaChmb2xkZXIgPT4ge1xuICAgICAgICBjb25zdCBjYWxjdWxhdGVkRGVwdGggPSBjYWxjdWxhdGVEZXB0aChmb2xkZXIuaWQpO1xuICAgICAgICBpZiAoZGVwdGggPT09IHVuZGVmaW5lZCB8fCBjYWxjdWxhdGVkRGVwdGggPD0gZGVwdGgpIHtcbiAgICAgICAgICAgIGZvbGRlck1hcC5zZXQoZm9sZGVyLmlkLCB7XG4gICAgICAgICAgICAgICAgLi4uZm9sZGVyLFxuICAgICAgICAgICAgICAgIGRlcHRoOiBjYWxjdWxhdGVkRGVwdGgsXG4gICAgICAgICAgICAgICAgY2hpbGRyZW46IFtdLFxuICAgICAgICAgICAgICAgIHRlc3RDYXNlQ291bnQ6IDBcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgfSk7XG4gICAgXG4gICAgLy8g7Yq466asIOq1rOyhsCDsg53shLFcbiAgICBhbGxGb2xkZXJzLmZvckVhY2goZm9sZGVyID0+IHtcbiAgICAgICAgY29uc3QgY2FsY3VsYXRlZERlcHRoID0gY2FsY3VsYXRlRGVwdGgoZm9sZGVyLmlkKTtcbiAgICAgICAgaWYgKGRlcHRoID09PSB1bmRlZmluZWQgfHwgY2FsY3VsYXRlZERlcHRoIDw9IGRlcHRoKSB7XG4gICAgICAgICAgICBjb25zdCBmb2xkZXJUcmVlID0gZm9sZGVyTWFwLmdldChmb2xkZXIuaWQpITtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgaWYgKGZvbGRlci5wYXJlbnRJZCAmJiBmb2xkZXJNYXAuaGFzKGZvbGRlci5wYXJlbnRJZCkpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBwYXJlbnQgPSBmb2xkZXJNYXAuZ2V0KGZvbGRlci5wYXJlbnRJZCkhO1xuICAgICAgICAgICAgICAgIHBhcmVudC5jaGlsZHJlbiEucHVzaChmb2xkZXJUcmVlKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgcm9vdEZvbGRlcnMucHVzaChmb2xkZXJUcmVlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH0pO1xuICAgIFxuICAgIC8vIOqwgSDtj7TrjZTsnZgg7YWM7Iqk7Yq4IOy8gOydtOyKpCDqsJzsiJgg6rOE7IKwXG4gICAgZm9yIChjb25zdCBmb2xkZXJUcmVlIG9mIGZvbGRlck1hcC52YWx1ZXMoKSkge1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgY29uc3QgcGdDbGllbnQgPSBnZXRQZ0NsaWVudCgpO1xuICAgICAgICAgICAgaWYgKHBnQ2xpZW50KSB7XG4gICAgICAgICAgICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgcGdDbGllbnQucXVlcnkoYFxuICAgICAgICAgICAgICAgICAgICBTRUxFQ1QgQ09VTlQoKikgYXMgY291bnQgXG4gICAgICAgICAgICAgICAgICAgIEZST00gdHJlZV9ub2RlcyBcbiAgICAgICAgICAgICAgICAgICAgV0hFUkUgdHlwZSA9ICd0ZXN0Y2FzZScgQU5EIHBhcmVudF9pZCA9ICQxXG4gICAgICAgICAgICAgICAgYCwgW2ZvbGRlclRyZWUuaWRdKTtcbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICBmb2xkZXJUcmVlLnRlc3RDYXNlQ291bnQgPSBwYXJzZUludChyZXN1bHQucm93c1swXS5jb3VudCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKGDthYzsiqTtirgg7LyA7J207IqkIOqwnOyImCDqs4TsgrAg7Iuk7YyoICjtj7TrjZQgSUQ6ICR7Zm9sZGVyVHJlZS5pZH0pOmAsIGVycm9yKTtcbiAgICAgICAgICAgIGZvbGRlclRyZWUudGVzdENhc2VDb3VudCA9IDA7XG4gICAgICAgIH1cbiAgICB9XG4gICAgXG4gICAgcmV0dXJuIHJvb3RGb2xkZXJzLnNvcnQoKGEsIGIpID0+IGEub3JkZXJJbmRleCAtIGIub3JkZXJJbmRleCk7XG59ICJdLCJ2ZXJzaW9uIjozfQ==